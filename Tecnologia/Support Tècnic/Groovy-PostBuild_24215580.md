Suport Tècnic : Groovy PostBuild  

1.  [Suport Tècnic](index.md)
2.  [Suport Tècnic](13893782.md)
3.  [04 - Tècnica de sistemes + 24x7 + Padró](26313202.md)
4.  [Desplegaments](Desplegaments_26313538.md)
5.  [Documentació associada a la integració de Jenkins i Jira](22937719.md)

Suport Tècnic : Groovy PostBuild
================================

Created by David Tejada, last modified by Unknown User (otecobernal) on 09 August 2019

package jira.jenkins.aoc

def authString = "jenkins:jenkins\_aoc".bytes.encodeBase64().toString()

def passarIncidenciaResolta= { boolean rollback ->
	
	
	def comentari=""
	if (rollback) {
		comentari="El desplegament ha fet rollback automàticament"
	}
	else{
		comentari="El desplegament ha finalitzat correctament"
	}
	
	// S'ha de ficar el json de post
	
	/\*
	id -> 11
	
	\*/
	def jsonUpdate = """
        {
            "transition":{
                "id":"31"
            },
            "fields": {
                "resolution": {
                    "id": "10000"
                      }        
            },
            "update":{
                "comment":
                \[
                    {"add":
                        {"body": " $comentari"}
                    }
                \]
            }
        }
        """
	
	 return jsonUpdate

}

def post={ String url, String postContent ->
	
		def connection = url.toURL().openConnection()
		connection.addRequestProperty("Authorization", "Basic ${authString}")
		connection.addRequestProperty("Content-Type", "application/json; charset=UTF-8")
	
	
		connection.setRequestMethod("POST")
		connection.doOutput = true
	
		connection.outputStream.withWriter('UTF-8',{
			it.write(postContent)
			it.flush()
		})
	
		connection.connect()
	
		try {
			connection.content.text
		} catch (IOException e) {
			try {
				((HttpURLConnection)connection).errorStream.text
			} catch (Exception ignored) {
				throw e
			}
		}
	}



// Codi que s'haurà d'executar.

	// Codi per executar a Jenkins, recuperant l'ID a través del fitxer
	   def base=manager.envVars\["WORKSPACE"\]
	def file = new File(base+"/variables.txt")
	def ticket = file.text
	def urlService = "https://contacte.aoc.cat/rest/api/2/issue/${ticket}/transitions"
	def fileLastCommit = new File(base+"/lastCommit.txt")
	def fileCommitActual = new File(base+"/commitActual.txt")

  def rollback=true
if(manager.getResult() == 'SUCCESS'){
	
	rollback=false	
	fileLastCommit.text = fileCommitActual.text
	println(post(urlService, passarIncidenciaResolta(rollback)))
        manager.addShortText("DEPLOYED!! SUCCESFULLY")
	
	}
else {
	// Mirem si ha fet rollback o és que no hi havia desplegaments pendents.
	// Si no hi havia desplegaments pendents el contingut dels fitxers lastCommit.txt i commitActual.txt haurien de ser iguals.	

	
	if (fileLastCommit.text == fileCommitActual.text) {
			manager.addShortText("NO CHANGES")
                        manager.build.@result = hudson.model.Result.SUCCESS
		}
	else {
			manager.addShortText("DEPLOY FAILED")
									
			println(post(urlService, passarIncidenciaResolta(rollback)))
		}
	
	
	}

  

  

Document generated by Confluence on 02 June 2025 11:17

[Atlassian](http://www.atlassian.com/)