Seguretat : Configuració SSL per TLS v1.2 i v1.3 (2024 v1.0)  

1.  [Seguretat](index.md)
2.  [Pàgina d'inici de la Unitat de Seguretat](15368362.md)
3.  [Projectes Unitat de Seguretat](Projectes-Unitat-de-Seguretat_41517821.md)
4.  [Securització de frontals](41519957.md)

Seguretat : Configuració SSL per TLS v1.2 i v1.3 (2024 v1.0)
============================================================

Created by Rafael Carrasco, last modified on 08 mayo 2025

/\*<!\[CDATA\[\*/ div.rbtoc1749247732362 {padding: 0px;} div.rbtoc1749247732362 ul {list-style: disc;margin-left: 0px;} div.rbtoc1749247732362 li {margin-left: 0px;padding-left: 0px;} /\*\]\]>\*/

*   [Tecnologia requerida](#ConfiguracióSSLperTLSv1.2iv1.3\(2024v1.0\)-Tecnologiarequerida)
*   [Opcions proposades i empleabilitat](#ConfiguracióSSLperTLSv1.2iv1.3\(2024v1.0\)-Opcionsproposadesiempleabilitat)
*   [Taula de compatibilitat](#ConfiguracióSSLperTLSv1.2iv1.3\(2024v1.0\)-Tauladecompatibilitat)
*   [Proposta de configuració per la versió General](#ConfiguracióSSLperTLSv1.2iv1.3\(2024v1.0\)-PropostadeconfiguracióperlaversióGeneral)
*   [Proposta de configuració per la versió Moderna](#ConfiguracióSSLperTLSv1.2iv1.3\(2024v1.0\)-PropostadeconfiguracióperlaversióModerna)
*   [Capçaleres adicionals de securització per qualsevol de les propostes anteriors](#ConfiguracióSSLperTLSv1.2iv1.3\(2024v1.0\)-Capçaleresadicionalsdesecuritzacióperqualsevoldelespropostesanteriors)
*   [Altres consideracions basades en implementacions ja fetes](#ConfiguracióSSLperTLSv1.2iv1.3\(2024v1.0\)-Altresconsideracionsbasadesenimplementacionsjafetes)
*   [Eines de validació](#ConfiguracióSSLperTLSv1.2iv1.3\(2024v1.0\)-Einesdevalidació)

Tecnologia requerida
---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------

Configuració SSL mínima per TLS v1.2 i TLS v1.3 per cada VirualHost, amb les següents tecnologies:

*   Apache 2.4.41
*   OpenSSL 1.1.1k

Opcions proposades i empleabilitat
----------------------------------

Tenim 2 propostes:

*   la primera anomenada General amb suport mínim TLS v1.2: recomanada per Servidors d'ús general amb una varietat de clients, recomanats per a gairebé tots els sistemes.
*   i altre més estricte anomenada Moderna amb suport mínim TLS v1.3: recomanada per Serveis amb clients que admeten TLS 1.3 i que no necessiten compatibilitat amb versions anteriors.

Taula de compatibilitat
-----------------------

Aquesta taula de compatibilitat mostra la compatibilitat de la proposta General i la Moderna:

Sistema

Versió General

Versió Moderna

TLS mínim

v1.2

v1.3

Firefox

27

63

Android

4.4.2

10.0

Chrome

31

70

Edge

  

75

IE

11

\-

Windows

7

\-

Java

8u31

11

OpenSSL

1.0.1

1.1.1

Opera

20

57

Safari

9

12.1

Proposta de configuració per la versió General
----------------------------------------------

>     <VirtualHost *:80>
>         RewriteEngine On
>         RewriteCond %{REQUEST_URI} !^/\.well\-known/acme\-challenge/
>         RewriteRule ^(.*)$ https://%{HTTP_HOST}$1 [R=301,L]
>     </VirtualHost>
>     
>     <VirtualHost *:443>
>         SSLEngine on
>     
>         # curl https://ssl-config.mozilla.org/ffdhe2048.txt >> /path/to/signed_cert_and_intermediate_certs_and_dhparams
>         SSLCertificateFile      /path/to/signed_cert_and_intermediate_certs_and_dhparams
>         SSLCertificateKeyFile   /path/to/private_key
>     
>         # enable HTTP/2, if available
>         Protocols h2 http/1.1
>     
>         # HTTP Strict Transport Security (mod_headers is required) (63072000 seconds)
>         Header always set Strict-Transport-Security "max-age=63072000"
>     </VirtualHost>
>     
>     SSLProtocol             all -SSLv3 -TLSv1 -TLSv1.1
>     SSLCipherSuite          ECDHE-ECDSA-AES128-GCM-SHA256:ECDHE-RSA-AES128-GCM-SHA256:ECDHE-ECDSA-AES256-GCM-SHA384:ECDHE-RSA-AES256-GCM-SHA384:ECDHE-ECDSA-CHACHA20-POLY1305:ECDHE-RSA-CHACHA20-POLY1305:DHE-RSA-AES128-GCM-SHA256:DHE-RSA-AES256-GCM-SHA384:DHE-RSA-CHACHA20-POLY1305
>     SSLHonorCipherOrder     off
>     SSLSessionTickets       off
>     
>     SSLUseStapling On
>     SSLStaplingCache "shmcb:logs/ssl_stapling(32768)"

Proposta de configuració per la versió Moderna
----------------------------------------------

>     <VirtualHost *:80>
>         RewriteEngine On
>         RewriteCond %{REQUEST_URI} !^/\.well\-known/acme\-challenge/
>         RewriteRule ^(.*)$ https://%{HTTP_HOST}$1 [R=301,L]
>     </VirtualHost>
>     
>     <VirtualHost *:443>
>         SSLEngine on
>         SSLCertificateFile      /path/to/signed_cert_and_intermediate_certs
>         SSLCertificateKeyFile   /path/to/private_key
>     
>         # enable HTTP/2, if available
>         Protocols h2 http/1.1
>     
>         # HTTP Strict Transport Security (mod_headers is required) (63072000 seconds)
>         Header always set Strict-Transport-Security "max-age=63072000"
>     </VirtualHost>
>     
>     SSLProtocol             all -SSLv3 -TLSv1 -TLSv1.1 -TLSv1.2
>     SSLHonorCipherOrder     off
>     SSLSessionTickets       off
>     
>     SSLUseStapling On
>     SSLStaplingCache "shmcb:logs/ssl_stapling(32768)"

Capçaleres adicionals de securització per qualsevol de les propostes anteriors
------------------------------------------------------------------------------

Capçaleres de securització que poden estar a un fitxer al NFS que es pot cridar mitjançant un Include o seguidament a les directives anteriors:

> <IfModule headers\_module>  
>   Header always append X-Frame-Options SAMEORIGIN  
>   Header always set X-Xss-Protection "1; mode=block"  
>   Header always set Strict-Transport-Security "max-age=63072000"  
>   Header always set X-Content-Type-Options "nosniff"  
>   Header always set Referrer-Policy "no-referrer-when-downgrade"  
>   Header set Access-Control-Allow-Origin "CHANGE-ME-WEBSITE-NAME-HERE"  
> </IfModule>  
>   
> <IfModule mod\_headers.c>  
>   Header always set Permissions-Policy "geolocation=(self),midi=(self),sync-xhr=(self),microphone=(self),camera=(self),magnetometer=(self),gyroscope=(self),fullscreen=(self),payment=(self)"  
>   Header always set Content-Security-Policy "default-src 'self' \*.aoc.cat \*.google.com"  
>   Header set X-Permitted-Cross-Domain-Policies "none"  
>   Header edit Set-Cookie ^(.\*)$ "$1;HttpOnly;Secure;SameSite=Strict"  
> </IfModule>  
>   
> <IfModule reqtimeout\_module>  
>   RequestReadTimeout header=10,MinRate=500 body=60,MinRate=500  
> </IfModule>  
>   
> <IfModule headers\_module>  
>   Header unset X-Powered-By  
> </IfModule>
> 
> RewriteEngine on  
> RewriteCond %{REQUEST\_METHOD} ^(TRACE|TRACK|PUT|PATCH|DELETE|OPTIONS|HEAD)  
> RewriteRule .\* - \[L,R=405\]

*   Per OCSP Stapling, dintre de les directives de VirtualHost:

> SSLUseStapling on  
> SSLStaplingResponderTimeout 5  
> SSLStaplingReturnResponderErrors off
> SSLStaplingResponseMaxAge 900

I fora de les directives de VirtualHost (al fitxer httpd.conf) per OCSP Stapling:

> <IfModule mod\_ssl.c>  
>   SSLStaplingCache "shmcb:logs/stapling-cache(150000)"  
> </IfModule>

*   Altres millores com l'ocultació de la versió d'Apache a respostes d'error (incloent també capçaleres), no publicar versionat de mòduls i plugins i Sistema Operatiu, i el comportament a peticions de TRACE si tenim _mod\_proxy_ habilitat:

> ServerSignature Off
> ServerTokens Prod
> Header unset Server  
> TraceEnable Off

*   Per configuracions DNS CAA, cal afegir un registre de tipus CAA al DNS del domini a protegir per indicar les CA's permeses per emetre certificats SSL pel domini, deixem proposta d'exemple:

tag

value

issue

sectigo.com, globalsign.com, digicert.com, entrust.net, letsencrypt.org, amazon.com

iodef

mailto:certificats@aoc.cat

\*NOTA: Per mitigar el posible risc de que la zona DNS pugui veure's compromesa per un atacant i modificar els registres CAA, la recomanació passa per fer servir DNSSEC.

Altres consideracions basades en implementacions ja fetes
---------------------------------------------------------

 **![(advertencia)](images/icons/emoticons/warning.svg) IMPORTANT**: Deixem algunes consideracions per que depèn del servei que es tracti caldrà revisar algunes configuracions més a fons, per exemple:

*   al VALID Aïllat (Mediacloud) i al VALID DR (Nexica) tenim aplicada la configuració de la capçalera Set-Cookie amb l'argument SameSite a valor de "None", en comptes de "Strict" (SIS-3667 i SIS-4139). Es poden donar casos que ens pugui interessar habilitar la crida des de un altre domini, com els casos ente VALID i IdCatMobil (SIS-5129) que s'ha aplicat un valor de SameSite a "Lax" (poden ser None, Lax o Strict, al final hi ha un enllaç amb la documentació del site _developer mozilla_).
*   seria bo deixar el mínims mètodes possibles habilitats, per exemple la majora de serveis necessiten els GET i POST, però no cal que tinguin els de TRACE, TRACK, PUT, PATCH, DELETE, OPTIONS, i HEAD, caldrà doncs potser habilitar-ho per contexte (SIS-1842, SIS-1941 o SIS-3300). Els serveis amb API RESTful fan servir mètodes PUT i DELETE. (Més informació [https://owasp.org/www-project-web-security-testing-guide/latest/4-Web\_Application\_Security\_Testing/02-Configuration\_and\_Deployment\_Management\_Testing/06-Test\_HTTP\_Methods](https://owasp.org/www-project-web-security-testing-guide/latest/4-Web_Application_Security_Testing/02-Configuration_and_Deployment_Management_Testing/06-Test_HTTP_Methods))
*   han sorgit varies tasques posteriors de _fine tuning_ un cop aplicada la configuració per CSP Content Security Policy ja que segons quins recursos externs necessitin les aplicacions caldrà fer una sèrie d'ajustaments per configurar explícitament lo que cada servei requereixi i no més, en un exercici de restricció total inicial. En cas de que la Unitat de Projectes ens facilitin la tasca per identificar tots els recursos que li calen a les aplicacions, es podran configurar prèviament, si no és així doncs haurà de fer-se una sèrie d'aproximacions als entorns de Desenvolupament i Preproducció.  
    Una configuració de referència que s'ha treballat a tots els entorns i aplicat per CSP (SIS-5583) és la següent:
    
    > Header always set Content-Security-Policy "default-src 'self' 'unsafe-inline' 'unsafe-eval' pl6.eacat.cat [www.google.com](http://www.google.com) www.aoc.cat \*.[googleapis.com](http://googleapis.com) \*.[gstatic.com](http://gstatic.com) [www.googletagmanager.com](http://www.googletagmanager.com) [www.google-analytics.com](http://www.google-analytics.com); script-src 'self' 'unsafe-inline' 'unsafe-eval' pl6.eacat.cat [www.google.com](http://www.google.com) www.aoc.cat \*.[googleapis.com](http://googleapis.com) \*.[gstatic.com](http://gstatic.com) [www.googletagmanager.com](http://www.googletagmanager.com) [www.google-analytics.com](http://www.google-analytics.com); connect-src 'self' signador.aoc.cat \*.[google-analytics.com](http://google-analytics.com) \*.[amazonaws.com](http://amazonaws.com); frame-src 'self' signador.aoc.cat copia.aoc.cat"
    

*   com a mesure de protecció CORS, hem afegit la directiva per capçalera Access-Control-Allow-Origin, un exemple de configuració el tenim al tiquet SIS-5583 i seria així la seva aplicació:  
    
    > Header set Access-Control-Allow-Origin "[https://pl6.eacat.cat](https://pl6.eacat.cat)"
    

Eines de validació
------------------

![(info.)](images/icons/emoticons/information.svg) Eines per poder validar configuracions:

*   [https://www.ssllabs.com/ssltest/](https://www.ssllabs.com/ssltest/)
*   [https://ssl-config.mozilla.org/](https://ssl-config.mozilla.org/)
*   [https://securityheaders.com/](https://securityheaders.com/)
*   [https://report-uri.com/home/generate](https://report-uri.com/home/generate)
*   [https://developer.mozilla.org/en-US/docs/Web/HTTP/Headers/Set-Cookie](https://developer.mozilla.org/en-US/docs/Web/HTTP/Headers/Set-Cookie)
*   [https://developer.mozilla.org/en-US/docs/Web/HTTP/Headers](https://developer.mozilla.org/en-US/docs/Web/HTTP/Headers)
*   [https://www.nslookup.io/domains/aoc.cat/dns-records/caa/](https://www.nslookup.io/domains/aoc.cat/dns-records/caa/)
*   OpenSSL ( "_openssl s\_client -connect FQDN/IP:443_" )
*   SSLScan i TestSSL (on Kali Linux)
*   Nmap scripts "ssl-enum-ciphers" i "http-methods"

Document generated by Confluence on 07 junio 2025 00:08

[Atlassian](http://www.atlassian.com/)