Suport Tècnic : VO - Auditoria- Extracció dades per auditoria  

1.  [Suport Tècnic](index.html)
2.  [Suport Tècnic](13893782.html)
3.  [02 - FAQ's serveis](26313393.html)
4.  [FAQ's VO](28705575.html)

Suport Tècnic : VO - Auditoria- Extracció dades per auditoria
=============================================================

Created by Unknown User (otecagonzalez), last modified by Cristian Morales on 20 May 2025

**Introducció**
---------------

Anualment o periòdicament ens obriran un  tiquet JIRA per fer una extracció dels consums que s'han realitzat durant un temps determinat. 

En la faq detallem els punts importants per extreure correctament aquestes dades. 

Es pot consultar amb les dades del titular els consums historificats

Si són consums historificats, podem treure la info de la taula de AUDITORIES:

select \* from PCI\_MTI\_AUDIT 

![](attachments/41520018/128647706.png)

  

**Què cal tindre en compte?**
-----------------------------

1.  Assegurar-nos de quins ENS volen l'extracció dels consums.
2.  Assegurar-nos de quins productes volen que fem l'extracció.
3.  No podem obtenir el camp "titular\_doc" de peticions menys antigues a 2 mesos (Explicació més endavant de la FAQ).
4.  En el SIRI es purguen les dades, si les dades són més  d'un any es possible que no siguin consultables (Caldrà validar-ho). 

  

**Font de les dades**
---------------------

Per obtenir aquestes dades explotarem la **base de dades del SIRI** (_aoc\_pci\_siri\_registre_) i la de **PCI30IOP** (_pci\_mti\_audit_)

Els camps que es necessiten per aquestes extraccions són: 

1.  CODI\_ORGANISME
2.  CODI\_PRODUCTE
3.  CODI\_MODALITAT
4.  CODI\_FINALITAT
5.  FUNCIONARI\_NIF
6.  NUMERO\_EXPEDIENT
7.  DATA\_ENTRADA
8.  CONSENTIMENT
9.  TITULAR\_DOC 

  

### Consultes SQL per l'extracció

**Consulta per extracció de peticions MÉS antigues a 2 mesos** Expand source

\--Consulta per l'extracció de totes les dades
 SELECT aa.id\_peticio,
        aa.id\_solicitud,
        aa.codi\_requeridor,
        aa.codi\_producte,
        aa.codi\_modalitat,
        aa.codi\_finalitat,
        aa.expedient,
        aa.data\_recepcio,
        aa.consentiment,
        aa.funcionari\_nif,
        aa.titular\_doc
 FROM PCI30IOP.PCI\_MTI\_AUDIT aa
 WHERE aa.data\_recepcio >= to\_date('01/01/2020','dd/mm/yyyy')
 AND   aa.data\_recepcio <= to\_date('30/01/2020','dd/mm/yyyy')
 AND   aa.codi\_producte = 'XXXXX'
 AND   aa.codi\_requeridor = 'XXXXX';

**Consulta per extracció de peticions MENYS antigues a 2 mesos** Expand source

\-- En aquest cas no podem obtenir el camp TITULAR\_DOC directe d'un camp de BBDD (Veure informació següent "Extracció camp TITULAR\_DOC" per extreure'l)
   SELECT siri.id\_peticio, 
       siri.codi\_organisme,
       siri.codi\_producte,
       siri.codi\_modalitat,
       siri.codi\_finalitat,
       siri.funcionari\_nif,
       siri.numero\_expedient,
       siri.data\_entrada,
       siri.autoritzada
  FROM siri.aoc\_pci\_siri\_registre siri
 WHERE siri.data\_entrada >= to\_date('01/01/2020', 'dd/mm/yyyy')
   AND siri.data\_entrada <= to\_date('30/01/2020', 'dd/mm/yyyy')
   AND siri.codi\_producte = 'PADRO'
   AND siri.codi\_organisme = '';
 

Extracció camp TITULAR\_DOC

TITULAR\_DOC, és un camp de la taula "_pci\_mti\_audit_" que guarda el document del titular consultat. 

Aquest no el podrem obtenir sempre. Per tant, hi hauran registres que no estarà informat. 

**Perquè no es desa?**

Només es guarda la dada del titular quan aquesta dada ve informada en el bloc de dades genèriques de la missatgeria PCI, dins del bloc no obligatori "Titular". Un cop son auditades les peticions i passen a la taula "_Audit_" el sistema agafa la dada del bloc de dades genèriques i no del de dades especifiques, que és on sempre surt informat el document. 

  

**Alternatives per obtenir la dada TITULAR\_DOC**

Si les peticions NO són més antigues a 2 mesos:

Cercar-lo en **l’esquema PCI30IOP** (taula **_pci\_mti\_xml_**) En aquesta taula es desa el XML de petició i dins d’aquest XML podem trobar el document del titular consultat.

*   Fer aquest procediment manualment per un número molt elevat de peticions, pot comportar a un temps molt elevat en la tasca.
*   Si la petició és més antiga de 2 mesos en aquesta taula ja no existeix (purga).
    
    **Consulta SQL** Expand source
    
    SELECT pp.id\_peticio, xx.xml, xx.tipus
      FROM pci30iop.pci\_mti\_peticio   pp,
           pci30iop.pci\_mti\_solicitud ss,
           pci\_mti\_xml                xx
     WHERE ss.id\_peticio = pp.id
       AND xx.id\_peticio = pp.id
       AND xx.id\_solicitud = ss.id
       AND xx.tipus = 1
       AND pp.id\_peticio = 'XXXXXXXXXXXXXXXX'
       AND pp.codi\_producte like ('XXXXXXXX');
    
    ![](attachments/41520018/41520039.png)
    

  

Per consums del PADRO o IDESCAT

Es pot cercar en **l’esquema MCPCIIOP** (taula **aoc\_mcpadro\_registre**). En aquesta taula trobem el camp “DOCUMENTACIO” (document del titular consultat).

*   No es pot relacionar per ID\_PETICIO, s’ha de cercar per data i hora
*   Fer aquest procediment manualment per un número molt elevat de peticions, pot comportar a un temps molt elevat en la tasca.

  

**\*Aquest cas s'ha tractat en el tiquet intern  [ST-10996](https://contacte.aoc.cat/browse/ST-10996?src=confmacro) - Data cannot be retrieved due to an unexpected error.**

**Extracció**
-------------

Les dades que obtinguem a través de les consultes SQL les desarem en un xml i les passarem en el tiquet JIRA corresponent. 

Exemple de Extracció:   
[VO\_Audit.xlsx](attachments/41520018/41520049.xlsx) → _Aquesta extracció va ser per un ENS i productes en concret. També ens van demanar que fossin unes quantes peticions de cada producte i no tots els de un any o mes... Per això es **important abans saber que necessiten.**_ 

Attachments:
------------

![](images/icons/bullet_blue.gif) [image2020-11-27\_11-13-3.png](attachments/41520018/41520039.png) (image/png)  
![](images/icons/bullet_blue.gif) [VO\_Audit.xlsx](attachments/41520018/41520049.xlsx) (application/vnd.openxmlformats-officedocument.spreadsheetml.sheet)  
![](images/icons/bullet_blue.gif) [image2025-5-20\_9-0-50.png](attachments/41520018/128647706.png) (image/png)  

Document generated by Confluence on 02 June 2025 11:03

[Atlassian](http://www.atlassian.com/)