Suport Tècnic : Idescat - Importació del Registre de població  

1.  [Suport Tècnic](index.md)
2.  [Suport Tècnic](13893782.md)
3.  [01 - Gestió Operativa](26313391.md)
4.  [Tasques complementàries](26313409.md)

Suport Tècnic : Idescat - Importació del Registre de població
=============================================================

Created by Maria Dolors Alvarez, last modified by Cristian Morales on 05 February 2025

Aquest procediment determina el diagrama de flux i les fases a seguir per realitzar la càrrega de les dades de Registre de Població. Aquesta tasca es gestiona des de Suport Tècnic i depenem de quan rebem les indicacions per part d’Idescat.

A través d’aquests registres de població es poden consultar les dades que hi ha a l’empadronament en cas que estigui el padró del municipi caigut o bé, aquell ajuntament concret no disposi del servei del Padró. 

Cada quatre mesos es realitza la importació però Idescat depèn de l’enviament dels registres de població per part de l’INE.

![(info)](images/icons/emoticons/information.svg) TODO: Sembla que des del 3r trimestre de 2022 ja no envien una clau privada sinó que xifren directament els arxius amb una contrasenya que envien al propi correu. Potser seria necessari actualitzar el procediment!  [ST-17742](https://contacte.aoc.cat/browse/ST-17742?src=confmacro) - Data cannot be retrieved due to an unexpected error.

Conveni amb IDESCAT

L’Idescat en relació amb les dades del Registre de Població de Catalunya, assumeix  
els següents compromisos:

1.  Garantir la disponibilitat de les dades del Registre de Població de Catalunya i  
    facilitar-les al Consorci AOC d’acord amb el detall de l’Annex I d’aquest conveni.
2.  Trametre al Consorci AOC els Fitxers del Registre de Població de Catalunya  
    d’acord amb el calendari següent:  
    • Fitxers a 1 de gener: es trametran el mes de febrer  
    • Fitxers a 1 d’abril: es trametran el mes de maig  
    • Fitxers a 1 de juliol: es trametran el mes de setembre  
    • Fitxers a 1 d’octubre: es trametran el mes de novembre 

Si per dificultats tècniques no es poden trametre alguns dels fitxers esmentats,  
l’Idescat ho posarà en coneixement del Consorci AOC i comunicarà la previsió  
de la tramesa de les dades.

[ST-23084](https://contacte.aoc.cat/browse/ST-23084?src=confmacro) - Data cannot be retrieved due to an unexpected error.  
  

Mail de Gemma al SIAD, amb el resum i l'informació:

[![](download/resources/com.atlassian.confluence.plugins.confluence-view-file-macro:view-file-macro-resources/images/placeholder-medium-file.png)Aclariment càrrega dades IDESCAT.msg](/download/attachments/41521832/Aclariment%20c%C3%A0rrega%20dades%20IDESCAT.msg?version=1&modificationDate=1717569426577&api=v2)

Pas 1: Fases de la recepció del Registre de població
----------------------------------------------------

*   Avís de Recepció dels registres de població
    1.  Serra Cursach, Maria Francisca <[xserra@idescat.cat](mailto:xserra@idescat.cat)\> ens enviarà la clau privada per correu electrònic i ens avisa que ja estan disponibles a SFTP els 5 fitxers de **_Registre de la població_**.

                 Exemple de correu:

![](attachments/41521832/41522441.png)

  

*   En cas de no rebre la contrasenya
    
    A posteriori, s’ha de trucar a **Pat Gracia (Gracia Blanco, Patricia <pgracia@idescat.cat>)**, per tal d’obtenir la contrasenya per desxifrar els fitxers deixats en el SFTP. Dades de contacte:
    
    *   **93.557.30.00 (**general)
    *   **93.557.30.29** (directe)
    *   Excepcionalment (temps de confinament) el telèfon és: **636 29 76 22**
    
*   Es descarrega els fitxers de l’SFTP, i un cop descarregats els fitxers s’ha d’avisar a Pat Gracia/ Miracle  de què els poden treure de l’SFTP.

![](attachments/41521832/64980486.png)

*   Creació del tiquet a Sistemes per tal de poder realitzar la importació (a nivell d’espai de Bases de Dades)
    *   Exemple de tiquet:
        *   Se sol·licita espai per tal de poder realitzar la importació a l’esquema de Idescat\_Historic

(Establir un dia de la importació) i Tancament

Pas 2: Procediment
------------------

Actualment, IDESCAT ens deixa les dades en un FTP i ens avisa quan estan disponibles per descarregar-les. Les dades d’accés es troben al KeePass de Tecnologia.

![](attachments/41521832/64980330.png)

Connectar-nos des de el PC del AOC:

![](attachments/41521832/100008480.png)

  

En el cas que la mida dels fitxers sigui > 2GB s'ha d'enviar correu informatiu a  : Toni Vierge <tvierge@aoc.cat>; Sergio Figueras <sfigueras@aoc.cat> i posar en CC a Sistemes AOC <Sistemes@aoc.cat>; SuportTecnicD <suporttecnic@aoc.cat>:

Missatge correu

Voldria indicar-vos que disposem del registre de població del <primer trimestre del 2022> de idescat històric, amb un conjunt de fitxers de mida <XXX>, realitzarem avui la còpia d'aquestes dades al sistema de carpetes d'ENDRECA.

Salutacions cordials.

Comentat en:  [SIS-4661](https://contacte.aoc.cat/browse/SIS-4661?src=confmacro) - Data cannot be retrieved due to an unexpected error.

  

Per tal de fer la importació, és necessari desxifrar els diferents fitxers. Amb els programes següents: 

  

Kleopatra ![](attachments/41521832/41522444.png) i GPA ![](attachments/41521832/41522442.png)

(S’adjunta el document relacionat amb aquest procediment de desxifratge del Registre de la població (que des de l’Idescat ens van enviar): (Sharepoint) Tecnologia - SUPORT\_TECNIC\\SERVEIS\\PADRO\\IDESCAT\\**Manual de desxifratge de fitxers digitals de l'Idescat.pdf**)

  

Es fa comprovació de què les dades siguin amb el mateix format que les anteriors, fent una cerca concreta.

Es deixen a (Sharepoint) Tecnologia - SUPORT\_TECNIC\\SERVEIS\\PADRO\\IDESCAT

**Nota1:** Els diferents .txt s’han de renombrar a .dat i els comprimim en .zip amb el nom del mes que toca. Per exemple, segon trimestre 2022 → **20220401.zip**

**Nota2**: es deixa els fitxers del més corresponent:

Exemple: (Sharepoint) Tecnologia - SUPORT\_TECNIC\\SERVEIS\\PADRO\\IDESCAT\\Dades\_2021\\Idescat\_Abril\_2021\\Dades

### 2.1    Pujar les dades al servidor de PRO

![](attachments/41521832/64981693.png)

![](attachments/41521832/64981694.png)

_Nota: Comprovar l’espai de disc abans de pujar i descomprimir. (comanda df -h)_

_![](attachments/41521832/64980336.png)_

 S’ha de pujar el ZIP al directori (1):

/apps/aoc/IOP/prjIdescatImport/dades/

**_Per comandes, descomprimim el .zip en la carpeta que hem generat:_**

**_Comanda: unzip 20221101.zip -d /apps/aoc/IOP/prjIdescatImport/dades_**

  

![](attachments/41521832/81854690.png)

Al fer el unxzip, es generarà una carpeta amb el format següent: l’any+mes+dia de la data de l’extracció. Per exemple, per la importació de les dades de l’1 de Juliol del 2020 es generarà la carpeta (2):

/apps/aoc/IOP/prjIdescatImport/dades/**_20200701_**

**_![](attachments/41521832/64980458.png)_**

  

### 2.2    Comprovar espai de BBDD

S’ha d’obrir un tiquet a Sistemes per tal que es verifiqui si hi ha suficient espai per a BBDD abans de començar la importació.

Un tiquet exemple, és:

[https://contacte.aoc.cat/browse/SIS-4447](https://contacte.aoc.cat/browse/SIS-4447)

### 2.3    Iniciar la importació

[http://10.120.1.65:8080/aoc-dades-idescat/inici.do](http://10.120.1.65:8080/aoc-dades-idescat/inici.do)

![](attachments/41521832/64980382.png)

S’ha d’indicar la carpeta on es troben les dades a carregar (es a dir la ruta de la carpeta amb els fitxers descomprimits): /apps/aoc/IOP/prjIdescatImport/dades/20220101

![](attachments/41521832/64980461.png)

També hem d'informar la data (és la que surt en els fitxers)

![](attachments/41521832/64980518.png)

Ha de sortir:

![](attachments/41521832/64980455.png)

Ruta on es deixen els fitxers:

/apps/aoc/IOP/prjIdescatImport/dades/**20200701**

  

**Nota:** El fitxer de trams ja està al servidor. Mentre no n’hi hagi cap de nou, no cal indicar res, ja agafa per defecte el que tenim al servidor.

**Nota:** Si no apareix **Importació llançada**!, pot ser que estigui aturada l’aplicació i es s'ha de fer un redeploy, perquè estigui operativa de nou l’aplicació.

funcionament

  

El que fa la web és carregar a memòria el fitxer muntant un índex estil "municipi -> carrer -> rang de nums ==> CP"

hi ha els fitxers que envia Idescat, per una banda, i després el de trams de carrer del INE que usem per a resoldre a quin CP cau una adreça X

  

  

Redeploy

[PCI3 - FRONT8 - TOMCAT8 - Revisió](41521119.md)

IDESCAT el tenim en el tomcat8 → [http://10.120.1.65:8080/probe/](http://10.120.1.65:8080/probe/)

![](attachments/41521832/64980441.png)

  

  

Durant el procés de càrrega, el que apareix és el següent (Consultar procés d’importació), però no és determinant:

S’ha de mirar els logs dels nodes per veure si està fent la càrrega → [http://192.168.166.136:8080/ServeisIntegracio/mapaServeis](http://192.168.166.136:8080/ServeisIntegracio/mapaServeis)

![](attachments/41521832/64980442.png)

Es veurà el següent:

![](attachments/41521832/41522445.png)

  

![](attachments/41521832/41522446.png)

Si no es troba els logs propis de l'aplicació, es mira a **catalina.out: /apps/tomcat8/logs**

![](attachments/41521832/64980443.png)

![](attachments/41521832/61931722.png)

Una vegada confirmat, validem que s'ha generat la taula correcta de la importació a BBDD, en els logs del Catalina veiem que el nom de les taules tenen el format: AOC\_IDESCAT\_2022M02 (en la carrega que s'ha fet per la captura)

![](attachments/41521832/64980462.png)

Validem per BBDD que s'ha generat la taula  "AOC\_IDESCAT\_HAB\_XXXXXX" on estaran les dades de l'anterior exportació i s'ha generat insert amb el "TABLESPACE\_DESTI" (ordenem per data\_vigencia): 

select \* from aoc\_idescat\_importacio where rownum = 1 order by data\_vigencia desc

  

Això pot trigar una estona

  

![](attachments/41521832/64980464.png)

  

### Validem que en SQL de la taula AOC\_IDESCAT\_MOV\_HABITANT estigui el tablespace:

![](attachments/41521832/64980521.png)

I que en els detalls de les taules AOC\_IDESCAT\_MOV\_HABITANT i la nova generada amb les dades de l'anterior importació (en aquest cas per exemple AOC\_IDESCAT\_HAB\_2022M04) el LAST\_DDL\_TIME es la data de quan es fa la importació:

![](attachments/41521832/77824427.png)

  

![](attachments/41521832/77824428.png)

  

També validar que els registres són majors a l'anterior:

![](attachments/41521832/100009527.png)

Veiem que n'hi ha menys en l'última, es xq per un error no es va carregar 1 dels fitxers...

Validar que es genera el CPOS

Hem de validar que es genera el CPOS correctament....

SELECT COUNT(CPOS.ID) 
FROM IDESCAT\_HISTORIC.AOC\_IDESCAT\_MOV\_HABITANT CPOS
WHERE CPOS.CPOS IS NULL;

  

Si surt a null o amb 4 dígits en comptes de 5... alguna cosa no ha funcionat correctament.

![](attachments/41521832/100009880.png)

  

[ST-21995](https://contacte.aoc.cat/browse/ST-21995?src=confmacro) - Data cannot be retrieved due to an unexpected error.

Revisar

Revisar el document, i veure si complim com els anteriors, que cada fila tenim 555 caràcters i que finalitza amb CR (\\r) i LF (\\n):

En el cas següent:  [ST-22951](https://contacte.aoc.cat/browse/ST-22951?src=confmacro) - Data cannot be retrieved due to an unexpected error.  [https://geekland.eu/uso-del-comando-sed-en-linux-y-unix-con-ejemplos/](https://geekland.eu/uso-del-comando-sed-en-linux-y-unix-con-ejemplos/)

sed 's/ .$//' ConveniAOC\_PROVA.dat > ConveniAOC\_PROVA.dat.modif 
sed 's/$/\\r/' ConveniAOC\_PROVA.dat > ConveniAOC\_PROVA.dat.modif

Trèiem un espai en blanc, però ens elimina també el CR (\\r), per tant, l'hem d'afegir a posterior i validar que ara ho tenim tot amb 555 caràcters en comptes de 556...

  

  

### 2.4    Comprovar resultat de la importació

  

Consultar a l’Administració i mirar Producte Padró (es comprova que els monitors estiguin bé, corresponen modalitat Resident)

![](attachments/41521832/64980447.png)

  

Exemple de problemes

JIRA: [SIS-538](https://contacte.aoc.cat/browse/SIS-538)

  

JIRA:  [ST-21995](https://contacte.aoc.cat/browse/ST-21995?src=confmacro) - Data cannot be retrieved due to an unexpected error.

  

Problemes amb els fitxers que ens passen que tenen un espai de més...

Es fa la següent acció per treure l'espai (això validar abans de fer es):

sed 's/.$/\\r/' AOC\_p08mres\_20240101.dat > AOC\_p08mres\_20240101.dat.modif
sed 's/.$/\\r/' AOC\_p17\_20240101.dat > AOC\_p17\_20240101.dat.modif
sed 's/.$/\\r/' AOC\_p25\_20240101.dat > AOC\_p25\_20240101.dat.modif
sed 's/.$/\\r/' AOC\_p43\_20240101.dat > AOC\_p43\_20240101.dat.modif
sed 's/.$/\\r/' AOC\_p08019\_20240101.dat > AOC\_p08019\_20240101.dat.modif

Lo que he fet és igualar-los modificant la comanda "sed" per  a que en contes de menjar-se el darrer espai el canvii per un caràcter "\\n"

  

sed 's/.$/\\r/' AOC\_p<nom fitxer>.dat > AOC\_p<nom fitxer>.dat.modif 

Ara en principi les linies sí que tenen el mateix nombre de caràcters i la mateixa finalització de línia que en anys anteriors.

JIRA tractament procediment :  [ST-15917](https://contacte.aoc.cat/browse/ST-15917?src=confmacro) - Data cannot be retrieved due to an unexpected error.

\-------------------------------------------------------------------------------------------- per validar amb Dolors i Albert--------------------------------------------------------------------------------------------

![](attachments/41521832/41522447.png)

  

![](attachments/41521832/41522448.png)

  

![](attachments/41521832/41522449.png)

Procedure?

![](attachments/41521832/41522450.png)

  

![](attachments/41521832/41522451.png)

  

![](attachments/41521832/41522452.png)

  

336040 \[Thread-74757\] INFO sqlldr.SQLLoaderInvoker  - >>>> PROC\_OUT >>>> Commit point reached - logical record count 2018599

### 2.4    Comprovar resultat de la importació

  

Consultar a l’Administració i mirar Producte Padró (es comprova que els monitors estiguin bé, corresponen modalitat Resident)

![](attachments/41521832/64980447.png)

JIRA: [SIS-538](https://contacte.aoc.cat/browse/SIS-538)

  

**Tractament de les BBDD’s**

  

  

while read line; do printf "%-555s\\n" "$line"; done < p25\_20200701.dat > p25\_20200701\_formatat.dat

perl -p -i -e "s/\\r//g" p25\_20200701\_formatat.dat

  

L'aplicatiu 

  

Ruta: /apps/aoc/IOP/prjIdescatImport/dades/

  

  

  

Attachments:
------------

![](images/icons/bullet_blue.gif) [image2021-3-3\_22-29-28.png](attachments/41521832/41521833.png) (image/png)  
![](images/icons/bullet_blue.gif) [image2021-4-12\_12-7-22.png](attachments/41521832/41522441.png) (image/png)  
![](images/icons/bullet_blue.gif) [image2021-4-12\_12-12-2.png](attachments/41521832/41522442.png) (image/png)  
![](images/icons/bullet_blue.gif) [image2021-4-12\_12-12-20.png](attachments/41521832/41522443.png) (image/png)  
![](images/icons/bullet_blue.gif) [image2021-4-12\_12-13-3.png](attachments/41521832/41522444.png) (image/png)  
![](images/icons/bullet_blue.gif) [image2021-4-12\_12-22-7.png](attachments/41521832/41522445.png) (image/png)  
![](images/icons/bullet_blue.gif) [image2021-4-12\_12-22-17.png](attachments/41521832/41522446.png) (image/png)  
![](images/icons/bullet_blue.gif) [image2021-4-12\_12-22-51.png](attachments/41521832/41522447.png) (image/png)  
![](images/icons/bullet_blue.gif) [image2021-4-12\_12-23-1.png](attachments/41521832/41522448.png) (image/png)  
![](images/icons/bullet_blue.gif) [image2021-4-12\_12-23-9.png](attachments/41521832/41522449.png) (image/png)  
![](images/icons/bullet_blue.gif) [image2021-4-12\_12-23-19.png](attachments/41521832/41522450.png) (image/png)  
![](images/icons/bullet_blue.gif) [image2021-4-12\_12-23-32.png](attachments/41521832/41522451.png) (image/png)  
![](images/icons/bullet_blue.gif) [image2021-4-12\_12-23-41.png](attachments/41521832/41522452.png) (image/png)  
![](images/icons/bullet_blue.gif) [image2021-9-28\_13-13-39.png](attachments/41521832/61931722.png) (image/png)  
![](images/icons/bullet_blue.gif) [image2022-2-22\_12-34-39.png](attachments/41521832/64980330.png) (image/png)  
![](images/icons/bullet_blue.gif) [image2022-2-22\_16-24-6.png](attachments/41521832/64980336.png) (image/png)  
![](images/icons/bullet_blue.gif) [image2022-2-24\_11-53-41.png](attachments/41521832/64980382.png) (image/png)  
![](images/icons/bullet_blue.gif) [image2022-2-25\_11-25-43.png](attachments/41521832/64980441.png) (image/png)  
![](images/icons/bullet_blue.gif) [image2022-2-25\_11-29-8.png](attachments/41521832/64980442.png) (image/png)  
![](images/icons/bullet_blue.gif) [image2022-2-25\_11-30-13.png](attachments/41521832/64980443.png) (image/png)  
![](images/icons/bullet_blue.gif) [image2022-2-25\_12-4-22.png](attachments/41521832/64980447.png) (image/png)  
![](images/icons/bullet_blue.gif) [image2022-2-28\_10-16-10.png](attachments/41521832/64980454.png) (image/png)  
![](images/icons/bullet_blue.gif) [image2022-2-28\_10-17-2.png](attachments/41521832/64980455.png) (image/png)  
![](images/icons/bullet_blue.gif) [image2022-2-28\_11-3-10.png](attachments/41521832/64980458.png) (image/png)  
![](images/icons/bullet_blue.gif) [image2022-2-28\_11-41-55.png](attachments/41521832/64980460.png) (image/png)  
![](images/icons/bullet_blue.gif) [image2022-2-28\_11-44-44.png](attachments/41521832/64980461.png) (image/png)  
![](images/icons/bullet_blue.gif) [image2022-2-28\_12-1-52.png](attachments/41521832/64980462.png) (image/png)  
![](images/icons/bullet_blue.gif) [image2022-2-28\_12-10-47.png](attachments/41521832/64980464.png) (image/png)  
![](images/icons/bullet_blue.gif) [image2022-2-28\_13-22-11.png](attachments/41521832/64980486.png) (image/png)  
![](images/icons/bullet_blue.gif) [image2022-3-1\_14-36-24.png](attachments/41521832/64980518.png) (image/png)  
![](images/icons/bullet_blue.gif) [image2022-3-1\_14-37-22.png](attachments/41521832/64980519.png) (image/png)  
![](images/icons/bullet_blue.gif) [image2022-3-1\_14-40-45.png](attachments/41521832/64980521.png) (image/png)  
![](images/icons/bullet_blue.gif) [image2022-6-2\_13-5-4.png](attachments/41521832/64981640.png) (image/png)  
![](images/icons/bullet_blue.gif) [image2022-6-8\_11-17-22.png](attachments/41521832/64981693.png) (image/png)  
![](images/icons/bullet_blue.gif) [image2022-6-8\_11-18-3.png](attachments/41521832/64981694.png) (image/png)  
![](images/icons/bullet_blue.gif) [image2022-9-13\_10-19-41.png](attachments/41521832/77824427.png) (image/png)  
![](images/icons/bullet_blue.gif) [image2022-9-13\_10-19-51.png](attachments/41521832/77824428.png) (image/png)  
![](images/icons/bullet_blue.gif) [image2022-11-7\_10-19-26.png](attachments/41521832/81854690.png) (image/png)  
![](images/icons/bullet_blue.gif) [image2023-11-29\_9-39-25.png](attachments/41521832/100008480.png) (image/png)  
![](images/icons/bullet_blue.gif) [image2024-2-27\_14-51-17.png](attachments/41521832/100009527.png) (image/png)  
![](images/icons/bullet_blue.gif) [image2024-3-22\_11-16-43.png](attachments/41521832/100009880.png) (image/png)  
![](images/icons/bullet_blue.gif) [Aclariment càrrega dades IDESCAT.msg](attachments/41521832/100010607.msg) (application/vnd.ms-outlook)  

Document generated by Confluence on 02 June 2025 10:47

[Atlassian](http://www.atlassian.com/)