Projectes : Esborrat automàtic de signatures i generació d'estadístiques  

1.  [Projectes](index.md)
2.  [SIGNADOR](SIGNADOR_41523646.md)

Projectes : Esborrat automàtic de signatures i generació d'estadístiques
========================================================================

Created by Áurea Alcaide, last modified on 06 febrero 2025

EXECUCIÓ PROGRAMADA
-------------------

El Signador disposa d'un scheduler d'eliminació de signatures antigues, i generació d'estadístiques pel PowerBI.

Al codi font, aquest scheduler es troba a la classe:

**cat.aoc.applet.web.controllers.task.TaskScheduledDelete**

Actualment la priodicitat de l'execució està harcoded en la mateixa classe:

	@Scheduled( cron = "0 0 0 \* \* \*")
	public void executeDeleteTask(){
		logger.info( "\[executeDeleteTask\] - inici" );
		
		\[...\]
		
		logger.info( "\[executeDeleteTask\] - Fi" );
	}

  

Hi ha un parell de paràmetres que es defineixen a l'arxiu /apps/aoc/APP/prjAppletCentralitzat/**appletCentralitzat.cfg.properties**:

task.delete.activated=true

task.days.delete=15

**task.delete.activated**:   Per habilitar i/o deshabilitar la tasca.

**task.days.delete**: S'eliminen les signatures i els arxius corresponents més antic dels dies indicats.

Estadístiques
-------------

Les estadístiques es generen amb el procés anterior. Concretament es guarden a la taula:

**AOC\_AC\_BI**

Les estadístiques s'agrupen en aquesta taula de manera mensual per cada client:

*   Identificador de client.
*   Any.
*   Mes.
*   Nº de signatures generades pel client durant aquell mes concret.

### Queries de consulta d'estadístiques

Estadístiques per un client concret:

select to\_char(bi.year)||'/'||to\_char(to\_date(bi.month,'MM'),'MM') datee, auth.codi\_ine ine, auth.nom nom, bi.num\_total\_sign num\_total\_sign
from aoc\_ac\_bi bi, aoc\_ac\_auth auth
where bi.id\_auth = auth.id
order by datee asc, num\_total\_sign desc

Estadístiques mensuals globals:

select to\_char(bi.year)||'/'||to\_char(to\_date(bi.month,'MM'),'MM') datee, sum(bi.num\_total\_sign) num\_total\_sign
from aoc\_ac\_bi bi
group by to\_char(bi.year)||'/'||to\_char(to\_date(bi.month,'MM'),'MM')
order by to\_char(bi.year)||'/'||to\_char(to\_date(bi.month,'MM'),'MM') asc

  
Estadístiques anuals globals:

select to\_char(bi.year) datee, sum(bi.num\_total\_sign) num\_total\_sign
from aoc\_ac\_bi bi
group by to\_char(bi.year)
order by to\_char(bi.year) asc

  

EXECUCIÓ MANUAL
---------------

Per execució manual:

**1.-** Crear una nova classe amb aquest codi:

package cat.aoc.applet.web.controllers.task;

import java.util.Date;

import javax.activation.DataSource;

import org.apache.commons.lang.time.DateUtils;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.scheduling.annotation.EnableScheduling;
import org.springframework.scheduling.annotation.Scheduled;
import org.springframework.stereotype.Service;

import cat.aoc.applet.db.BusinessIntelligenceDAO;
import cat.aoc.applet.db.ConfigSignaturaDAO;
import cat.aoc.applet.web.service.DocumentService;
import cat.aoc.applet.web.service.PropertiesService;

import org.apache.commons.dbcp.\*;

@Service
public class TaskScheduledDelete2 {
	
	public void executeDeleteTask(){
		System.out.println( "\[executeDeleteTask\] - inici" );
		
		ConfigSignaturaDAO cfgSignDAO = new ConfigSignaturaDAO();
		 
		
		BasicDataSource dataSource = new BasicDataSource();
		dataSource.setDriverClassName("oracle.jdbc.driver.OracleDriver");
		dataSource.setUsername("SIGNADOR");
		dataSource.setPassword("JRd-Da-DkD-Yhs.H124d34");
		dataSource.setUrl("jdbc:oracle:thin:@(DESCRIPTION=(ADDRESS=(PROTOCOL=TCP)(HOST=ora12pro-scan.aoc.cat)(PORT=1521))(CONNECT\_DATA=(SERVER=DEDICATED)(SERVICE\_NAME=ORA12PRO)))");
		dataSource.setMaxActive(10);
		dataSource.setMaxIdle(5);
		dataSource.setInitialSize(5);
		dataSource.setValidationQuery("SELECT 1 FROM DUAL");
		cfgSignDAO.setDataSource(dataSource);
		
		DocumentService documentService = new DocumentService();
		
		BusinessIntelligenceDAO biDAO = new BusinessIntelligenceDAO();
		biDAO.setDataSource(dataSource);
			
		int numDies = 25;
		
		// guardem les dades pel Business Intelligence
		boolean create = biDAO.createInfoBI( cfgSignDAO.selectAllConfigByDays( numDies ) );
		
		if( create ){						
			// Esborrem les carpetes amb les peticions/respostes de servidor
			Date dataEsborrar = DateUtils.addDays( new Date(), -numDies );
			documentService.deleteAllByDate( "/apps/aoc/APP/prjAppletCentralitzat/repository/", dataEsborrar );
		}
		
		
		System.out.println( "\[executeDeleteTask\] - Fi" );
	}

	public static void main (String\[\] args) {
		TaskScheduledDelete2 delete2 = new TaskScheduledDelete2();
		delete2.executeDeleteTask();
	}
}

**2.-** Per poder compil·lar dins del signador.war la classe anterior, afegir aquestes dependències al build.gradle:

	compile "commons-dbcp:commons-dbcp:1.4"
	compile "org.apache.commons:commons-pool2:2.10.0"

  

**3.-** Compilar:

cd C:\\E\\SIGNADOR\\SourceCode\\github\\signador1\\prjAppletSignaturaCentralitzat
gradlew.bat clean war -Pentorn=pro

  

**4.-** Extreure la classe del signador.war, i pujar la per FTP al servidor a:

/apps/versions/apache-tomcat-8.5.11/webapps/signador/WEB-INF/classes/cat/aoc/applet/web/controllers/task

  

**5.-** Pujar les següents llibreries per FTP al servidor a:

/apps/versions/apache-tomcat-8.5.11/webapps/signador/WEB-INF/lib

Aquestes s'hauran afegit al signador.war en compilar:

commons-dbcp-1.4.jar
commons-pool-1.5.4.jar

I pujar també els drivers d'Oracle a la mateixa carpeta. La llibreria la tenim a:

C:\\E\\SIGNADOR\\SourceCode\\github\\signador1\\prjAppletSignaturaCentralitzat\\libs\\test\\ojdbc6.jar

  

**6.-** Execució

Ens connectem al mateix node on haguem fet les pujades anteriors, i fem:

cd /apps/tomcat8/webapps/signador/WEB-INF/classes/cat/aoc/applet/web/controllers/task
 
java -classpath "/apps/tomcat8/webapps/signador/WEB-INF/classes/":"/apps/tomcat8/webapps/signador/WEB-INF/lib/\*" cat.aoc.applet.web.controllers.task.TaskScheduledDelete2

  

  

  

  

  

  

  

  

  

  

  

  

Document generated by Confluence on 07 junio 2025 00:00

[Atlassian](http://www.atlassian.com/)