Suport Tècnic : Monitor S.T. - PCI - Peticions/solicituds de IOP en estats inconsistents a la MTI  

1.  [Suport Tècnic](index.md)
2.  [Suport Tècnic](13893782.md)
3.  [03 - Monitorització - Revisions globals](26313327.md)
4.  [Monitors S.T.](Monitors-S.T._41522177.md)

Suport Tècnic : Monitor S.T. - PCI - Peticions/solicituds de IOP en estats inconsistents a la MTI
=================================================================================================

Created by Unknown User (otecobernal), last modified by Joan Riquelme on 10 April 2025

Què mesura aquest monitor?

Monitor que revisa les peticions i sol·licituds que s'han quedat enganxades en un estat inconsistent a la MTI.

**Consulta**
============

* * *

       select count(peticio.id) registres
          from pci30iop.pci\_mti\_peticio   peticio,
               pci30iop.pci\_mti\_solicitud solicitud
         where solicitud.id\_peticio = peticio.id
           and peticio.data\_recepcio between SYSDATE - 7 AND SYSDATE - INTERVAL '600' MINUTE
           and peticio.codi\_producte not in ('REGISTRE\_PROPIETAT', 'REGISTRE\_MERCANTIL')
           and (solicitud.estat = -1 or peticio.estat = -1)

**Procediment**
===============

* * *

Aquesta tasca es duu a terme per evitar que peticions i sol·licituds es quedin  enganxades en un estat inconsistent a la MTI.

Això acostuma a passar quan cauen els nodes de WL12. Hi ha peticions que es queden a mig tractar i si no les reiniciem no seran tractades mai més.

Consultar la Base de dades de la MTI - IOP
------------------------------------------

Una vegada hem comprovat que el servei funciona correctament, llançarem un seguit de querys a l'esquema PCI30IOP DB: ORA12

### 1- Consulta d'estat de peticions i sol·licituds 

**Consulta estat peticions i solicituds**

select peticio.estat as estat\_peticio, solicitud.estat as estat\_solicitud, count(\*)
  from pci30iop.pci\_mti\_peticio peticio, pci30iop.pci\_mti\_solicitud solicitud
 where solicitud.id\_peticio = peticio.id
   and peticio.data\_recepcio between SYSDATE - 7 AND SYSDATE - INTERVAL '600' MINUTE
   and peticio.codi\_producte not in ('REGISTRE\_PROPIETAT', 'REGISTRE\_MERCANTIL') 
   and (peticio.estat = -1 or solicitud.estat = -1)
 group by peticio.estat, solicitud.estat
 order by count(\*) desc;

  

### Aquesta consulta ens mostrarà l'estat de totes les parelles petició - sol·licitud de la MTI en que alguna de les dues estigui a -1

A més, li donem 10 hores de marge des de que han començat a processar-se. Això vol dir que ens mostra registres que fa més de 10 hores que han entrat, i estan a -1.

  

Comprovem que no estigui actuant el RDBMS

Comprovem que no estigui actuant algun RDBMS sobre les peticions.

Encara que donem 10 hores de marge, pot ser que ens hagi arribat un consum super massiu i el RDBMS encara estigui processant-lo. No és tan estrany.

Per tant, per comprovar que el RDBMS no estigui encara actuant, llençarem la query de sobre repetidament:

**OPCIÓ 1**: **Els números van variant** → El RDBMS està actuant → **No actuem encara amb aquesta sonda**, deixem que el RDBMS acabi la seva feina.

**OPCIÓ 2**: **Els números es mantenen fixes** → Això vol dir que cap RDBMS està actuant i que les peticions han quedat enganxades → **Continuem amb l'actuació** que es descriu en aquesta FAQ.

  

Actuació amb UPDATES
--------------------

Haurem de UPDATEJAR l'estat d'aquests registres erronis. Ho fem seguint la següent lògica:

**Estat petició**

**Estat sol·licitud**

**Actuació**

\-1

2

Update estat petició = 2 perquè el RDBMS **FASE5** les agafi

2

\-1

Update estat sol·licitud = 0 perquè el RDBMS **FASE4** les agafi

\-1

0

Update estat petició = 0 perquè el RDBMS **FASE3** les agafi

\-1

4

Update estat petició = 4 per marcar la petició com a finalitzada amb **error**

Si amb la consulta de BBDD del punt anterior ens trobem amb un cas que no estigui descrit aquí, comentar-ho internament.

  

Així doncs, els UPDATES per cada un dels casos són:

És interessant fer-ho en l'ordre que s'indica a continuació, d'esquerra a dreta, per anar escombrant les fases de més avançada a més endarrerida.

Estat petició

Estat sol·licitud

\-1

2

UPDATE: 

update pci30iop.pci\_mti\_peticio pp
set pp.estat = 2
where pp.id in (
select distinct pp.id
from pci30iop.pci\_mti\_peticio pp, pci30iop.pci\_mti\_solicitud ss
where ss.id\_peticio = pp.id
and pp.estat =-1
and ss.estat =2
and pp.codi\_producte <> 'REGISTRE\_PROPIETAT'
and pp.codi\_producte <> 'REGISTRE\_MERCANTIL'
and pp.data\_recepcio >= sysdate - 7
and pp.data\_recepcio <= SYSDATE - INTERVAL '600' MINUTE);

Estat petició

Estat sol·licitud

2

\-1

UPDATE: 

update pci30iop.pci\_mti\_solicitud ss
set ss.estat = 0
where ss.id in
(select ss.id
from pci30iop.pci\_mti\_peticio pp, pci30iop.pci\_mti\_solicitud ss
where ss.id\_peticio = pp.id
and pp.estat = 2
and ss.estat = -1
and pp.codi\_producte <> 'REGISTRE\_PROPIETAT'
and pp.codi\_producte <> 'REGISTRE\_MERCANTIL'
and pp.data\_recepcio >= sysdate - 7
and pp.data\_recepcio <= SYSDATE - INTERVAL '600' MINUTE);

Estat petició

Estat sol·licitud

\-1

0

UPDATE: 

update pci30iop.pci\_mti\_peticio pp
set pp.estat = 0
where pp.id in (select distinct pp.id
from pci30iop.pci\_mti\_peticio pp, pci30iop.pci\_mti\_solicitud ss
where ss.id\_peticio = pp.id
and pp.estat =-1
and ss.estat =0
and pp.codi\_producte <> 'REGISTRE\_PROPIETAT'
and pp.codi\_producte <> 'REGISTRE\_MERCANTIL'
and pp.data\_recepcio >= sysdate - 7
and pp.data\_recepcio <= SYSDATE - INTERVAL '600' MINUTE
);

Estat petició

Estat sol·licitud

\-1

4

UPDATE: 

update pci30iop.pci\_mti\_peticio pp
set pp.estat = 4
where pp.id in (select distinct pp.id
from pci30iop.pci\_mti\_peticio pp, pci30iop.pci\_mti\_solicitud ss
where ss.id\_peticio = pp.id
and pp.estat = -1
and ss.estat = 4
and pp.codi\_producte <> 'REGISTRE\_PROPIETAT'
and pp.codi\_producte <> 'REGISTRE\_MERCANTIL'
and pp.data\_recepcio >= sysdate - 7
and pp.data\_recepcio <= SYSDATE - INTERVAL '600' MINUTE
);

Imputar tasca a JIRA
--------------------

[ST-10156](https://contacte.aoc.cat/browse/ST-10156?src=confmacro) - Data cannot be retrieved due to an unexpected error.  

Si és un mes nou haurem de clonar el del mes passat i fer un pel mes actual

  

**Informació addicional**
=========================

* * *

  

  

Attachments:
------------

![](images/icons/bullet_blue.gif) [CORPME - Procés d'alta de serveiSuport Tècnic16 marzo 2020Procediment a realitzar setmanalment per les altes del CORPME. Guia.url](attachments/64979263/64979264.url) (application/octet-stream)  
![](images/icons/bullet_blue.gif) [cds.gif](attachments/64979263/64979265.gif) (image/gif)  

Document generated by Confluence on 02 June 2025 11:09

[Atlassian](http://www.atlassian.com/)