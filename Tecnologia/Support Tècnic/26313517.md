Suport Tècnic : eNOTUM - INTEGRACIÓ FTP - LOTS Barcelona  

1.  [Suport Tècnic](index.md)
2.  [Suport Tècnic](13893782.md)
3.  [02 - FAQ's serveis](26313393.md)
4.  [FAQ's ENOTUM](28705561.md)
5.  [eNOTUM - FLUX DEL SERVEI - ERRORS - Errors en el cicle de vida d'una notificació (ESTATS >= 1024)](36340658.md)
6.  [Errors en creació d'una notificació (Integració i EACAT)](36341306.md)

Suport Tècnic : eNOTUM - INTEGRACIÓ FTP - LOTS Barcelona
========================================================

Created by Unknown User (agonlara), last modified by Joan Riquelme on 31 March 2025

Cada dimarts a la nit, l'Ajuntament de Barcelona llança lots de notificacions perquè s'enviïn. Hi ha cops que alguns d'aquests lots no es processa correctament o alguna notificació falla i hem de cercar-la per veure quin ha sigut l'error. 

Normalment quan ens obrin incidència de lots ens informaran que hi ha X lots que no s'han processat. Però també hi ha casos en els quals ens diuen explícitament alguna notificació d'un lot. 

  

### _Pel cas que ens indiquin un lot sencer sense processar_

Revisar lot sencer sense processar

1- Revisem els lots al FTP de Barcelona
---------------------------------------

*   Ens connectem a qualsevol node del SOA de PCI3:

![](https://intranet.aoc.cat/plugins/servlet/confluence/placeholder/unknown-attachment?locale=es_ES&version=2)

  

*   Anem a la ruta: /mnt/storage30/aoc/APP/PCI30-FTP/ftp801930008/mtiftp (ftp801930008 és la carpeta de BCN)

![](https://intranet.aoc.cat/plugins/servlet/confluence/placeholder/unknown-attachment?locale=es_ES&version=2)

Carpeta

Funció

Comentari

OUT

Queden les respostes XML als consums de lots que que han acabat bé.

Barcelona recupera aquestes respostes i les esborra.

No és important per aquest procediment

IN

Es desen els xml (lots) per processar

D'aquesta carpeta els xml passen a Processing

Processing

Es processen els lots

D'aquesta carpeta passen a Processed o error

Processed

Carpeta on es desen els lots processats

N/A

Error

Si el procés falla, es diposita l'xml en aquesta carpeta.

N/A

  

1.2- Llancem les peticions XML que s'hagin quedat corruptes
-----------------------------------------------------------

*   Revisem la carpeta processing. Si en aquesta carpeta conté l'XML que es queixen (no s'ha processat), ens el descarreguem i el passem a la carpeta IN. **Abans de passar-lo l'esborrem de la carpeta processing, assegurant que tenim una còpia.** 
*   Esperem una estona perquè el sistema agafi de nou el lot i el processi. **Finalment el fitxer ha de quedar en la carpeta processed.** 

  

2- Validem que tots els lots s'han processat  
==============================================

La forma de saber si s'ha processat és mirar el SIRI i la PCI . Si en la PCI hi ha els mateixos lots que en el SIRI vol dir que s'han processat tots els lots. 

\--1) Revisem les peticions que han arribat al SIRI
select \* 
from siri.aoc\_pci\_siri\_registre re
where re.codi\_producte='ENOTUM' ---801930008
and re.codi\_modalitat='ENOTUM\_LOT'
and re.data\_entrada >to\_date('//2019','dd/mm/yyyy');---Posar data a partir de l'últim dimarts. (Llencen les peticions cada dimarts de la setmana).
 
 ---2) Agafem les peticions del siri i les busquem a la PCI
select pet.id\_peticio as ID\_LOT, count(sol.id\_peticio) as NUM\_NOTIS
from pci30app.PCI\_MTI\_PETICIO pet,pci30app.PCI\_MTI\_SOLICITUD sol
  where pet.id\_peticio in 
('MN09521683180918',
'MN10303684180918')
  and sol.id\_peticio = pet.id
  group by pet.id\_peticio;


--Aquesta query ens mostrarà els ID de cada lot que s'ha processat i el número de sol·licituds (notificacions) que componen el lot. 

  

3- Revisar a eNOTUM les peticions que s'han llançat 
====================================================

Hem de revisar que els estats de les notificacions que es van processant és més gran de 3 (Dipositada).

    _Estat 3: Generada OK_  
    _Estat 1: Generant_  
    _Estat 0: Preparada per generar_

\--Tenint en compte que hem llançat mínim un lot, filtrarem en aquesta query l'hora que l'hem llançat i podrem veure les notificacions processant-se/processades. 


select nn.\*
from nt30.aoc\_nt\_notificacions nn, nt30.aoc\_nt\_tramesa tr
where tr.id\_tramesa = nn.id\_tramesa
and tr.id\_entitat = 69--pro69 --pre 795
and nn.data\_creacio >= to\_date('1//2019 15:00:00', 'dd/mm/yyyy hh24:mi:ss');

  

En cas que alguna doni algun error haurem d'analitzar que ha sigut.

_Quan tinguem incidències obertes on ens informin que alguna notificació en concret no s'ha dipositat, haurem de revisar el lot en qüestió i la notificació._ 

Revisar una notificació d'un lot

6- Altres QUERYS per revisió
============================

**Id sol·licitud (PCI) = id\_notificacio\_emissor (DB e-NOTUM) de la taula: nt30.aoc\_nt\_notificacions  
  
Per tant, l'ID notificació que ens indica Barcelona al Footprints, és realment l'id\_notificacio\_emissor de la taula nt30.aoc\_nt\_notificacions i és l'id\_sol·licitud de la petició de la MTI amb id\_petició=id\_lot que ens envia Barcelona.**

El primer que hem de mirar és la sol·licitud en la PCI: [http://10.120.4.58/pci3-mti-admin/peticions/mti](http://10.120.4.58/pci3-mti-admin/peticions/mti)

  

Busquem el lot:

![](https://intranet.aoc.cat/plugins/servlet/confluence/placeholder/unknown-attachment?locale=es_ES&version=2)

Busquem la sol·licitud que ens indica l'usuari:

![](https://intranet.aoc.cat/plugins/servlet/confluence/placeholder/unknown-attachment?locale=es_ES&version=2)

Un cop localitzada, revisem la resposta de la sol·licitud per veure l'error.

  

Normalment ens trobarem amb l'error: [eNOTUM - Error: "Per a notificar una administració pública catalana heu d'utilitzar la plataforma EACAT"](26313359.md)

  

També és possible que aquesta sol·licitud hagi fallat al processar-se en la MTI. **En aquest cas el lot en la PCI queda en estat EXECUTAT**:

\--En cas que l'usuari ens informi que una notificació no s'ha generat i ens dóna l'ID, aquest id serà l'id\_solicitud. 
select sol.\*
from pci30app.PCI\_MTI\_PETICIO pet,pci30app.PCI\_MTI\_SOLICITUD sol
  where pet.id\_peticio in ('MN03242077100419') --Informem el id de la petició que ha fallat per buscar aquesta solicitud, veure estat...
	--and sol.id\_solicitud = ''; --Podem informar el id sol- licitud si el tenim


--En cas que falli pel procés de la PCI hem de reiniciar els estats de la sol·licitud.
-- REVISAR QUE LA SOLICITUD HA CANVIAT A ESTAT 2. 
  update pci30app.PCI\_MTI\_SOLICITUD sol
  set estat = 0
  where sol.id = '911365217'

--L'ID sol·licitud de la PCI és equivalent a id\_notificacio\_emissor:
select \* 
from nt30.aoc\_nt\_notificacions nn
where id\_notificacio\_emissor in 
('549193')

  

Revisar LOGS a la maquina soa@aoc-l-soa1-pro : 

\[PRO\]\[soa@aoc-l-soa01-pro processed\]$ cd /apps/aoc/APP/logs

\[PRO\]\[soa@aoc-l-soa01-pro processed\]$ grep -i 'lote' PCI30\_MTI\_APPNODO?\_SOA.log

![](https://intranet.aoc.cat/plugins/servlet/confluence/placeholder/unknown-attachment?locale=es_ES&version=2)

**EN CAS d'ERROR ALS CALLBACKS:** 

Caused by: java.lang.ClassNotFoundException: /apps/aoc/APP/NT30/cfg/wsdd/proxy-pdib.xml

[eNOTUM - FLUX DEL SERVEI - ERRORS - Callback BCN](/pages/createpage.action?spaceKey=SII&title=eNOTUM+-+FLUX+DEL+SERVEI+-+ERRORS+-+Callback+BCN&linkCreation=true&fromPageId=26313517)  

  

  

**Extra - Revisió dels errors de resposta XML**
===============================================

Pot ser que Barcelona ens passi una llista molt gran de peticions i sol·licituds per la qual no han rebut resposta.

A continuació proposo una query que extreu el missatge d'error a nivell de missatgeria XML atacant als XML's guardats a la MTI:

  

SELECT 
    pp.id, 
    pp.id\_peticio, 
    pp.estat, 
    ss.id, 
    ss.id\_solicitud, 
    ss.estat, 
    ss.element, 
    ss.node, 
    ss.data\_proces, 
    pp.data\_proces, 
    xx.xml, 
    xt.missatge\_error -- Extraemos MissatgeError correctamente
FROM pci30app.pci\_mti\_peticio pp
JOIN pci30app.pci\_mti\_solicitud ss ON ss.id\_peticio = pp.id
LEFT JOIN pci30app.pci\_mti\_xml xx ON xx.id\_solicitud = ss.id
LEFT JOIN XMLTABLE(
    XMLNAMESPACES(DEFAULT 'http://www.aocat.net/NT/v3.2'), -- Especificamos el namespace
    '/RespostaProcessarTramesa/Errors/Error' PASSING XMLTYPE(xx.xml)
    COLUMNS missatge\_error VARCHAR2(4000) PATH 'MissatgeError' -- Extraemos el texto de MissatgeError
) xt ON 1=1 -- JOIN sin condición para no filtrar resultados
WHERE ss.modalitat\_consum = 'ENOTUM\_LOT'
and xx.tipus = 4 -- resposta de la solicitud
AND ss.id\_solicitud in 
(
-- Llista de id's sol·licitud a revisar. Ens ho acostuma a donar Barcelona sota el nom: Id Ajuntament Barcelona.
)

  

L'última columna d'aquesta query ens retornarà l'error que s'ha donat per aquesta solicitud, en cas que tingui error. La query parseja el XML de resposta cercant l'element ERROR, per tant només retornarà algo quan trobi aquest element.

  

  

  

  

  

  

  

  

Attachments:
------------

![](images/icons/bullet_blue.gif) [image2019-4-30\_13-54-58.png](attachments/26313517/26317333.png) (image/png)  
![](images/icons/bullet_blue.gif) [image2019-4-30\_13-57-37.png](attachments/26313517/26317331.png) (image/png)  
![](images/icons/bullet_blue.gif) [image2019-4-30\_15-5-42.png](attachments/26313517/26317282.png) (image/png)  
![](images/icons/bullet_blue.gif) [Lanzar lotes peticions(soapUi).docx](attachments/26313517/26317275.docx) (application/vnd.openxmlformats-officedocument.wordprocessingml.document)  
![](images/icons/bullet_blue.gif) [image2019-5-10\_14-54-4.png](attachments/26313517/26314578.png) (image/png)  
![](images/icons/bullet_blue.gif) [image2019-5-10\_14-55-28.png](attachments/26313517/26314579.png) (image/png)  
![](images/icons/bullet_blue.gif) [image2019-5-10\_14-56-1.png](attachments/26313517/26314575.png) (image/png)  
![](images/icons/bullet_blue.gif) [image2019-7-29\_14-6-2.png](attachments/26313517/26315794.png) (image/png)  

Document generated by Confluence on 02 June 2025 10:53

[Atlassian](http://www.atlassian.com/)