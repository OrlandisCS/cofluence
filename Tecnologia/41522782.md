Suport Tècnic : Monitor S.T. - e-NOTUM - Entitats amb callbacks en error últim mes  

1.  [Suport Tècnic](index.html)
2.  [Suport Tècnic](13893782.html)
3.  [03 - Monitorització - Revisions globals](26313327.html)
4.  [Monitors S.T.](Monitors-S.T._41522177.html)
5.  [Monitor S.T. - OLD](Monitor-S.T.---OLD_118555256.html)

Suport Tècnic : Monitor S.T. - e-NOTUM - Entitats amb callbacks en error últim mes
==================================================================================

Created by Unknown User (otecjriquelme), last modified by Joan Riquelme on 21 February 2024

Què mesura aquest monitor?

Fa una extracció de les entitats amb més de 500 enviaments de callback en estat d'error en l'últim mes. Per cada entitat amb més de 500 callbacks, s'obre un tiquet JIRA per tal que es revisi.

L'objectiu és poder detectar aquelles entitats a les quals els estan fallant els callbacks reiteradament.

**Consulta**
============

* * *

select ee.nom, ee.id\_entitat, ee.id\_ens, nn.codi\_bo, count(ee.id\_entitat) "Processos de callback en error"
  from nt30.aoc\_nt\_event\_cues\_missatgeria mm,
       nt30.aoc\_nt\_ws\_message\_queue       qq,
       nt30.aoc\_nt\_entitat                ee,
       nt30.aoc\_nt\_notificacions          nn
 where mm.identificador = qq.id
   and ee.id\_entitat = qq.id\_entitat
   and nn.id\_notificacio = qq.id\_notificacio
   and mm.reintent > 0
   and mm.inici\_execucio >= sysdate - 30
 group by ee.id\_entitat, ee.nom, ee.id\_ens, nn.codi\_bo
having count(ee.id\_entitat) >= 500
 order by count(ee.id\_entitat) desc;

**Procediment**
===============

* * *

Si retorna algun resultat haurem de revisar quines són les entitats afectades.

Per cada entitat que aparegui a l'extracció, comprovar els callbacks que han quedat en error:

**Comprovem notificacions en error per una entitat concreta**

select mm.\*, qq.id\_notificacio
from nt30.aoc\_nt\_event\_cues\_missatgeria mm, nt30.aoc\_nt\_ws\_message\_queue qq, nt30.aoc\_nt\_entitat ee
where ee.id\_entitat = qq.id\_entitat
and qq.id= mm.identificador
and ee.id\_entitat = 'XXXXX' -- id\_entitat que ha aparegut a l'extracció i de l'ens que volem revisar
order by mm.inici\_execucio desc;

  

El millor és recuperar un dels Id's de notificació per la que hagin fallat els callbacks (un dels id's notificació que ha aparegut a la query anterior) i revisar la taula de logs:

**Comprovem logs per una notificació concreta**

select \* from nt30.aoc\_nt\_logs\_comunicacio ll
where ll.id\_notificacio = 'XXXXXXXXX' -- notificacio d'exemple que hem agafat de la query anterior
order by ll.data\_log desc;

  

Si veiem que els errors estan concentrats en un període de temps, o fa la pinta que va ser algo puntual, podem provar a reiniciar una de les notificacions:

**Reinici dels events de callback lligats a una notificació**

update nt30.aoc\_nt\_event\_cues\_missatgeria mm
   set mm.reintent = mm.reintent - 1, mm.estat = 0
 where mm.id in (select mm.id
                   from nt30.aoc\_nt\_event\_cues\_missatgeria mm,
                        nt30.aoc\_nt\_ws\_message\_queue       qq
                  where qq.id = mm.identificador
                    and qq.id\_notificacio = 'XXXXXXX') -- Id notificació per la qual volem reiniciar el/s callback/s

  

1 - Si el reinici de una notificació ha funcionat, reiniciem totes les de l'entitat de forma massiva:

**Reinici massiu de callbacks per una entitat**

update nt30.aoc\_nt\_event\_cues\_missatgeria mm
   set mm.estat = 0, mm.reintent = mm.reintent - 1
 where mm.id in (select mm.id
                   from nt30.aoc\_nt\_event\_cues\_missatgeria mm,
                        nt30.aoc\_nt\_ws\_message\_queue       qq,
                        nt30.aoc\_nt\_entitat                ee
                  where ee.id\_entitat = qq.id\_entitat
                    and qq.id = mm.identificador
                    and ee.id\_entitat = '2220'); -- id de la entitat per la qual volem reiniciar els callbacks en error

I monitoritzem que es van processant correctament, el resultat de la següent query ha d'anar baixant:

**Monitoritzar callbacks pendents d'enviar per una entitat concreta**

select count (mm.id)
from nt30.aoc\_nt\_event\_cues\_missatgeria mm, nt30.aoc\_nt\_ws\_message\_queue qq, nt30.aoc\_nt\_entitat ee
where ee.id\_entitat = qq.id\_entitat
and qq.id= mm.identificador
and ee.id\_entitat = '2220' -- id de la entitat que volem monitoritzar
order by mm.inici\_execucio desc;

2 - Si el reinici de una notificació no ha funcionat, i veiem que torna a fallar, s'hauran de revisar els logs via SS (Informació al final d'aquesta FAQ).

També podem comprovar la connectivitat amb l'endpoint de l'ens, connectant-nos als SOA de PCI3 i provant amb un wget:

**Comprovar connectivitat amb l'endPoint**

wget XXXXXXXXXXXX --no-check-certificate

On XXXXX és l'endpoint cap on es dispara el callback. Podem treure'l  per exemple de la taula de logs, que ja s'ha consultat abans:

**Recuperar endPoint cap on s'ha disparat un callback**

select ll.desti from nt30.aoc\_nt\_logs\_comunicacio ll
where ll.id\_notificacio = '14499838' -- Notificació afectada de l'ens que estem revisant
order by ll.data\_log desc;

**Informació addicional**
=========================

* * *

### 1) Revisió de logs

Màquina: aoc-l-soa03 (10.120.1.172)

Ruta: /apps/aoc/NT/logs/NT-NTNODO?\_SOA.log

Attachments:
------------

![](images/icons/bullet_blue.gif) [cds.gif](attachments/41522782/41522783.gif) (image/gif)  

Document generated by Confluence on 02 June 2025 11:09

[Atlassian](http://www.atlassian.com/)