Suport Tècnic : 5 - Crear un servei automàtic  

1.  [Suport Tècnic](index.md)
2.  [Suport Tècnic](13893782.md)
3.  [04 - Tècnica de sistemes + 24x7 + Padró](26313202.md)
4.  [Revisió de serveis](36340340.md)
5.  [PADRO - Revisions i Restabliment](PADRO---Revisions-i-Restabliment_118554712.md)
6.  [Padró - Instal·lació i manteniment](26313622.md)
7.  [PADRO - Instal·lació de l'aplicació](26313260.md)

Suport Tècnic : 5 - Crear un servei automàtic
=============================================

Created by Unknown User (obernalp), last modified by Oriol Bernal on 03 January 2024

Servei de Windows

Si és un servidor Windows, podrem fer que l'aplicació del padró s'arrenqui automàticament en inciar el servidor. Per fer-ho, haurem de crear un servei de Windows:

Instal·lar el servei al servidor

Per crear i configurar el servei de Windows haurem de seguir aquestes passes:

1.  Obrirem una consola i anar a la ruta bin del tomcat
    
    cd C:\\aoc\_padro\\tomcat8\\bin
    
2.  Crearem el servei de Windows amb el nom AOC\_Padro
    
    service install AOC\_Padro
    
3.  Accedirem als serveis de Windows per veure el servei (Inici → Herramientas Administrativas → Servicios)  
    ![](attachments/26313313/26315713.png)  
      
    
4.  Canviarem les propietats perquè el tipus d'inici sigui automàtic (botó dret → Propiedades):  
    ![](attachments/26313313/26315712.png)![](attachments/26313313/26315702.png)  
      
    
5.  Iniciarem el servei de Windows:  
    ![](attachments/26313313/26315700.png)

Servei de Linux - mètode 1

Si és un servidor Linux, podrem crear un script per encendre, apagar i reiniciar el Tomcat i configurar-lo perquè, automàticament, encengui el servei en inciar el servidor.

1.  Accedir a la ruta:
    
    cd /etc/init.d/
    
2.  Crear l'script amb el nom tomcat8:
    
    vi tomcat8
    
3.  Crear l'script del servei:
    
    **Plantilla tomcat**
    
    #!/bin/bash
    
    ### BEGIN INIT INFO
    # Provides:        tomcat8
    # Required-Start:  $all
    # Required-Stop:   
    # Default-Start:   2 3 4 5
    # Default-Stop:    0 1 6
    # Short-Description: Start/Stop Tomcat server
    ### END INIT INFO
    
    PATH=/sbin:/bin:/usr/sbin:/usr/bin
    
    start() {
     sh {tomcat\_root}/bin/startup.sh
    }
    
    stop() {
     sh {tomcat\_root}/bin/shutdown.sh
    }
    
    case $1 in
      start|stop) $1;;
      restart) stop; start;;
      \*) echo "Run as $0 &lt;start|stop|restart&gt;"; exit 1;;
    esac
    
    _**Nota:** Canviar {tomcat\_root} amb la ruta on el Tomcat està instal·lat._
    
4.  Canviar permissos per poder executar l'script:
    
    chmod 755 /etc/init.d/tomcat8
    
5.  Afegir els symlinks necessaris:
    
    update-rc.d tomcat8 defaults
    

Haurem de fer una prova i revisar que s'aixeca de forma automàtica. A partir d'ara podrem arrencar i aturar el servei utilitzant:

service tomcat8 <stop|start|restart>

Cas La Seu d'Urgell

cd /etc/init.d/
sudo vi tomcat8

**Plantilla tomcat**

#!/bin/bash
#
# tomcat     This shell script takes care of starting and stopping Tomcat
#
# chkconfig: - 80 20
#
### BEGIN INIT INFO
# Provides: tomcat8
# Required-Start: $all
# Required-Stop: 
# Default-Start:2 3 4 5
# Default-Stop:
# Short-Description: start and stop tomcat
### END INIT INFO

TOMCAT\_USER=aocoftec
TOMCAT\_HOME="/home/aocoftec/tomcat-8/"
SHUTDOWN\_WAIT=45

tomcat\_pid() {
    echo \`ps aux | grep org.apache.catalina.startup.Bootstrap | grep -v grep | awk '{ print $2 }'\`
}

start() {
    pid=$(tomcat\_pid)
    if \[ -n "$pid" \]
    then
        echo "Tomcat is already running (pid: $pid)"
    else
        # Start tomcat
        echo "Starting tomcat"
        /bin/su - -c "cd $TOMCAT\_HOME/bin && $TOMCAT\_HOME/bin/startup.sh" $TOMCAT\_USER
    fi
    return 0
}

stop() {
    pid=$(tomcat\_pid)
    if \[ -n "$pid" \]
    then
        echo "Stopping Tomcat"
        /bin/su - -c "cd $TOMCAT\_HOME/bin && $TOMCAT\_HOME/bin/shutdown.sh" $TOMCAT\_USER

    let kwait=$SHUTDOWN\_WAIT
    count=0
    count\_by=5
    until \[ \`ps -p $pid | grep -c $pid\` = '0' \] || \[ $count -gt $kwait \]
    do
        echo "Waiting for processes to exit. Timeout before we kill the pid: ${count}/${kwait}"
        sleep $count\_by
        let count=$count+$count\_by;
    done

    if \[ $count -gt $kwait \]; then
        echo "Killing processes which didn't stop after $SHUTDOWN\_WAIT seconds"
        kill -9 $pid
    fi
    else
        echo "Tomcat is not running"
    fi

    return 0
}

case $1 in
    start)
        start
        ;;
    stop)
        stop
        ;;
    restart)
        stop
        start
        ;;
    status)
       pid=$(tomcat\_pid)
        if \[ -n "$pid" \]
        then
           echo "Tomcat is running with pid: $pid"
        else
           echo "Tomcat is not running"
        fi
        ;;
esac

exit 0

sudo chmod 755 /etc/init.d/tomcat8
sudo update-rc.d tomcat8 defaults
sudo systemctl enable tomcat8

systemctl <stop|start|restart> tomcat8

Servei de Linux - mètode 2

Si és un servidor Linux, podrem crear un script per encendre, apagar i reiniciar el Tomcat i configurar-lo perquè, automàticament, encengui el servei en inciar el servidor.

1.  Accedir a la ruta:
    
    cd /etc/systemd/system/
    
2.  Crear l'script amb el nom aoc\_padro.service:
    
    vi aoc\_padro.service
    
3.  Crear l'script del servei:
    
    **Plantilla tomcat**
    
    \[Unit\]
    Description=Apache Tomcat Server
    After=syslog.target network.target
    
    \[Service\]
    Type=forking
    User={{{{{USUARI}}}}}
    Group={{{{{GRUP}}}}}
    
    Environment=CATALINA\_PID={{{{{TOMCAT\_ROOT}}}}/temp/tomcat.pid
    Environment=CATALINA\_HOME={{{{{TOMCAT\_ROOT}}}}
    Environment=CATALINA\_BASE={{{{{TOMCAT\_ROOT}}}}
    
    ExecStart={{{{{TOMCAT\_ROOT}}}}/bin/catalina.sh start
    ExecStop={{{{{TOMCAT\_ROOT}}}}/bin/catalina.sh stop
    
    RestartSec=10
    Restart=always
    \[Install\]
    WantedBy=multi-user.target
    
4.  Aplicar la configuració:
    
    systemctl daemon-reload
    
5.  Arrencar el servei i habilitar-lo:
    
    systemctl start aoc\_padro
    systemctl enable aoc\_padro
    systemctl status aoc\_padro
    

Haurem de fer una prova i revisar que s'aixeca de forma automàtica. A partir d'ara podrem arrencar i aturar el servei utilitzant:

systemctl stop aoc\_padro
systemctl start aoc\_padro
systemctl restart aoc\_padro

Problemes a l'instal·lar/iniciar servei automàtic
-------------------------------------------------

Servei de Windows

Problemes a l'arrencar el servei

En el cas d'haver instal·lat el servei amb èxit i a l'hora d'executar-lo desde la pantalla de "Services" ens dóna un problema, l'origen pot venir de: 

### 1- Línea export JAVA\_HOME al fitxer service.bat no detallat:

En aquests casos ens saltarà una pantalla d'error similar a: 

![](attachments/26313313/41517889.png?effects=drop-shadow)

  

**SOLUCIÓ**

*   Anar a la carpeta bin del tomcat, normalment esta en la ruta: _C:\\aoc\_padro\\tomcat-9\\bin_
*   Obrir el fitxer service.bat amb un editor de text (notepad++, bloc de notas...).
*   Afegir la propietat: _set JAVA\_HOME=C:/Program Files/Java/jdk1.8.0\_121_Tal com esta infomat en el catalina.bat: 

![](attachments/26313313/41517890.png?effects=drop-shadow)

*   Eliminem el servei que ens estava donant error i el tornem a instal·lar de nou. 

  

[.rwui\_id\_5ec2b6ec-dd7a-41ab-9173-a8b1fec5f422 {color: #FFFFFF !important; background: rgb(67,197,208);}.rwui\_id\_5ec2b6ec-dd7a-41ab-9173-a8b1fec5f422:hover {background: rgb(62,182,192);}.rwui\_id\_5ec2b6ec-dd7a-41ab-9173-a8b1fec5f422 .rwui\_icon {color: #FFFFFF !important;}Tornar enrere](https://steps.everis.com/confluence/pages/viewpage.action?pageId=1135312613 "Tornar enrere") [.rwui\_id\_7fc24ec6-b255-467d-8908-a8afb822c2dd {color: #FFFFFF !important; background: rgb(67,197,208);}.rwui\_id\_7fc24ec6-b255-467d-8908-a8afb822c2dd:hover {background: rgb(62,182,192);}.rwui\_id\_7fc24ec6-b255-467d-8908-a8afb822c2dd .rwui\_icon {color: #FFFFFF !important;}Següent pas](https://steps.everis.com/confluence/pages/viewpage.action?pageId=1135312662 "Següent pas")
-----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------

Attachments:
------------

![](images/icons/bullet_blue.gif) [image2019-1-31\_18-10-57.png](attachments/26313313/26315713.png) (image/png)  
![](images/icons/bullet_blue.gif) [image2019-1-31\_18-12-17.png](attachments/26313313/26315712.png) (image/png)  
![](images/icons/bullet_blue.gif) [image2019-1-31\_18-12-44.png](attachments/26313313/26315702.png) (image/png)  
![](images/icons/bullet_blue.gif) [image2019-1-31\_18-13-12.png](attachments/26313313/26315700.png) (image/png)  
![](images/icons/bullet_blue.gif) [image2020-7-2\_10-57-9.png](attachments/26313313/41517889.png) (image/png)  
![](images/icons/bullet_blue.gif) [image2020-7-2\_11-4-25.png](attachments/26313313/41517890.png) (image/png)  

Document generated by Confluence on 02 June 2025 11:13

[Atlassian](http://www.atlassian.com/)