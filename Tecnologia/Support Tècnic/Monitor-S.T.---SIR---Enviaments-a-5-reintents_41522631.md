Suport Tècnic : Monitor S.T. - SIR - Enviaments a 5 reintents  

1.  [Suport Tècnic](index.md)
2.  [Suport Tècnic](13893782.md)
3.  [03 - Monitorització - Revisions globals](26313327.md)
4.  [Monitors S.T.](Monitors-S.T._41522177.md)
5.  [Monitors S.T. - SIR](Monitors-S.T.---SIR_127598710.md)

Suport Tècnic : Monitor S.T. - SIR - Enviaments a 5 reintents
=============================================================

Created by Unknown User (otecobernal), last modified by Oriol Bernal on 20 March 2024

Què mesura aquest monitor?

El següent monitor conta el nombre de tràmits que no s'han enviat entre una entitat de Catalunya i una entitat de fora, i que es troben a 5 reintents.

**Consulta**
============

* * *

SELECT COUNT(ID) "Enviaments"
  from SIR\_PCI.sir\_intercanvi
 where tipus = 0 -- Enviament
    and estat not in (2, 3, 4, 5) -- confirmat, rebutjat, reenviat, error
    and reintents = 5

**Procediment**
===============

* * *

Si retorna algun resultat haurem de revisar quins són els registres afectats.

Existeix una relació entre la taula SIR\_INTERCANVI i la taula SIR\_APUNT  on es deixen els missatges dels diferents intercanvis realitzats.

*   Si un registre de la taula SIR\_INTERCANVI es troba en estat=5 (error), veurem que a la taula SIR\_APUNT  disposa d'una entrada de tipus=4 on es veu el motiu de l'error:

  

\-- Últim error retornat per cada identificador
 SELECT i.id\_intercanvi, i.id\_sir, a.MISSATGE
 from SIR\_PCI.sir\_intercanvi i, 
   (select a.\* from SIR\_PCI.sir\_apunt a,
           (select id\_intercanvi, max(data) as max\_data
                from SIR\_PCI.sir\_apunt
                where tipus = 4
                group by id\_intercanvi) max\_sales
             where a.id\_intercanvi = max\_sales.id\_intercanvi
             and a.data = max\_sales.max\_data) a
 where i.id = a.id\_intercanvi
    and i.tipus = 0
   and estat not in (2, 3, 4, 5) -- confirmat, rebutjat, reenviat, error
    and reintents = 5
 order by i.id;

![](https://intranet.aoc.cat/download/attachments/41522614/image2021-4-21_9-51-15.png?version=1&modificationDate=1618991475836&api=v2)

Si volem agrupar els missatges per tractar-los i saber quin és l'error que més es repeteix:

\-- Agrupar missatges
SELECT REPLACE(a.missatge, i.id\_sir, ''), count(\*)
 from SIR\_PCI.sir\_intercanvi i, 
   (select a.\* from SIR\_PCI.sir\_apunt a,
           (select id\_intercanvi, max(data) as max\_data
                from SIR\_PCI.sir\_apunt
                where tipus = 4
                group by id\_intercanvi) max\_sales
             where a.id\_intercanvi = max\_sales.id\_intercanvi
             and a.data = max\_sales.max\_data) a
 where i.id = a.id\_intercanvi
    and i.tipus = 0
   and estat not in (2, 3, 4, 5) -- confirmat, rebutjat, reenviat, error
    and reintents = 5
 group by REPLACE(a.missatge, i.id\_sir, '')
 order by count(\*) desc

### 1) Reiniciar els tràmits afectats

update SIR\_PCI.sir\_intercanvi set reintents = 4 where id\_sir = 'ID\_SIR\_INDICAT'

**Informació addicional**
=========================

* * *

### 1) Revisió de logs

  

### 2) Model de dades

#### SIR\_INTERCANVI.TIPUS

Valor

Significat

0

Enviament

1

Recepció

#### SIR\_INTERCANVI.ESTAT

Valor

Significat

0

Pendent d'enviar

1

Pendent de confirmar

2

Confirmat

3

Rebutjat

4

Reenviat

5

Error

#### SIR\_SINCRONITZACIO.OPERACIO

Valor

Significat

0

Pendent de confirmació

1

Confirmar

2

Rebutjat

3

Error

4

Rebut

#### SIR\_APUNT.TIPUS

Valor

Significat

0

Enviament

1

Reenviament

2

Rebuig

3

ACK

4

Error

5

Confirmació

6

Reenviament a inici

Attachments:
------------

![](images/icons/bullet_blue.gif) [cds.gif](attachments/41522631/41522632.gif) (image/gif)  

Document generated by Confluence on 02 June 2025 11:08

[Atlassian](http://www.atlassian.com/)