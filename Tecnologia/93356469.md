Suport Tècnic : MUX v3 - Revisió  

1.  [Suport Tècnic](index.html)
2.  [Suport Tècnic](13893782.html)
3.  [04 - Tècnica de sistemes + 24x7 + Padró](26313202.html)
4.  [Plataformes](Plataformes_41520520.html)
5.  [MUX v3](MUX-v3_93356465.html)

Suport Tècnic : MUX v3 - Revisió
================================

Created by OTEC ST Alessandro Trombin Martinez, last modified on 12 February 2024

IP's Màquines MUX

Les IP's de totes les màquines estan inventariades al Keepass, així com els usuaris i passwords:

![](https://contacte.aoc.cat/secure/attachment/98671/98671_image-2023-06-08-16-45-39-588.png)

  

DEV

![](https://contacte.aoc.cat/secure/attachment/98672/98672_image-2023-06-08-16-46-04-596.png)

  

PRE

![](https://contacte.aoc.cat/secure/attachment/98673/98673_image-2023-06-08-16-46-25-629.png)

  

PRO

![](https://contacte.aoc.cat/secure/attachment/98674/98674_image-2023-06-08-16-46-43-592.png)

Configurar arxiu hosts

Haurem d'editar l'arxiu hosts per garantir l'accés al MUX. Anirem a la següent ruta per trobar l'arxiu _hosts_: 

C:\\Windows\\System32\\drivers\\etc

#Admins MUX3

10.123.80.34 mux-dev.aoc.cat
10.123.69.195 mux-pre.aoc.cat
10.123.7.67 mux.aoc.cat

  

  

Logging

Els logs es desen al filesystem local de cada node, dins de la següent ruta:

/apps/aoc/logs

  

El nom del fitxer de logs inclou l'identificador del node que els produeix, ja que és possible tenir més d'una instància del microservei a cada node. Per a obtenir un llistat dels nodes i els seus identificadors es pot consultar la pàgina 'Discovery' de la consola d'administració del MUX:

https://mux.aoc.cat/admin/discovery

A aquesta pantalla es mostren totes les instàncies que estan corrent actualment al clúster de serveis de MUX:

![](attachments/93356469/100009234.png)

  

Així, basant-nos en la captura de pantalla, els logs dels serveis de transaccions del node 1 (10.123.7.68) tindrien els següents noms:

MUXV3TRANSACCIO\_V1\_13afb09a-5bf7-41ea-be75-5233b6e08d1d.log
MUXV3REGISTRES\_V1\_84506222-6976-42fc-8f2e-1d52d0649c8c.log
MUXV3REGLES\_V1\_bc3903d8-911f-4bd9-881f-8660ebfc94f0.log
MUXV3INDEXERV1\_0f16ca21-f8fe-4fbc-934a-8e98601d253a.log
MUXV3INDEXERV1\_0f16ca21-f8fe-4fbc-934a-8e98601d253a\_CONSOLIDACIO\_ERRORS.log
MUXV3INDEXERV1\_0f16ca21-f8fe-4fbc-934a-8e98601d253a\_INDEXER\_DL\_ERRORS.log
MUXV3INDEXERV1\_0f16ca21-f8fe-4fbc-934a-8e98601d253a\_INDEXER\_V2\_ERRORS.log
MUXV3INDEXERV1\_0f16ca21-f8fe-4fbc-934a-8e98601d253a\_INDEXER\_V3\_ERRORS.log
MUXV3ADMIN\_V1\_fdf18fd8-9c01-4b92-9009-32ae49b475bc.log
MUXV3-BUSTIA\_V1\_04620b4e-5396-4b5e-b34e-34257f699e58.log
MUXV3-BUSTIA-STORAGE\_V1\_ee5e71f2-9f60-4ef4-8b95-935702d48fc6.log
ORGANISMES\_V1\_64e45ecb-dda4-4dde-b224-1ddca02618ca.log
SNOWFLAKE\_V1\_89d48299-97fc-4fa7-b7bb-1a9dc6471ee5.log

  
Els fitxers amb el sufix "\_ERRORS.log" contenen els items que no han pogut ser sincronitzats degut a l'exhauriment del nombre màxim de reintents per a cada operació.

Per buscar aquests errors podem buscar-ho del següent mode, per exemple:

grep MUXV3TRANSACCIO\_V1 \*\*\*\*\*\*\*\*\*\*\*\*.log

  

  

Estat del servei d'indexació

L'estat del servei d'indexació es pot consultar atacant a les següents URLs:

http://10.123.7.68:8100/status

http://10.123.7.76:8100/status

http://10.123.7.77:8100/status

Aquests serveis mostren una sèrie de mètriques que permeten intuir en quin estat es troben els indexadors. Temps màxims exageradament alts (més d'un minut) o temps mitjos alts son indicadors d'un mal funcionament degut al bloqueig de les tasques encarregades de realitzar cadascuna de les funcions de disposició de les dades.

Aquest servei de consulta d'estat també retorna la llista de tasques "al vol" (en execució) en el instant d'invocar-lo. A l'igual que els temps exageradament alts a les mètriques, una llista de tasques exageradament gran o amb temps d'execució alts poden indicar problemes a les comunicacions que fan que aquestes tasques no finalitzin mai.

 A continuació es mostra un exemple de resposta:

{
  "resultat" : "ok",
  "\_instancia" : "0f16ca21-f8fe-4fbc-934a-8e98601d253a",
  "queueInfo" : {
    "mux\_v3\_queue\_index\_dl" : {
      "queueSize" : 0,
      "submitted" : 4605,
      "retries" : 0,
      "successful" : 16326,
      "onFlight" : 0,
      "failed" : 0,
      "totalTime" : 2582493,
      "averageTime" : 560,
      "minTime" : 0,
      "maxTime" : 5233
    },
    "mux\_v3\_queue\_index\_v3" : {
      "queueSize" : 0,
      "submitted" : 4605,
      "retries" : 0,
      "successful" : 16340,
      "onFlight" : 0,
      "failed" : 0,
      "totalTime" : 5650168,
      "averageTime" : 1226,
      "minTime" : 11,
      "maxTime" : 6717
    },
    "mux\_v3\_queue\_index\_v2" : {
      "queueSize" : 0,
      "submitted" : 4605,
      "retries" : 0,
      "successful" : 20619,
      "onFlight" : 0,
      "failed" : 0,
      "totalTime" : 126686682,
      "averageTime" : 27510,
      "minTime" : 11,
      "maxTime" : 51439
    },
    "mux\_v3\_indexer\_queue" : {
      "queueSize" : 0,
      "submitted" : 4625,
      "retries" : 0,
      "successful" : 4625,
      "onFlight" : 0,
      "failed" : 0,
      "totalTime" : 11726,
      "averageTime" : 2,
      "minTime" : 0,
      "maxTime" : 898
    },
    "mux\_v3\_queue\_consolidacio\_eacat" : {
      "queueSize" : 0,
      "submitted" : 4617,
      "retries" : 12,
      "successful" : 15455,
      "onFlight" : 0,
      "failed" : 12,
      "totalTime" : 4237048,
      "averageTime" : 917,
      "minTime" : 0,
      "maxTime" : 10631
    }
  }
} 

  

Per analitzar aquesta resposta aquí tenim els conceptes claus per determinar el funcionament adequat del servei:

*   "queueSize" : Nombre de tasques pendents de tractar. Numero >> 0 al llarg del temps indica que els processos que tracten les tasques s'han mort i cal reiniciar el microservei d'indexació.
*   "submitted" : Total de tasques processades fins al moment.

*   "retries" : Nombre total de reintents d'execució d'aquesta tasca acumulat. Un valor molt alt indica que els serveis als que invoca la tasca (consolidacio eacat, sincro de xml o elasticsearch) estan donant problemes, per lo que caldria inspeccionar els logs i decidir si hi ha un problema de xarxa, si és algun d'aquests serveis externs que té problemes o si cal reiniciar el servei d'indexació.

*   "successful" : Total de tasques processades correctament.

*   "onFlight" : Tasques en execució en el instant. Dóna una idea del grau de paralel·lisme per a la tasca. Normalment aquest numero ha de ser baix. Quan les tasques es queden encallades, per problemes de xarxa com hi ha hagut al maig i fa uns dies, aqust nombre puja donat que les tasques no finalitzen mai i se'n van obrint de noves fins que s'esgota el nombre de threads del pool.

*   "failed" : Numero de tasques finalitzades en error. Indica quantes execucions han fallat al rebre una resposta d'error del servei extern invocat (consolidació eacat, sincro xml, elasticsearch).

*   "totalTime" : Sumatori de tots els temps d'execució de totes les tasques llançades fins al moment. Aquest paràmetre NO és massa rellevant donat que un sumatori sempre tindrà un valor cada cop més alt amb el pas del temps.

*   "averageTime": Temps mig d'execució de les tasques. Un temps alt a aquest valor indica que la majoria de tasques estan tenint latències molt altes, pel que és recomanable  revisar si s'estan produïnt problemes de xarxa o de computació als serveis implicats (propi servei d'indexació del mux, elasticsearch, consolidacio eacat, sincro xml...).

*   "minTime" : Temps mínim d'execució. Poc rellevant en el sentit que sempre tindrà el mateix valor, tot i que el microservei hagi pogut degradar.

*   "maxTime" : Temps màxim d'execució d'una tasca. Un temps molt alt en aquest camp és un clar indicador de problemes al servei d'indexació.
    *   Tots els serveis tenen timeouts de xarxa d'uns 15/20 segons.
    *   La tasca d'indexat V2 encadena tres subtasques (Indexat Elasticsearch missatgeria V2, Sincronització XML i Consolidació EACAT).
    *   Per tant, 15|20x3 = 45|60 segons hauria de ser el temps màxim que veieu mai per a aquestes tasques.
    *   Un valor superior a 60000 mil·lisegons és un indicador més que probable de que hi ha problemes de xarxa que estan causant que les execucions es quedin "enganxades" i es recomana en aquest cas revisar els logs del servei d'indexació, verificar l'estat de la xarxa i reiniciar el servei d'indexació.
    *   A l'exemple, si us fixeu, el temps màxim és de 51439ms. És un temps que tot i ser alt, és "normal". Valors més grans, 60, 90, 200 segons ja us han de fer saltar l'alarma.

  

  

  

  

Attachments:
------------

![](images/icons/bullet_blue.gif) [image2024-2-12\_16-38-1.png](attachments/93356469/100009234.png) (image/png)  

Document generated by Confluence on 02 June 2025 11:16

[Atlassian](http://www.atlassian.com/)