Suport T√®cnic : Monitor S.T. - SIR - Enviaments del SIR que no hem rebut l'ACK  

1.  [Suport T√®cnic](index.html)
2.  [Suport T√®cnic](13893782.html)
3.  [03 - Monitoritzaci√≥ - Revisions globals](26313327.html)
4.  [Monitors S.T.](Monitors-S.T._41522177.html)
5.  [Monitors S.T. - SIR](Monitors-S.T.---SIR_127598710.html)

Suport T√®cnic : Monitor S.T. - SIR - Enviaments del SIR que no hem rebut l'ACK
==============================================================================

Created by Unknown User (otecobernal), last modified by Oriol Bernal on 31 March 2025

Qu√® mesura aquest monitor?

El seg√ºent monitor conta el nombre de tr√†mits que s'han enviat des de Catalunya, per√≤ que no hem rebut l'ACK del receptor, i per tant, els funcionaris receptors no el podran acceptar, ja que segurament no existir√† a la seva plataforma.

**Consulta**
============

* * *

  

**Comptador de tr√†mits:**

SELECT COUNT(ID) "Enviaments"
  FROM SIR\_PCI.SIR\_INTERCANVI 
   WHERE tipus = 0 -- Enviament
   AND estat = 1 -- Pendent de confirmar
   AND id NOT IN (
       SELECT i.id FROM SIR\_PCI.SIR\_INTERCANVI i, SIR\_PCI.SIR\_APUNT a
         WHERE a.id\_intercanvi = i.id
        AND i.tipus = 0 -- Enviament
        AND a.tipus = 3 -- ACK
    )
    AND data\_actualitzacio < SYSDATE - INTERVAL '120' MINUTE -- 2 hores
    AND data\_actualitzacio > SYSDATE - INTERVAL '10' DAY -- 10 dies

**Detall dels tr√†mits afectats:**

SELECT \*
  FROM SIR\_PCI.SIR\_INTERCANVI 
   WHERE tipus = 0 -- Enviament
   AND estat = 1 -- Pendent de confirmar
   AND id NOT IN (
       SELECT i.id FROM SIR\_PCI.SIR\_INTERCANVI i, SIR\_PCI.SIR\_APUNT a
         WHERE a.id\_intercanvi = i.id
        AND i.tipus = 0 -- Enviament
        AND a.tipus = 3 -- ACK
    )
    AND data\_actualitzacio < SYSDATE - INTERVAL '120' MINUTE -- 2 hores
    AND data\_actualitzacio > SYSDATE - INTERVAL '10' DAY -- 10 dies

**Procediment**
===============

* * *

1) Reiniciar els enviaments afectats

Haurem de reintentar l'enviament i esperar uns segons per veure si el tr√†mit es processa i rebem l'ACK:

UPDATE SIR\_INTERCANVI
    SET estat = 0
 WHERE tipus = 0 -- enviament
   AND estat = 1 -- pendent confirmar
   AND id NOT IN (
       SELECT i.id FROM SIR\_PCI.SIR\_INTERCANVI i, SIR\_PCI.SIR\_APUNT a
         WHERE a.id\_intercanvi = i.id
        AND i.tipus = 0 -- Enviament
        AND a.tipus = 3 -- ACK
    )   
    AND data\_actualitzacio < SYSDATE - INTERVAL '120' MINUTE -- 2 hores
    AND data\_actualitzacio > SYSDATE - INTERVAL '10' DAY -- 10 dies

**2) Revisar les oficines de dest√≠ afectades**

Si despr√©s de reiniciar els enviaments afectats, encara no obtenim els ACK's corresponents, haurem de reportar-ho als t√®cnics del MINHAP. Podem fer una extracci√≥ de les oficines de dest√≠ afectades que no estan enviant l'ACK:

SELECT oficina\_desti, count(\*)
  FROM SIR\_PCI.SIR\_INTERCANVI 
   WHERE tipus = 0 -- Enviament
   AND estat = 1 -- Pendent de Confirmar
   AND id NOT IN (
       SELECT i.id FROM SIR\_PCI.SIR\_INTERCANVI i, SIR\_PCI.SIR\_APUNT a
         WHERE a.id\_intercanvi = i.id
        AND i.tipus = 0 -- Enviament
        AND a.tipus = 3 -- ACK
    )   
    AND data\_actualitzacio < SYSDATE - INTERVAL '120' MINUTE -- 2 hores
    AND data\_actualitzacio > SYSDATE - INTERVAL '10' DAY -- 10 dies
    GROUP BY oficina\_desti
    ORDER BY count(\*) desc

Tamb√© podem revisar per cada oficina afectada, quan ha sigut l'√∫ltim ACK que han enviat, ja que si ha sigut fa temps, potser tenen un problema, per√≤ si han enviat ACK's fa poc, podem tornar a reintentar per veure si la seva aplicaci√≥ ho processa:

SELECT \* FROM SIR\_PCI.SIR\_INTERCANVI i, SIR\_PCI.SIR\_APUNT a
WHERE a.id\_intercanvi = i.id
AND i.tipus = 0 -- Enviament
AND a.tipus = 3 -- ACK
AND i.oficina\_desti = 'O00005633'
ORDER BY i.data DESC

Si tenim moltes oficines afectades, podem extreure la informaci√≥ de cop üëå:

SELECT oficines\_problemes.\*, ultim\_ack.data "√∫ltim ACK" FROM (
    -- Oficines de dest√≠ a les quals no podem enviar tr√†mits (no rebem l'ACK)
    SELECT oficina\_desti, count(\*) as tramits
        FROM SIR\_PCI.SIR\_INTERCANVI
       WHERE tipus = 0
         AND estat = 1
         AND id NOT IN (SELECT i.id FROM SIR\_PCI.SIR\_INTERCANVI i, SIR\_PCI.SIR\_APUNT a
                         WHERE a.id\_intercanvi = i.id
                           AND i.tipus = 0
                           AND a.tipus = 3)
         AND data\_actualitzacio < SYSDATE - INTERVAL '120' MINUTE
         AND data\_actualitzacio > SYSDATE - INTERVAL '10' DAY
       GROUP BY oficina\_desti
       ORDER BY count(\*) DESC
) oficines\_problemes
JOIN (
   -- √öltim ack retornat per cada oficina
   SELECT i.oficina\_desti, MAX(ultim\_apunt.data) as data
     FROM SIR\_PCI.SIR\_INTERCANVI i
     JOIN (
       SELECT a.\*
         FROM SIR\_PCI.SIR\_APUNT a
         JOIN (
           SELECT id\_intercanvi, MAX(data) as max\_data
             FROM SIR\_PCI.SIR\_APUNT
            GROUP BY id\_intercanvi
         ) ultima\_data
         ON a.id\_intercanvi = ultima\_data.id\_intercanvi
         AND a.data = ultima\_data.max\_data
         AND a.tipus = 3
     ) ultim\_apunt
     ON i.id = ultim\_apunt.id\_intercanvi
     AND i.tipus = 0
   GROUP BY i.oficina\_desti
) ultim\_ack
ON oficines\_problemes.oficina\_desti = ultim\_ack.oficina\_desti
ORDER BY oficines\_problemes.tramits DESC;

**3) Revisa tr√†mits per any**

SELECT EXTRACT(YEAR FROM data), COUNT(\*)
  FROM SIR\_PCI.SIR\_INTERCANVI
   WHERE tipus = 0 -- Enviament
   AND estat = 1 -- Pendent de confirmar
   AND id NOT IN (
       SELECT i.id FROM SIR\_PCI.SIR\_INTERCANVI i, SIR\_PCI.SIR\_APUNT a
         WHERE a.id\_intercanvi = i.id
        AND i.tipus = 0 -- Enviament
        AND a.tipus = 3 -- ACK
    )
GROUP BY EXTRACT(YEAR FROM data)
ORDER BY EXTRACT(YEAR FROM data) desc

**Informaci√≥ addicional**
=========================

* * *

### 1) RDBMS

Aquest monitor pot estar afectat per la cua de l'[RDBMS](http://10.120.1.163:7001/pci3-rdbmseg-admin/)¬† SIR-ENVIAMENT

SELECT COUNT(ID) FROM SIR\_INTERCANVI WHERE ESTAT=0 AND REINTENTS < 5

Despr√©s de reiniciar els enviaments, haurem d'esperar que es processin.

### 2) Revisi√≥ de logs

**Portlet**: A¬†cada node del pl6, ja que no hi ha NFS:

cd¬†/apps/tomcat//logs
grep¬†"O00006336\_21\_00001699"¬†EACATPL-SIR.log.\* |¬†grep¬†ENVIA

**Core**: Des de qualsevol node:

cd¬†/apps/aoc/APP/logs
grep¬†"EACATSIR-ENVIAMENT-1620718132449"¬†MC-SIR\_APPNODO?\_SOA.log.2021-05-11

### 3) Model de dades

#### **SIR\_PCI**

#### SIR\_INTERCANVI.TIPUS

Valor

Significat

0

Enviament

1

Recepci√≥

#### SIR\_INTERCANVI.ESTAT

Valor

Significat

0

Pendent d'enviar

1

Pendent de confirmar

2

Confirmat

3

Rebutjat

4

Reenviat

5

Error

#### SIR\_SINCRONITZACIO.OPERACIO

Valor

Significat

0

Pendent de confirmaci√≥

1

Confirmar

2

Rebutjat

3

Error

4

Rebut

#### SIR\_APUNT.TIPUS

Valor

Significat

0

Enviament

1

Reenviament

2

Rebuig

3

ACK

4

Error

5

Confirmaci√≥

6

Reenviament a inici

  

Attachments:
------------

![](images/icons/bullet_blue.gif) [cds.gif](attachments/77824460/77824461.gif) (image/gif)  
![](images/icons/bullet_blue.gif) [image2021-5-26\_13-6-44.png](attachments/77824460/100008532.png) (image/png)  

Document generated by Confluence on 02 June 2025 11:08

[Atlassian](http://www.atlassian.com/)