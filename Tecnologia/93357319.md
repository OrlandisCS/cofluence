Suport Tècnic : Creació de certificats SSL amb Let's Encrypt  

1.  [Suport Tècnic](index.html)
2.  [Suport Tècnic](13893782.html)
3.  [01 - Gestió Operativa](26313391.html)
4.  [Tasques complementàries](26313409.html)

Suport Tècnic : Creació de certificats SSL amb Let's Encrypt
============================================================

Created by Oriol Bernal, last modified on 19 October 2023

**Let's Encrypt** és una Autoritat de Certificació (**AC** o **CA**) que proporciona certificats **SSL/TLS** gratuïts i automatitzats per a habilitar la comunicació segura en llocs web. 

Per què utilitzar **Let's Encrypt** en comptes d'un altre proveïdor?

1.  **Automatització i Renovació**: Let's Encrypt ofereix un procés d'emissió de certificats completament **automatitzat**. A més, els certificats tenen una validesa de 90 dies, per la qual cosa és essencial configurar la renovació automàtica per a garantir que els certificats estiguin sempre actualitzats i en vigència.
2.  **Benefici econòmic**: Let's Encrypt proporciona certificats de manera **gratuïta**, la qual cosa ajuda a reduir els costos associats amb l'adquisició de certificats SSL/TLS tradicionals.

En resum, configurar Let's Encrypt en un servidor és essencial per a garantir la seguretat, l'autenticitat i la confiança en la comunicació en línia, al mateix temps que millora l'experiència de l'usuari i ajuda a mantenir una reputació positiva en la web.

  

En el següent document s'explica com configurar un entorn per poder crear i renovar diferents certificats de **Let's Encrypt** utilitzant un procés **automatitzat** o **manual**.

Aquest document pretén ser una guia d'exemple per entendre com s'ha configurat aquesta eina a l'AOC, però el mateix software ja proporciona una documentació molt detallada sobre com procedir tant per instal·lar-ho com per generar els certificats després:

*   Let's Encrypt (Pàgina oficial): [https://letsencrypt.org/es/](https://letsencrypt.org/es/)
*   Certbot (Client ACME oficial): [https://certbot.eff.org/](https://certbot.eff.org/)

Configuració de Let's Encrypt
=============================

Let’s Encrypt usa el protocol **ACME** per a verificar que controles un nom de domini determinat i per a emetre un certificat. A l'AOC s'utilitza el client oficial que el mateix Let's Encrypt proporciona: [https://certbot.eff.org/](https://certbot.eff.org/)

El client es pot configurar per ser emprat amb diferents softwares i diferents sistemes operatius. Haurem d'anar amb cura de seleccionar el que toca:

![](attachments/93357319/93357343.png)

La mateixa pàgina oficial ja proporciona les comandes necessàries per instal·lar el programari un cop seleccionat tant el tipus de servidor web com el tipus de sistema operatiu.

Descarregar software WIN-ACME per generar el certificat
-------------------------------------------------------

1.  Descarregar el client [win-acme](https://www.win-acme.com/)  
    ![](attachments/93357319/93357341.png)
2.  Desar el fitxer i descomprimir-lo al directori desitjat
3.  Executar el fitxer `wacs.exe`.  
    ![](attachments/93357319/93357342.png)

Creació d'un certificat amb Let's Encrypt
=========================================

### 1.Crear el directori per la confirmació del domini per part de LE

Sobre la ruta **/apps/aoc/httpd/docroot/** crear el path **<nomAplicacio>/.well-known/acme-challenge**

En el següent exemple, **<nomAplicacio>** serà **enotum**.

cd /apps/aoc/httpd/docroot/
mkdir enotum
cd enotum/
mkdir .well-known
cd .well-known/
mkdir acme-challenge
cd acme-challenge/

Si executem la comanda **_pwd_** haurem de veure el resultat:  _**/apps/aoc/httpd/docroot/enotum/.well-known/acme-challenge**_

### 2.Configurar el DocumentRoot per accedir al challenge

Haurem de localitzar el fitxer de configuració HTTP del nostre apache, normalment: /apps/aoc/httpd/**<nomDomini>**.conf.nfs

En el següent exemple, **<nomDomini>** serà **usuari-pre.enotum.cat**.

Fer un backup del fitxer abans d'editar-lo.

cp /apps/aoc/httpd/usuari-pre.enotum.cat.conf.nfs /apps/aoc/httpd/backup/

vi /apps/aoc/httpd/usuari-pre.enotum.cat.conf.nfs

  

ServerName usuari-pre.enotum.cat
RewriteEngine On

##########################################
######  Configuracio Let's Encrypt #######
##########################################
DocumentRoot /apps/aoc/httpd/docroot/enotum

<Directory /apps/aoc/httpd/docroot/enotum/.well-known/acme-challenge/>
        Order Allow,Deny
        Allow from All
</Directory>

<Location /.well-known/acme-challenge>
   Require all granted
</Location>

# Excloure les sol·licituds a ".well-known/acme-challenge/"
RewriteRule ^/.well-known/acme-challenge/ - \[L\]
##########################################
########### END Let's Enctrpy ############
##########################################

Un cop configurat, haurem de reiniciar l'apache:

sudo apachectl configtest
sudo apachectl restart

### 3.Comprovar el funcionament del Challenge

Per a fer-ho copiem un fitxer qualsevol amb text (p.e hola.txt amb "Hello world" a dins) i el copiem a la ruta configurada **<nomAplicacio>/.well-known/acme-challenge** 

cd /apps/aoc/httpd/docroot/enotum/.well-known/acme-challenge
echo 'Hello world' > hola.txt

Després podrem validar-ho realitzant una crida HTTP (GET) contra **http://<nomDomini>/.well-known/acme-challenge/hola.txt** i comprovem que podem accedir al contingut.

### 4.Executar la renovació del certificat en mode DRY-RUN 

Let's Encrypt té una política de reintents de renovació de certificats molt estricta. Si la renovació falla, no podem provar-ho infinits cops, ja que ens poden afegir a una blacklist i bloquejar-nos.

Això no obstant, ens ofereix la possibilitat de provar les renovacions sense realment crear el certificat, sinó simplement validant les diferents tasques que el client ACME realitzarà.

⚠️ Per fer-ho haurem d'utilitzar l'opció **_\--dry-run_**

sudo certbot certonly --dry-run --keep-until-expiring -n --webroot -w /apps/aoc/httpd/docroot/enotum -v -d usuari-pre.enotum.cat

El resultat:

Saving debug log to /var/log/letsencrypt/letsencrypt.log
Plugins selected: Authenticator webroot, Installer None
Simulating a certificate request for usuari-pre.enotum.cat
Performing the following challenges:
http-01 challenge for usuari-pre.enotum.cat
Using the webroot path /apps/aoc/httpd/docroot/enotum for all unmatched domains.
Waiting for verification...
Cleaning up challenges
The dry run was successful.

### 5.Editar l'script de renovació

Al node1 existeix una tasca programada amb crontab, que s'executa cada dimecres a les 04:00. Aquesta s'encarregarà de renovar el certificat (o crear-lo de 0 si és el primer cop) i desar el fitxers resultants a **/apps/aoc/httpd/ssl/CDS/letsencrypt/live/<nomDomini>/**

⚠️ Aquest cop, **no** haurem d'indicar l'opció **_\--dry-run_**

vi /apps/aoc/httpd/ssl/CDS/letsencrypt/crontabs/aoc-l-http01-pre.sh

Copiar la comanda a dins de l'script:

sudo certbot certonly --keep-until-expiring -n --webroot -w /apps/aoc/httpd/docroot/enotum -v -d usuari-pre.enotum.cat

La renovació només s'executa al node1 del servidor, ja que desarà els fitxers resultants al NFS, on el node2 també té accés.

L'script que acabem d'editar renova els certificats configurats i després reinicia l'apache per aplicar els canvis. Al node2 existeix el mateix cron, però no executa les tasques de renovació amb Let's Encrypt, simplement s'executa cada dimecres a les 04:05 i reinicia l'apache.

### 6.Configurar el certificat a l'apache

Aquest apartat només s'ha de realitzar el primer cop que es configura el certificat amb LE.

Trobarem l'arxiu de configuració (SSL) de l'apache a **/apps/aoc/httpd/ssl/<nomDomini>.nfs.conf** i el certbot haurà generat el certificat a **/apps/aoc/httpd/ssl/CDS/letsencrypt/live/<nomDomini>/**

Per tant, haurem de configurar el següent:

SSLCertificateFile /apps/aoc/httpd/ssl/CDS/letsencrypt/live/usuari-pre.enotum.cat/cert.pem
SSLCertificateKeyFile /apps/aoc/httpd/ssl/CDS/letsencrypt/live/usuari-pre.enotum.cat/privkey.pem
SSLCertificateChainFile /apps/aoc/httpd/ssl/CDS/letsencrypt/live/usuari-pre.enotum.cat/fullchain.pem

  

  

### **Preparar el servidor per connectar amb WIN-ACME**

1.  Connectar-nos als nodes on tenim el domini aixecat (PRE)  
    
    Servidors 
    ==========
    
    *   Node1: **aoc-l-http01-pro → 10.120.55.130 [](https://pam.aoc.cat/SecretServer/app/#/secrets/4331/general)** 
        
    *   Node2: **aoc-l-http02-pro** **→ 10.120.55.131 [](https://pam.aoc.cat/SecretServer/app/#/secrets/4332/general)** 
    *   User: **aoc**
    
    *   Node1: **aoc-l-http01-pre** **→ 10.120.2.153 [](https://pam.aoc.cat/SecretServer/app/#/secrets/4329/general)** 
        
    *   Node2: **aoc-l-http02-pre** **→ 10.120.2.154 [](https://pam.aoc.cat/SecretServer/app/#/secrets/4330/general)** 
    *   User: **aoc**
    
2.  Fer un backup manual dels arxius de configuració:  
    ![](attachments/93357319/93357320.png)
    
3.  Canviar els arxius de configuració SSL:
    
    cd /mnt/storage30/aoc/httpd/ssl
    cp signasuite-pre.aoc.cat.ssl.conf.nfs signasuite-pre.aoc.cat.ssl.conf.nfs.BACKUP\_LE\_GENERATION
    cp signasuite-pre.aoc.cat.ssl.conf.nfs.letsencrypt signasuite-pre.aoc.cat.ssl.conf.nfs
    
4.  Aplicar els canvis:
    
    sudo apachectl configtest
    sudo apachectl restart
    
5.  Obrir els logs en temps real:
    
    tail -f /mnt/lhnfslogpre/aoc-l-http0?-pre/apache-logs/signasuite-pre.cat/signasuite-pre.aoc.cat-ssl-access.20220607.log | grep -i 'acme'
    
6.  Repetir el mateix procés pels altres nodes:
    
    Rutes compartides
    
    En cas que la ruta dels fitxers estigui compartida, només caldrà repetir la passa 4 per sincronitzar la nova configuració als altres apaches.
    

### **Generar les claus**

1.  Executar el fitxer **`wacs.exe`**  
    ![](attachments/93357319/93357321.png)  
    
2.  Seleccionar l'opció **N: Create certificate (default settings)**  
    ![](attachments/93357319/93357322.png)
3.  Seleccionar l'opció **2: Manual input**  
    ![](attachments/93357319/93357323.png)
4.  Introduir el nom del domini del certificat: **signasuite-pre.aoc.cat  
    ![](attachments/93357319/93357324.png)  
    **
5.  Seleccionar l'opció **4: \[http-01\] Upload verification files via SSH-FTP  
    ![](attachments/93357319/93357325.png)**
6.  Indicar la connexió SFTP a un dels nodes: [sftp://10.120.2.153:22/apps/aoc/httpd/docroot/](sftp://10.120.2.153:22/apps/aoc/httpd/docroot/)  
    ![](attachments/93357319/93357326.png)
7.  Copiar la configuració per defecte ![(thumbs up)](images/icons/emoticons/thumbs_up.svg)  
    ![](attachments/93357319/93357327.png)
8.  Indicar l'usuari de l'SFTP: **aoc  
    ![](attachments/93357319/93357328.png)  
    **
9.  Seleccionar la manera d'introduir la paraula de pas per connectar-se a l'SFTP: **2: Type/paste in console** i indicar la paraula de pas (Info del Keepass):  
    ![](attachments/93357319/93357329.png)![](attachments/93357319/93357330.png)
10.  Si és el primer cop que ho realitzem, podem desar la configuració per reutilitzar-la en un futur:  
    ![](attachments/93357319/93357331.png)
11.  Seleccionar l'opció **2: PEM encoded files (Apache, nginx, etc.)**  
    ![](attachments/93357319/93357332.png)
12.  Seleccionar el directori en local on desar els fitxers  
    ![](attachments/93357319/93357333.png)
13.  Seleccionar l'opció **1: None**  
    ![](attachments/93357319/93357334.png)
14.  Seleccionar l'opció **3: No (additional) installation steps**  
    ![](attachments/93357319/93357335.png)
15.  El programari win-acme generarà el certificat i el desarà a la ruta local que li hem indicat:  
    ![](attachments/93357319/93357336.png)

  

### Restaurar la configuració SSL inicial del servidor

1.  Canviar els arxius de configuració SSL
    
    cd /mnt/storage30/aoc/httpd/ssl
    cp signasuite-pre.aoc.cat.ssl.conf.nfs.BACKUP\_LE\_GENERATION signasuite-pre.aoc.cat.ssl.conf.nfs
    
2.  Aplicar els canvis
    
    sudo apachectl configtest
    sudo apachectl restart
    
3.  Repetir-ho pels altres nodes
    
    Rutes compartides
    
    En cas que la ruta dels fitxers estigui compartida, només caldrà repetir la passa 4 per sincronitzar la nova configuració als altres apaches.
    

### **Instal·lar les claus**

1.  Modificar el fitxer /mnt/storage30/aoc/httpd/ssl/signasuite-pre.aoc.cat.ssl.conf.nfs  
    ![](attachments/93357319/93357337.png)
2.  Haurem de pujar les claus generades al servidor i canviar-les al fitxer de configuració esmentat (Fer backup abans)
3.  Revisar la configuració i fer un graceful:
    
    sudo apachectl configtest
    sudo apachectl graceful
    

### **Comprovar la instal·lació**

1.  Accedir a [https://signasuite-pre.aoc.cat/signasuite/inici](https://signasuite-pre.aoc.cat/signasuite/inici)
2.  Revisar que la web carrega amb el nou certificat:  
    ![](attachments/93357319/93357338.png)![](attachments/93357319/93357339.png)![](attachments/93357319/93357340.png)

Attachments:
------------

![](images/icons/bullet_blue.gif) [image2022-6-7\_12-44-57.png](attachments/93357319/93357320.png) (image/png)  
![](images/icons/bullet_blue.gif) [image2022-6-7\_12-28-30.png](attachments/93357319/93357321.png) (image/png)  
![](images/icons/bullet_blue.gif) [image2022-6-7\_12-29-40.png](attachments/93357319/93357322.png) (image/png)  
![](images/icons/bullet_blue.gif) [image2022-6-7\_12-30-22.png](attachments/93357319/93357323.png) (image/png)  
![](images/icons/bullet_blue.gif) [image2022-6-7\_12-31-30.png](attachments/93357319/93357324.png) (image/png)  
![](images/icons/bullet_blue.gif) [image2022-6-17\_12-13-53.png](attachments/93357319/93357325.png) (image/png)  
![](images/icons/bullet_blue.gif) [image2022-6-17\_12-33-45.png](attachments/93357319/93357326.png) (image/png)  
![](images/icons/bullet_blue.gif) [image2022-6-17\_12-16-31.png](attachments/93357319/93357327.png) (image/png)  
![](images/icons/bullet_blue.gif) [image2022-6-17\_12-17-10.png](attachments/93357319/93357328.png) (image/png)  
![](images/icons/bullet_blue.gif) [image2022-6-17\_12-19-8.png](attachments/93357319/93357329.png) (image/png)  
![](images/icons/bullet_blue.gif) [image2022-6-17\_12-19-33.png](attachments/93357319/93357330.png) (image/png)  
![](images/icons/bullet_blue.gif) [image2022-6-17\_12-23-22.png](attachments/93357319/93357331.png) (image/png)  
![](images/icons/bullet_blue.gif) [image2022-6-7\_12-57-47.png](attachments/93357319/93357332.png) (image/png)  
![](images/icons/bullet_blue.gif) [image2022-6-7\_12-58-33.png](attachments/93357319/93357333.png) (image/png)  
![](images/icons/bullet_blue.gif) [image2022-6-7\_12-58-56.png](attachments/93357319/93357334.png) (image/png)  
![](images/icons/bullet_blue.gif) [image2022-6-7\_12-59-27.png](attachments/93357319/93357335.png) (image/png)  
![](images/icons/bullet_blue.gif) [image2022-6-17\_12-26-29.png](attachments/93357319/93357336.png) (image/png)  
![](images/icons/bullet_blue.gif) [image2022-6-7\_13-11-54.png](attachments/93357319/93357337.png) (image/png)  
![](images/icons/bullet_blue.gif) [image2022-6-17\_12-30-33.png](attachments/93357319/93357338.png) (image/png)  
![](images/icons/bullet_blue.gif) [image2022-6-17\_12-30-38.png](attachments/93357319/93357339.png) (image/png)  
![](images/icons/bullet_blue.gif) [image2022-6-17\_12-30-43.png](attachments/93357319/93357340.png) (image/png)  
![](images/icons/bullet_blue.gif) [image2022-6-3\_11-9-20.png](attachments/93357319/93357341.png) (image/png)  
![](images/icons/bullet_blue.gif) [image2022-6-7\_13-5-17.png](attachments/93357319/93357342.png) (image/png)  
![](images/icons/bullet_blue.gif) [image2023-9-22\_14-48-54.png](attachments/93357319/93357343.png) (image/png)  

Document generated by Confluence on 02 June 2025 10:47

[Atlassian](http://www.atlassian.com/)