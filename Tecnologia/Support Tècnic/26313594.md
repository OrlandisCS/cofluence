Suport Tècnic : VALID - INTEGRACIÓ - Integració amb el servei  

1.  [Suport Tècnic](index.md)
2.  [Suport Tècnic](13893782.md)
3.  [02 - FAQ's serveis](26313393.md)
4.  [FAQ's VALID](28705603.md)

Suport Tècnic : VALID - INTEGRACIÓ - Integració amb el servei
=============================================================

Created by Unknown User (rjuradog), last modified by Unknown User (otecjcolomer) on 14 December 2022

  

PAS 0: Missatges que indiquem a l'usuari.
-----------------------------------------

1.  **Missatges generals**
    
    Podrem troba els missatges per demanar informació a l'apartat d'[altes global](/pages/createpage.action?spaceKey=SII&title=GLOBAL+-+INTEGRACI%C3%93+-+Altes+de+Serveis&linkCreation=true&fromPageId=26313594).
    

PAS 1: Enviar la plantilla amb la documentació.
-----------------------------------------------

1.  Enviar la plantilla amb la documentació i l'Excel perquè l'usuari ho empleni amb les dades necessàries per realitzar l'alta.
    1.  Ruta excel: (Sharepoint) Tecnologia - SUPORT\_TECNIC\\SERVEIS\\Valid\_idCATSMS_\\01 Integració\\01 Documentació Funcional\\Altes\\mail informacio\\Broker.xlsx_
    2.  Ruta documentació: (Sharepoint) Tecnologia - SUPORT\_TECNIC\\SERVEIS\\Valid\_idCATSMS_\\01 Integració\\01 Documentació Funcional\\Altes\\mail informacio\\DI - VALid.pdf_
    3.  Missatge tipus:
        
        Benvolguts,
        
        Us avancem l’actual versió del document d’integració amb el validador OAuth (**_DI – VALId_**) de cara a que pugueu començar a donar-li una ullada.
        
        També adjuntem un Excel (**Broker.xlsx**) on ens podreu detallar les dades per a la vostra integració OAuth i poder-vos generar la clau compartida.
        
        Atentament
        
        .rwui\_text\_box.rwui\_id\_2d15d2c0-13cb-456a-9ee5-590d0de4a3a3 {background-color: #F2F2F2; color: #666666;}.rwui\_text\_box.rwui\_id\_2d15d2c0-13cb-456a-9ee5-590d0de4a3a3 \*:not(.rwui\_content) {color: #666666;}.rwui\_text\_box.rwui\_id\_2d15d2c0-13cb-456a-9ee5-590d0de4a3a3 span.rwui\_icon {color: #666666;}
        
    4.  Quan ens contesten amb l’Excel omplert haurem de canviar-li el nom a **Broker-nomEntitat** i fixar-nos si té les dades “redirect\_uri” + “IP”:

PAS 2: Configuració IPs - PRO.
------------------------------

La configuració d'IPs només a PRO perquè per Valid està permès l'accés a tothom a PRE

1.  Maquines: **10.124.70.8** i **10.124.70.9 MAQUINES VÀLid Aïllat \-** S'han de configurar les maquines si no les tenim, les credencials les podem trobar al KeePass  
    ![](attachments/26313594/26314109.png) → Usuari: aoc  
      
    
2.  Realitzar còpia de seguretat del fitxer de configuració. Ruta del fitxer per configurar les Ips: _/apps/aoc/httpd/ssl/identitats.aoc.cat.ssl.conf.nfs_
    
    cp /apps/aoc/httpd/ssl/identitats.aoc.cat.ssl.conf.nfs /apps/aoc/httpd/ssl/BACKUPs/identitats.aoc.cat.ssl.conf.nfs.20XXXXXX
    
    **_Nota_**_: on posa XXXXXX ho substituirem per la data del dia, per exemple 20181030_
    
3.  Un cop fet el backup ja podem afegir les IP's. Identifiquem el bloc on afegir les IP's.
    
    VALid
    
    **_<Location "/serveis-rest/">_**
    
      
    
    1.  Primer de tot comprovarem que les IP's que volem afegir no estiguin configurades.
        
    2.  Si les IP's no estan afegides, les podrem afegir.
    
      
    
4.  Revisar la sintaxi.
    
    sudo /etc/init.d/httpd configtest
    
    **Si la sintaxi és correcta, apareixerà un missatge com el següent:**
    
    ![](attachments/26313594/26314135.png)  
      
    
5.  Si hem realitzat algun canvi, haurem de crear un JIRA per avisar a sistemes del graceful que realitzarem. Exemple → _[https://contacte.aoc.cat/browse/DES-659](https://contacte.aoc.cat/browse/DES-659)_
    
    Finalment fem el graceful **de tots els nodes**:
    
    sudo /etc/init.d/httpd graceful
    
    IP's ja afegides
    
    Si les IP's ja estaven afegides, no haurem de realitzar cap mena de modificació i no farà falta realitzar graceful.
    
6.  Comprovar que el graceful s'ha realitzat correctament. Finalment comprovarem que el servidor que hem reiniciat torna a estar en marxa (mirant l’hora)
    
    ps -axu | grep apache
    
    Revisió extra:
    
    telnet localhost 80
    telnet localhost 443
    
7.  Repetir a partir del pas 5 per al node 2.
    

Si les IPS no estan ben configurades, el procés d'obtenció del TOKEN el podran obtenir correctament (Ex.  [https://identitats.aoc.cat/o/oauth2/token](https://identitats.aoc.cat/o/oauth2/token)), però els pròxims passos que són per invocar serveis rest a la URL (EX. [https://identitats.aoc.cat/**serveis-rest**/getUserInfo](https://identitats.aoc.cat/serveis-rest/getUserInfo) ) retornarà un error possiblement amb un html, el quan no definirà l'error 403 d'IP's. Per això, haurem de tenir en compte que si no es passa de pas de l'obtenció del token, serà per temes d'IP.

  

PAS 3: Configuració base de dades - PRE.
----------------------------------------

1.  **PRE** – Configurem la Base de Dades amb la nova alta.
2.  Connectem a la BBDD del Valid de PRE (Si no la tenim configurada, tenim les dades al KeePass (**valid pre**)):
3.  Configuració BBDD:  
    1.  A la següent ruta podem trobar fitxers d'altres altes de VALID que podem utilitzar com plantilla: (Sharepoint) Tecnologia - SUPORT\_TECNIC\\SERVEIS\\Valid\_idCATSMS_\\01 Integració\\05 Altes Serveis\\Broker\\Altes\\PRE_
    2.  Crear fitxer .SQL amb l’insert corresponent i desar-lo a (Sharepoint) Tecnologia - SUPORT\_TECNIC\\SERVEIS\\Valid\_idCATSMS_\\01 Integració\\05 Altes Serveis\\Broker\\Altes\\PRE_ (es recomana agafar com referència l’última alta)
4.  EXEMPLE: Per realitzar l'insert necessitarem el fitxer Excel i l'última alta realitzada que la farem servir com a plantilla.
    
    Exemple d'un Excel que envia l'usuari
    
    ![](attachments/26313594/26314183.png)  
    
    Exemple d'un Insert que fem a la BBDD
    
    ![](attachments/26313594/26314178.png)  
    
    ![](attachments/26313594/26314153.png)
    

1.  Número 1: El Shared\_secret (clau compartida) l’obtindrem de la web [sha1-online.com](http://sha1-online.com), on posarem el nom de la entitat AJLAGARRIGA per exemple. S’afegirà com a ID el número següent a l’última configuració realitzada a BBDD. Per exemple si l’última és el 78 amb l’Ajuntament de La Garriga, doncs el nou serà 79:  
    ![](attachments/26313594/81855187.png)  
    ![](attachments/26313594/26317560.png)
2.  Número 2: La redirect\_uri o redirects\_uris, seran l'ID + 1 al final, per exemple: 1551, 1552, 1553, etc..
3.  La resta d'informació en un principi sempre serà la mateixa.
    1.  Informació adicional
        
        ![](attachments/26313594/26313697.png)
        
        1.  Els tipus d’accés estan en OAUTH\_CREDENTIAL\_VALIDATOR  
            ![](attachments/26313594/26317559.png)
        2.  En un principi sempre posarem 1 i 3.
4.  Executar l’insert a BBDD:  
    ![](attachments/26313594/81855189.png)
5.  Validar el correcte funcionament amb l’script A1 amb les dades de l'ens configurat. (RUTA xarxa: ((Sharepoint) Tecnologia - SUPORT\_TECNIC\\SERVEIS\\Valid\_idCATSMS_\\01 Integració\\05 Altes Serveis\\Broker\\0. PROVES DEL FLUX_)
    
    1.  La prova s'ha de fer amb el navegador de **Google Chrome.**  
        ![](attachments/26313594/26313687.png)
        
6.  Informar a l’usuari pel tiquet el tag\_id creat i el Shared\_secret.
    

PAS 4: Configuració base de dades - PRO.
----------------------------------------

1.  **PRO** – Configurem la base de dades amb la nova alta (quan demanin el pas a PRO, mentrestant estan a PRE, no fer res)
2.  Connectem a la BBDD del Valid de PRO (Si no la tenim configurada, tenim les dades al KeePass):  
    ![](attachments/26313594/28705655.png)
3.  Configuració BBDD:
    1.  A la següent ruta podem trobar fitxers d'altres altes de VALID que podem utilitzar com plantilla: _(Sharepoint) Tecnologia - SUPORT\_TECNIC\\SERVEIS\\Valid\_idCATSMS\\01 Integració\\05 Altes Serveis\\Broker\\Altes\\PRO_
    2.  _Crear fitxer .SQL amb l’insert corresponent i desar-lo a (Sharepoint) Tecnologia - SUPORT\_TECNIC\\SERVEIS\\Valid\_idCATSMS\\01 Integració\\05 Altes Serveis\\Broker\\Altes\\PRO (es recomana agafar com referència l’última alta).  
        _
4.  EXEMPLE: Per realitzar l'insert necessitarem el fitxer Excel i l'última alta realitzada que la farem servir com a plantilla.
    
    Exemple d'un Excel que envia l'usuari
    
    ![](attachments/26313594/26313833.png)
    
    Exemple d'un Insert que fem a la BBDD
    
    ![](attachments/26313594/26313831.png)  
    
    ![](attachments/26313594/26313834.png) IMPORTANT → El CLIENT\_ID (recuadre negre) serà el mateix que a PRE. 
    

1.  Número 1: El Shared\_secret (clau compartida) l’obtindrem de la web [sha1-online.com](http://sha1-online.com/), en aquest cas haurem de posar el mateix que configurem en PRE,  on posarem el nom de l'entitat AJLAGARRIGA per exemple. S’afegirà com a ID el número següent a l’última configuració realitzada a BBDD. Per exemple si l’última és el 78 amb l’Ajuntament de La Garriga, doncs el nou serà 79:  
    ![](attachments/26313594/81855186.png)  
    ![](https://steps.everis.com/confluence/download/attachments/1136663492/image2019-2-4_16-58-17.png?version=1&modificationDate=1549297222000&api=v2)
2.  Número 2: La redirect\_uri o redirects\_uris, seran l'ID + 1 al final, per exemple: 1551, 1552, 1553, etc...
    
3.  Executar l’insert a BBDD: 
    
    Query
    
    jdbc:oracle:thin:@(DESCRIPTION =(ADDRESS = (PROTOCOL = TCP)(HOST = 10.124.21.21)(PORT = 1528))(ADDRESS = (PROTOCOL = TCP)(HOST = 10.124.21.22)(PORT = 1528))(LOAD\_BALANCE = yes)(CONNECT\_DATA =(SERVER = DEDICATED)(SERVICE\_NAME = TRUST\_SVC)(FAILOVER\_MODE =(TYPE = SELECT)(METHOD = BASIC)(RETRIES = 180)(DELAY = 5))))
    
    ![](attachments/26313594/81855185.png)
    
4.  Informar a l’usuari pel tiquet que tenen el servei a PRO amb el mateix CLIENT\_ID i SHARED\_SECRET que a PRE

PAS 5: Missatge tipus: Fi d'alta només PRE
------------------------------------------

Benvolguts,

Confirmar-vos que us hem configurat a l’entorn de PRE tot el necessari perquè l’Ajuntament X, pugui consumir el servei VALId, amb les següents dades d’accés:

client\_id = tramits.xxxx.cat  
clau\_compartida = Shared\_secret

Podeu fer les proves oportunes, i quan creieu oportú ens comuniqueu que voleu passar a producció i us ho configurem.

Atentament,

.rwui\_text\_box.rwui\_id\_8a85f571-c2e7-4873-83f9-8b5370f095de {background-color: #F2F2F2; color: #666666;}.rwui\_text\_box.rwui\_id\_8a85f571-c2e7-4873-83f9-8b5370f095de \*:not(.rwui\_content) {color: #666666;}.rwui\_text\_box.rwui\_id\_8a85f571-c2e7-4873-83f9-8b5370f095de span.rwui\_icon {color: #666666;}

PAS 6: Altas esPUBLICO.
-----------------------

1.  esPublico, també anomenat Gestiona, té unes quantes regles del MUX pendents de pujar per sobre de la Regla de DEFECTE (és a dir, de moment és com si estiguessin deshabilitades)
2.  Per tant, cada vegada que arribi una alta de MUX, comproveu el document de sol·licitud per veure que és GESTIONA el desenvolupador de l’ens que està demanant l’alta. Són altes ja fetes per Toni Ll.(algunes no estan realitzades, s’han de configurar directament a PRO. En la ruta ((Sharepoint) Tecnologia - SUPORT\_TECNIC\\SERVEIS\\Valid\_idCATSMS_\\01 Integració\\05 Altes Serveis\\Broker\\Altes\\Altes esPublico_) podem trobar alguns exemples. Actualitzar l’excel ((Sharepoint) Tecnologia - SUPORT\_TECNIC\\SERVEIS\\Valid\_idCATSMS_\\01 Integració\\05 Altes Serveis\\Broker\\Altes\\Altes esPublico\\Alta Oficial.xlsx_), solament falta canviar la configuració de les regles, per tant no heu d’actuar igual que amb la resta d’altes.
3.  Quan arribi l’alta d’aquestes característiques:
    
    1.  Contestar amb la plantilla següent, indicant el Dimecres que us convingui a vosaltres segons el dia que mireu el tiquet:
    
    Benvolguts,
    
    Confirmar-vos que tenim planificada la pujada a producció, conjuntament amb el vostre desenvolupador esPublico, per Dimecres vinent dia XX de XXXX a partir de les 15:00.
    
    Atentament,
    
    .rwui\_text\_box.rwui\_id\_02c0851c-307f-4362-9d6e-1fe69778e173 {background-color: #F2F2F2; color: #666666;}.rwui\_text\_box.rwui\_id\_02c0851c-307f-4362-9d6e-1fe69778e173 \*:not(.rwui\_content) {color: #666666;}.rwui\_text\_box.rwui\_id\_02c0851c-307f-4362-9d6e-1fe69778e173 span.rwui\_icon {color: #666666;}
    

1.  Ruta del fitxer per configurar les IP's: _/apps/aoc/httpd/ssl/identitats.aoc.cat.ssl.conf.nfs_

Attachments:
------------

![](images/icons/bullet_blue.gif) [image2019-2-4\_16-55-9.png](attachments/26313594/26317558.png) (image/png)  
![](images/icons/bullet_blue.gif) [image2019-2-4\_16-57-11.png](attachments/26313594/26317561.png) (image/png)  
![](images/icons/bullet_blue.gif) [image2019-2-4\_16-58-17.png](attachments/26313594/26317560.png) (image/png)  
![](images/icons/bullet_blue.gif) [image2019-2-4\_16-58-54.png](attachments/26313594/26317559.png) (image/png)  
![](images/icons/bullet_blue.gif) [image2019-2-4\_16-59-33.png](attachments/26313594/26317552.png) (image/png)  
![](images/icons/bullet_blue.gif) [image2019-2-4\_17-15-41.png](attachments/26313594/26317549.png) (image/png)  
![](images/icons/bullet_blue.gif) [image2019-2-4\_17-16-58.png](attachments/26313594/26317548.png) (image/png)  
![](images/icons/bullet_blue.gif) [image2019-2-4\_17-17-35.png](attachments/26313594/26317547.png) (image/png)  
![](images/icons/bullet_blue.gif) [image2019-2-19\_11-21-48.png](attachments/26313594/26314109.png) (image/png)  
![](images/icons/bullet_blue.gif) [image2019-2-19\_11-38-55.png](attachments/26313594/26314135.png) (image/png)  
![](images/icons/bullet_blue.gif) [image2019-2-19\_12-6-24.png](attachments/26313594/26314120.png) (image/png)  
![](images/icons/bullet_blue.gif) [image2019-2-19\_12-17-24.png](attachments/26313594/26314183.png) (image/png)  
![](images/icons/bullet_blue.gif) [image2019-2-19\_12-19-25.png](attachments/26313594/26314178.png) (image/png)  
![](images/icons/bullet_blue.gif) [image2019-2-19\_12-43-16.png](attachments/26313594/26314153.png) (image/png)  
![](images/icons/bullet_blue.gif) [image2019-2-19\_13-10-40.png](attachments/26313594/26313697.png) (image/png)  
![](images/icons/bullet_blue.gif) [image2019-2-19\_13-19-41.png](attachments/26313594/26313687.png) (image/png)  
![](images/icons/bullet_blue.gif) [image2019-2-19\_14-59-39.png](attachments/26313594/26313783.png) (image/png)  
![](images/icons/bullet_blue.gif) [image2019-2-19\_15-37-15.png](attachments/26313594/26313833.png) (image/png)  
![](images/icons/bullet_blue.gif) [image2019-2-19\_15-37-55.png](attachments/26313594/26313831.png) (image/png)  
![](images/icons/bullet_blue.gif) [image2019-2-19\_15-38-49.png](attachments/26313594/64980862.png) (image/png)  
![](images/icons/bullet_blue.gif) [image2019-10-17\_14-26-39.png](attachments/26313594/28705655.png) (image/png)  
![](images/icons/bullet_blue.gif) [image2019-2-19\_15-38-49.png](attachments/26313594/26313834.png) (image/png)  
![](images/icons/bullet_blue.gif) [image2022-12-14\_10-24-43.png](attachments/26313594/81855185.png) (image/png)  
![](images/icons/bullet_blue.gif) [image2022-12-14\_10-26-58.png](attachments/26313594/81855186.png) (image/png)  
![](images/icons/bullet_blue.gif) [image2022-12-14\_10-30-3.png](attachments/26313594/81855187.png) (image/png)  
![](images/icons/bullet_blue.gif) [image2022-12-14\_10-31-26.png](attachments/26313594/81855188.png) (image/png)  
![](images/icons/bullet_blue.gif) [image2022-12-14\_10-33-25.png](attachments/26313594/81855189.png) (image/png)  

Document generated by Confluence on 02 June 2025 11:01

[Atlassian](http://www.atlassian.com/)