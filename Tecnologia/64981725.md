Suport Tècnic : Monitor S.T. - CORPME - Sol·licituds\\Peticions en estat inconsistents  

1.  [Suport Tècnic](index.html)
2.  [Suport Tècnic](13893782.html)
3.  [03 - Monitorització - Revisions globals](26313327.html)
4.  [Monitors S.T.](Monitors-S.T._41522177.html)

Suport Tècnic : Monitor S.T. - CORPME - Sol·licituds\\Peticions en estat inconsistents
======================================================================================

Created by Unknown User (oteccmorales), last modified by Cristian Morales on 21 February 2025

Què mesura aquest monitor?

Aquesta sonda revisa les peticions del CORPME  (són de pagament ) que estan en estat inconsistent, sol·licituds en -1 (en Procés) i peticions en -1 (en procés) la FASE 4 del RDBMS es queda trufada.

  

**Consulta**
============

* * *

select count(peticio.id) registres
  from pci30iop.pci\_mti\_peticio   peticio,
       pci30iop.pci\_mti\_solicitud solicitud
 where solicitud.id\_peticio = peticio.id
   and peticio.data\_recepcio < SYSDATE - 7
   and peticio.codi\_producte in ('REGISTRE\_PROPIETAT', 'REGISTRE\_MERCANTIL')
   and (solicitud.estat = -1 or peticio.estat = -1)

**Procediment  
**
==================

* * *

Petició estat 2 i Sol·licitud estat -1

En el cas que la sol·licitud estigui a -1 i la petició estigui a 2 (**qualsevol altre estat comentar internament**):

PETICIÓ 

ESTAT

SOL·LICITUD

ESTAT

2

EXECUTADA

\-1

EN PROCÈS

  

 select peticio.id\_peticio,
        peticio.estat      estat\_pet,
        solicitud.estat    estat\_sol
   from pci30iop.pci\_mti\_peticio   peticio,
        pci30iop.pci\_mti\_solicitud solicitud
  where solicitud.id\_peticio = peticio.id
    and peticio.data\_recepcio < SYSDATE - 7
    and peticio.codi\_producte in
        ('REGISTRE\_PROPIETAT', 'REGISTRE\_MERCANTIL')
    and (solicitud.estat = -1 or peticio.estat = -1)

  

Validem que tinguem resposta del CORPME, cercant per l'id\_peticio

Validem que tinguem resposta del CORPME, cercant per l'id\_peticio

**schema MCPCIIOP**

select \* from MCPCIIOP.AOC\_MCREGISTRADORS\_MSG a
where a.id\_peticio = '9834180001\_REGISTRE\_PROPIETAT\_11138739';

![](attachments/64981725/64981736.png)

Si tenim ID\_FLOTI amb una resposta correcte, en cas contrari, demanem callback → [VO - CORPME - FLUX DEL SERVEI - COMUNICACIÓ - Fer un reenviament per recuperar la resposta de Reg. Prop](28704791.html)

![](attachments/64981725/64981737.png)

Validem la taula aoc\_mcregistradors\_id que el rebuda estigui "1", això vol dir que es va enviar i, per tant, es facturarà. (si està a "0" no vol dir que no s'ha enviat, pot ser que hagi hagut un error tècnic en la nostra banda)

**schema MCPCIIOP**

select  \* from MCPCIIOP.aoc\_mcregistradors\_id -- treurem el id\_floti
where id\_peticio = '9834180001\_REGISTRE\_PROPIETAT\_11138739';

![](attachments/64981725/64981738.png)

Actualitzem l'estat de la sol·licitud a 5 perquè es processi:

UPDATE
PCI\_MTI\_SOLICITUD SET ESTAT=5, EXECUTADA=0 WHERE ID\_PETICIO=(SELECT ID FROM
PCI\_MTI\_PETICIO WHERE ID\_PETICIO='9834180001\_REGISTRE\_PROPIETAT\_11138739');

Si tot va bé, s'ha de quedar finalitzat i amb resposta el consum en la MTI:

![](attachments/64981725/64981740.png)

  

Petició estat -1 i Sol·licitud estat 2

En cas de tindre la petició a -1, validem si la sol·licitud està en estat 2 

PETICIÓ 

ESTAT

SOL·LICITUD

ESTAT

\-1

EN PROCÈS DEL BEA

2

EXECUTADA

**consulta treure id\_peticio**

 select peticio.id\_peticio,
        peticio.estat      estat\_pet,
        solicitud.estat    estat\_sol
   from pci30iop.pci\_mti\_peticio   peticio,
        pci30iop.pci\_mti\_solicitud solicitud
  where solicitud.id\_peticio = peticio.id
    and peticio.data\_recepcio < SYSDATE - 7
    and peticio.codi\_producte in
        ('REGISTRE\_PROPIETAT', 'REGISTRE\_MERCANTIL')
    and (solicitud.estat = -1 or peticio.estat = -1)

En aquest cas, validem la part del CORPME:

Validem que tinguem resposta del CORPME, cercant per l'id\_peticio

Validem que tinguem resposta del CORPME, cercant per l'id\_peticio

**schema MCPCIIOP**

select \* from MCPCIIOP.AOC\_MCREGISTRADORS\_MSG a
where a.id\_peticio = '9834180001\_REGISTRE\_PROPIETAT\_11138739';

![](attachments/64981725/64981736.png)

En cas contrari validem si hem de demanar callback → [VO - CORPME - FLUX DEL SERVEI - COMUNICACIÓ - Fer un reenviament per recuperar la resposta de Reg. Prop](28704791.html)

Una vegada, tinguem ID\_FLOTI amb una resposta correcte (pot ser un missatge controlat)

![](attachments/64981725/64981737.png)

Validem la taula aoc\_mcregistradors\_id que el rebuda estigui "1", això vol dir que es va enviar i per tant es facturarà.

**schema MCPCIIOP**

select  \* from MCPCIIOP.aoc\_mcregistradors\_id -- treurem el id\_floti
where id\_peticio = '9834180001\_REGISTRE\_PROPIETAT\_11138739';

![](attachments/64981725/64981738.png)

Actualitzem l'estat de la petició perquè es processi:

**Update estat petició = 2 perquè el RDBMS FASE5 les agafi**

UPDATE
PCI\_MTI\_PETICIO SET ESTAT=2 WHERE ID\_PETICIO='1568618047052924';

Si tot va bé, s'ha de quedar finalitzat i amb resposta el consum en la MTI:

![](attachments/64981725/64981740.png)

Petició estat -1 i Sol·licitud estat 0

En cas de tindre la petició a -1, validem si la sol·licitud està en estat 0 

PETICIÓ 

ESTAT

SOL·LICITUD

ESTAT

\-1

EN PROCÈS DEL BEA

0

  

**consulta treure id\_peticio**

 select peticio.id\_peticio,
        peticio.estat      estat\_pet,
        solicitud.estat    estat\_sol
   from pci30iop.pci\_mti\_peticio   peticio,
        pci30iop.pci\_mti\_solicitud solicitud
  where solicitud.id\_peticio = peticio.id
    and peticio.data\_recepcio < SYSDATE - 7
    and peticio.codi\_producte in
        ('REGISTRE\_PROPIETAT', 'REGISTRE\_MERCANTIL')
    and (solicitud.estat = -1 or peticio.estat = -1)

En aquest cas, validem la part del CORPME:

En principi, amb aquest estat, no hem de tenir resposta del CORPME. En cas que sí que tinguem resposta del CORPME, s'ha de revisar amb ST.

Validem que NO tinguem resposta del CORPME, cercant per l'id\_peticio

**schema MCPCIIOP**

select \* from MCPCIIOP.AOC\_MCREGISTRADORS\_MSG a
where a.id\_peticio = '9834180001\_REGISTRE\_PROPIETAT\_11138739';

Actualitzem l'estat de la petició perquè es quedi en error:

**Update estat petició = 4**

UPDATE
PCI\_MTI\_PETICIO SET ESTAT=4 WHERE ID\_PETICIO='1568618047052924';

Si tot va bé, s'ha de quedar finalitzat amb error i així no s'intentarà processar de nou.

  

  

En cas de reinici WL12 PRO, o problemes

Revisar la consulta i validar totes les peticions que tenen un estat inconsistent. Si l'estat es dels casos explicats anteriorment, fer el seguiment, si es diferent revisar si tenim resposta del CORPME o l'hem de recuperar:

PETICIÓ 

ESTAT

SOL·LICITUD

ESTAT

2

EXECUTADA

5

EXECUTADA PENDENT DE RESPOSTA (DIFERIDA)

Validar que el RDBMS aquest no estigui trufat: MTI\_ACT\_SOL\_NOU

![](attachments/64981725/124911713.png)

Si es així, hem de reiniciar l'admin.

[PCI3 - WL12 - Reinici#ReiniciADMIN](PCI3---WL12---Reinici_41520945.html#PCI3WL12Reinici-ReiniciADMIN)

![](attachments/64981725/124911715.png)

\----- Aquí cerquem que la data de recepció tingui 5 dies, el temps que pot trigar el corpme en respondre, són 7, però per deixar un temps prudencial per resoldre problemes.
---- Són peticions que tenim XML enviat al CORPME i, per tant, el poden cobrar...
select \* from MCPCIIOP.Aoc\_Mcregistradors\_Msg a -- Resposta del CORPME
where a.id\_peticio in (select peticio.id\_peticio    
     from pci30iop.pci\_mti\_peticio   peticio,
       pci30iop.pci\_mti\_solicitud solicitud
 where solicitud.id\_peticio = peticio.id
  and peticio.data\_recepcio < SYSDATE -5
   and peticio.codi\_producte in ('REGISTRE\_PROPIETAT', 'REGISTRE\_MERCANTIL')
       and (solicitud.estat <> 3 or peticio.estat <> 3)
       and (solicitud.estat <> 5 or peticio.estat <> 2)
       and (solicitud.estat <> -1 or peticio.estat <> 2)
       and (solicitud.estat <> 2 or peticio.estat <> -1));

---------- Consulta per validar a partir d'una data
select \* from MCPCIIOP.Aoc\_Mcregistradors\_Msg a -- Resposta del CORPME
where a.id\_peticio in (select peticio.id\_peticio    
     from pci30iop.pci\_mti\_peticio   peticio,
       pci30iop.pci\_mti\_solicitud solicitud
 where solicitud.id\_peticio = peticio.id
 and peticio.data\_recepcio > to\_date ('05/04/2024','dd/mm/yyyy')
   and peticio.codi\_producte in ('REGISTRE\_PROPIETAT', 'REGISTRE\_MERCANTIL')
       and (solicitud.estat <> 3 or peticio.estat <> 3)
       and (solicitud.estat <> 5 or peticio.estat <> 2)
       and (solicitud.estat <> -1 or peticio.estat <> 2)
       and (solicitud.estat <> 2 or peticio.estat <> -1));

[ST-22418](https://contacte.aoc.cat/browse/ST-22418?src=confmacro) - Data cannot be retrieved due to an unexpected error.

  

**Informació addicional**
=========================

* * *

### Incidència amb un consum que ha donat error i es consulta el callback del CORPME per recuperar la resposta: [VO - CORPME - FLUX DEL SERVEI - COMUNICACIÓ - Fer un reenviament per recuperar la resposta de Reg. Prop](28704791.html)

Attachments:
------------

![](images/icons/bullet_blue.gif) [CORPME - Procés d'alta de serveiSuport Tècnic16 marzo 2020Procediment a realitzar setmanalment per les altes del CORPME. Guia.url](attachments/64981725/64981726.url) (application/octet-stream)  
![](images/icons/bullet_blue.gif) [cds.gif](attachments/64981725/64981727.gif) (image/gif)  
![](images/icons/bullet_blue.gif) [image2022-6-10\_16-10-31.png](attachments/64981725/64981736.png) (image/png)  
![](images/icons/bullet_blue.gif) [image2022-6-10\_16-11-22.png](attachments/64981725/64981737.png) (image/png)  
![](images/icons/bullet_blue.gif) [image2022-6-10\_16-16-42.png](attachments/64981725/64981738.png) (image/png)  
![](images/icons/bullet_blue.gif) [image2022-6-10\_16-21-13.png](attachments/64981725/64981740.png) (image/png)  
![](images/icons/bullet_blue.gif) [image2025-2-21\_10-35-52.png](attachments/64981725/124911713.png) (image/png)  
![](images/icons/bullet_blue.gif) [image2025-2-21\_11-25-22.png](attachments/64981725/124911715.png) (image/png)  

Document generated by Confluence on 02 June 2025 11:09

[Atlassian](http://www.atlassian.com/)