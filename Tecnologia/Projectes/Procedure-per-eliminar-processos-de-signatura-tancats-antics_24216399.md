Projectes : Procedure per eliminar processos de signatura tancats antics  

1.  [Projectes](index.md)
2.  [PSA](PSA_24216342.md)
3.  [PSA - WIKI](PSA---WIKI_24216306.md)
4.  [SQL](SQL_24216319.md)

Projectes : Procedure per eliminar processos de signatura tancats antics
========================================================================

Created by √Åurea Alcaide on 29 julio 2019

**DEL\_CLOSED\_PROCEDURECONTEXTS**

create or replace 
PROCEDURE DEL\_CLOSED\_PROCEDURECONTEXTS AS 

DAYS number;

CURSOR closed\_procedure\_contexts (days in number) IS
  SELECT p.id 
  FROM procedurecontext\_t p
  WHERE p.dateupdate < sysdate - days
  AND p.state = 'END';

CURSOR acts (procedure\_context\_id in number) IS
  SELECT act.id
  FROM act\_t act 
  where act.procedurecontextid = procedure\_context\_id;

CURSOR origdocs (procedure\_context\_id in number) IS
  SELECT od.id, od.uuidoriginaldocument
  FROM originaldocument\_t od  
  where od.procedurecontextid = procedure\_context\_id;

CURSOR signatures (act\_id in number) IS
  SELECT s.id, s.uuiddoctosign, s.uuidsignature, s.uuidticket
  FROM signature\_t s
  where s.actid = act\_id;

NODE\_ID number;
NODE\_PROP\_ID number;

CURSOR node\_props (node\_id in number) IS
  SELECT np.id
  FROM repositorynodeproperty\_t np
  where np.nodeid = node\_id
  ORDER BY np.id ASC;

CURSOR node\_props\_bin (nodeprop\_id in number) IS
  SELECT npb.id
  FROM repositorynodepropertybinary\_t npb
  where npb.id = nodeprop\_id
  ORDER BY npb.id ASC;

CURSOR node\_props\_str (nodeprop\_id in number) IS
  SELECT nps.id
  FROM repositorynodepropertystring\_t nps
  where nps.id = nodeprop\_id
  ORDER BY nps.id ASC;

BEGIN

  DBMS\_OUTPUT.ENABLE (buffer\_size => NULL); 

  SELECT value INTO DAYS
  FROM schemaconfig\_t c 
  where c.param ='scheduler.closed.contexts';

  DAYS:=5;

  FOR closed\_procedure\_context IN closed\_procedure\_contexts(DAYS) LOOP
    dbms\_output.put\_line('PROCEDURE\_CONTEXT\_ID = ' || closed\_procedure\_context.id);

    FOR act IN acts(closed\_procedure\_context.id) LOOP
      dbms\_output.put\_line('ACT\_ID = ' || act.id);
      FOR signature IN signatures(act.id) LOOP

        -- DELETE FROM REPOSITORY
        IF(signature.uuiddoctosign IS NOT NULL) THEN
          DELETE\_NODE\_FROM\_REPO\_BYUUID(signature.uuiddoctosign);
        END IF;
        IF(signature.uuidsignature IS NOT NULL) THEN
          DELETE\_NODE\_FROM\_REPO\_BYUUID(signature.uuidsignature);
        END IF;
        IF(signature.uuidticket IS NOT NULL) THEN
          DELETE\_NODE\_FROM\_REPO\_BYUUID(signature.uuidticket);
        END IF;

        -- DELETE SIGNATURE
        DELETE FROM signature\_t WHERE id=signature.id;
        dbms\_output.put\_line('signature deleted -> SIGNATURE\_ID = ' || signature.id);

      END LOOP;

      -- DELETE ACT
      DELETE FROM act\_t WHERE id=act.id;
      dbms\_output.put\_line('act deleted -> ACT\_ID = ' || act.id);  

    END LOOP;

    -- DELETE ORIGINAL DOCUMENT    
    FOR origdoc IN origdocs(closed\_procedure\_context.id) LOOP
      dbms\_output.put\_line('ORIGINAL\_DOCUMENT\_ID = ' || origdoc.id);
      DELETE FROM originaldocument\_t od where od.id = origdoc.id;
    END LOOP;

    -- DELETE PROCEDURE CONTEXT
    DELETE FROM procedurecontext\_t p where p.id = closed\_procedure\_context.id;
    dbms\_output.put\_line('procedure context deleted -> PROCEDURE\_CONTEXT\_ID = ' || closed\_procedure\_context.id);  

  COMMIT;

  END LOOP;

EXCEPTION
  WHEN OTHERS THEN
    DBMS\_OUTPUT.PUT\_LINE (SQLCODE || ' ' || SQLERRM);
    ROLLBACK;

END DEL\_CLOSED\_PROCEDURECONTEXTS;

  

Document generated by Confluence on 07 junio 2025 00:00

[Atlassian](http://www.atlassian.com/)