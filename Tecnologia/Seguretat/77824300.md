Seguretat : Configuració SSL per TLS v1.2 (2023 v1.1)  

1.  [Seguretat](index.md)
2.  [Pàgina d'inici de la Unitat de Seguretat](15368362.md)
3.  [Projectes Unitat de Seguretat](Projectes-Unitat-de-Seguretat_41517821.md)
4.  [Securització de frontals](41519957.md)

Seguretat : Configuració SSL per TLS v1.2 (2023 v1.1)
=====================================================

Created by Rafael Carrasco, last modified on 06 junio 2024

Configuració SSL per TLS v1.2 per cada VirualHost, cal dir que és lo millor amb lo que podem arribar fent servir CentOS 7.9 (amb Apache 2.4.6 i OpenSSL 1.0.2k).

Ens hem basat en documentació prèvia i en la darrera configuració proposada i validada a tasques de Seguretat, és la següent:

*   Proposta de Protocols denegant tot lo que no sigui TLS v1.2 i TLS v1.3 (en cas de poder oferir-se), grup de suite's de xifrat i l'ordre de xifrat basat en servidor per sobre del client (_SSLHonorCipherOrder_):

> SSLEngine on
> SSLProtocol all -SSLv2 -SSLv3 -TLSv1 -TLSv1.1
> SSLCipherSuite ECDHE-ECDSA-AES128-GCM-SHA256:ECDHE-RSA-AES128-GCM-SHA256:ECDHE-ECDSA-AES256-GCM-SHA384:ECDHE-RSA-AES256-GCM-SHA384:ECDHE-ECDSA-CHACHA20-POLY1305:ECDHE-RSA-CHACHA20-POLY1305:DHE-RSA-AES128-GCM-SHA256:DHE-RSA-AES256-GCM-SHA384
> SSLHonorCipherOrder on

*   Capçaleres de securització que poden estar a un fitxer al NFS que es pot cridar mitjançant un Include o seguidament a les directives anteriors:

> <IfModule headers\_module>  
>   Header always append X-Frame-Options SAMEORIGIN  
>   Header always set X-Xss-Protection "1; mode=block"  
>   Header always set Strict-Transport-Security "max-age=63072000"  
>   Header always set X-Content-Type-Options "nosniff"  
>   Header always set Referrer-Policy "no-referrer-when-downgrade"  
>   Header set Access-Control-Allow-Origin "CHANGE-ME-WEBSITE-NAME-HERE"  
> </IfModule>  
>   
> <IfModule mod\_headers.c>  
>   Header always set Permissions-Policy "geolocation=(self),midi=(self),sync-xhr=(self),microphone=(self),camera=(self),magnetometer=(self),gyroscope=(self),fullscreen=(self),payment=(self)"  
>   Header always set Content-Security-Policy "default-src 'self' \*.aoc.cat \*.google.com"  
>   Header set X-Permitted-Cross-Domain-Policies "none"  
>   Header edit Set-Cookie ^(.\*)$ "$1;HttpOnly;Secure;SameSite=Strict"  
> </IfModule>  
>   
> <IfModule reqtimeout\_module>  
>   RequestReadTimeout header=10,MinRate=500 body=60,MinRate=500  
> </IfModule>  
>   
> <IfModule headers\_module>  
>   Header unset X-Powered-By  
> </IfModule>
> 
> RewriteEngine on  
> RewriteCond %{REQUEST\_METHOD} ^(TRACE|TRACK|PUT|PATCH|DELETE|OPTIONS|HEAD)  
> RewriteRule .\* - \[L,R=405\]

*   Per OCSP Stapling, dintre de les directives de VirtualHost:

> SSLUseStapling on  
> SSLStaplingResponderTimeout 5  
> SSLStaplingReturnResponderErrors off
> SSLStaplingResponseMaxAge 900

I fora de les directives de VirtualHost (al fitxer httpd.conf) per OCSP Stapling:

> <IfModule mod\_ssl.c>  
>   SSLStaplingCache "shmcb:logs/stapling-cache(150000)"  
> </IfModule>

*   Altres millores com l'ocultació de la versió d'Apache a respostes d'error (incloent també capçaleres), no publicar versionat de mòduls i plugins i Sistema Operatiu, i el comportament a peticions de TRACE si tenim _mod\_proxy_ habilitat:

> ServerSignature Off
> ServerTokens Prod
> Header unset Server  
> TraceEnable Off

*   Per configuracions DNS CAA, cal afegir un registre de tipus CAA al DNS del domini a protegir per indicar les CA's permeses per emetre certificats SSL pel domini, deixem proposta d'exemple:

tag

value

issue

sectigo.com, globalsign.com, digicert.com, entrust.net, letsencrypt.org, amazon.com

iodef

mailto:certificats@aoc.cat

\*NOTA: Per mitigar el posible risc de que la zona DNS pugui veure's compromesa per un atacant i modificar els registres CAA, la recomanació passa per fer servir DNSSEC.

  

 **![(advertencia)](images/icons/emoticons/warning.svg) IMPORTANT**: Deixem algunes consideracions per que depèn del servei que es tracti caldrà revisar algunes configuracions més a fons, per exemple:

*   al VALID Aïllat (Mediacloud) i al VALID DR (Nexica) tenim aplicada la configuració de la capçalera Set-Cookie amb l'argument SameSite a valor de "None", en comptes de "Strict" (SIS-3667 i SIS-4139). Es poden donar casos que ens pugui interessar habilitar la crida des de un altre domini, com els casos ente VALID i IdCatMobil (SIS-5129) que s'ha aplicat un valor de SameSite a "Lax" (poden ser None, Lax o Strict, al final hi ha un enllaç amb la documentació del site _developer mozilla_).
*   seria bo deixar el mínims mètodes possibles habilitats, per exemple la majora de serveis necessiten els GET i POST, però no cal que tinguin els de TRACE, TRACK, PUT, PATCH, DELETE, OPTIONS, i HEAD, caldrà doncs potser habilitar-ho per contexte (SIS-1842, SIS-1941 o SIS-3300). Els serveis amb API RESTful fan servir mètodes PUT i DELETE. (Més informació [https://owasp.org/www-project-web-security-testing-guide/latest/4-Web\_Application\_Security\_Testing/02-Configuration\_and\_Deployment\_Management\_Testing/06-Test\_HTTP\_Methods](https://owasp.org/www-project-web-security-testing-guide/latest/4-Web_Application_Security_Testing/02-Configuration_and_Deployment_Management_Testing/06-Test_HTTP_Methods))
*   han sorgit varies tasques posteriors de _fine tuning_ un cop aplicada la configuració per CSP Content Security Policy ja que segons quins recursos externs necessitin les aplicacions caldrà fer una sèrie d'ajustaments per configurar explícitament lo que cada servei requereixi i no més, en un exercici de restricció total inicial. En cas de que la Unitat de Projectes ens facilitin la tasca per identificar tots els recursos que li calen a les aplicacions, es podran configurar prèviament, si no és així doncs haurà de fer-se una sèrie d'aproximacions als entorns de Desenvolupament i Preproducció.  
    Una configuració de referència que s'ha treballat a tots els entorns i aplicat per CSP (SIS-5583) és la següent:
    
    > Header always set Content-Security-Policy "default-src 'self' 'unsafe-inline' 'unsafe-eval' pl6.eacat.cat [www.google.com](http://www.google.com) www.aoc.cat \*.[googleapis.com](http://googleapis.com) \*.[gstatic.com](http://gstatic.com) [www.googletagmanager.com](http://www.googletagmanager.com) [www.google-analytics.com](http://www.google-analytics.com); script-src 'self' 'unsafe-inline' 'unsafe-eval' pl6.eacat.cat [www.google.com](http://www.google.com) www.aoc.cat \*.[googleapis.com](http://googleapis.com) \*.[gstatic.com](http://gstatic.com) [www.googletagmanager.com](http://www.googletagmanager.com) [www.google-analytics.com](http://www.google-analytics.com); connect-src 'self' signador.aoc.cat \*.[google-analytics.com](http://google-analytics.com) \*.[amazonaws.com](http://amazonaws.com); frame-src 'self' signador.aoc.cat copia.aoc.cat"
    

*   com a mesure de protecció CORS, hem afegit la directiva per capçalera Access-Control-Allow-Origin, un exemple de configuració el tenim al tiquet SIS-5583 i seria així la seva aplicació:  
    
    > Header set Access-Control-Allow-Origin "[https://pl6.eacat.cat](https://pl6.eacat.cat)"
    

  

![(info.)](images/icons/emoticons/information.svg) Eines per poder validar configuracions:

*   [https://www.ssllabs.com/ssltest/](https://www.ssllabs.com/ssltest/)
*   [https://ssl-config.mozilla.org/](https://ssl-config.mozilla.org/)
*   [https://securityheaders.com/](https://securityheaders.com/)
*   [https://report-uri.com/home/generate](https://report-uri.com/home/generate)
*   [https://developer.mozilla.org/en-US/docs/Web/HTTP/Headers/Set-Cookie](https://developer.mozilla.org/en-US/docs/Web/HTTP/Headers/Set-Cookie)
*   [https://developer.mozilla.org/en-US/docs/Web/HTTP/Headers](https://developer.mozilla.org/en-US/docs/Web/HTTP/Headers)
*   [https://www.nslookup.io/domains/aoc.cat/dns-records/caa/](https://www.nslookup.io/domains/aoc.cat/dns-records/caa/)
*   OpenSSL ( "_openssl s\_client -connect FQDN/IP:443_" )
*   SSLScan i TestSSL (on Kali Linux)
*   Nmap scripts "ssl-enum-ciphers" i "http-methods"

Document generated by Confluence on 07 junio 2025 00:08

[Atlassian](http://www.atlassian.com/)