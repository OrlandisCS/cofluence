Suport Tècnic : Monitor S.T. - SIR - Enviaments en estat d'error  

1.  [Suport Tècnic](index.md)
2.  [Suport Tècnic](13893782.md)
3.  [03 - Monitorització - Revisions globals](26313327.md)
4.  [Monitors S.T.](Monitors-S.T._41522177.md)
5.  [Monitors S.T. - SIR](Monitors-S.T.---SIR_127598710.md)

Suport Tècnic : Monitor S.T. - SIR - Enviaments en estat d'error
================================================================

Created by Oriol Bernal, last modified on 14 December 2023

Què mesura aquest monitor?

El següent monitor conta el nombre de tràmits que s'han enviat des de Catalunya, però que es troben en estat d'error. Haurem de revisar quin és el seu estat real i reiniciar l'acció que ha produït l'error.

**Consulta**
============

* * *

  

**Comptador de tràmits:**

SELECT COUNT(ID) "Enviaments"
  FROM SIR\_PCI.SIR\_INTERCANVI
  WHERE tipus = 0 -- Enviament
 AND estat = 5 -- Error
 AND reintents <= 5

**Detall dels tràmits afectats:**

SELECT \*
  FROM SIR\_PCI.SIR\_INTERCANVI
  WHERE tipus = 0 -- Enviament
 AND estat = 5 -- Error
 AND reintents <= 5

**Procediment**
===============

* * *

1) Reiniciar l'acció que ha produït l'error

Els enviaments poden produir un error durant:

*   La fase d'enviar
*   La fase de confirmar que hem rebut un rebuig
*   La fase de confirmar que hem rebut un reenviament

Reiniciar esdeveniments que no s'han enviat correctament:

UPDATE SIR\_INTERCANVI
    SET estat = 0
 WHERE tipus = 0 -- Enviament
 AND estat = 5 -- Error
 AND reintents <= 5
 AND ack\_enviament = 0
 AND ack\_enviament\_rebuig = 0

Reiniciar esdeveniments que no s'han enviat l'ACK de rebuig correctament:

UPDATE SIR\_INTERCANVI
    SET ack\_enviament\_rebuig = 0, estat = 3
 WHERE tipus = 0 -- Enviament
 AND estat = 5 -- Error
 AND reintents <= 5
 AND ack\_enviament\_rebuig = 1

**2) Analitzar els missatges d'error**

En funció del tipus d'error haurem de modificar el sicres3 per fer-lo vàlid:

\-- Últim error retornat per cada tràmit
SELECT i.data, i.id\_sir, ultim\_apunt.missatge 
FROM SIR\_PCI.SIR\_INTERCANVI i, 
  (SELECT a.\* 
    FROM SIR\_PCI.SIR\_APUNT a, 
      (SELECT id\_intercanvi, max(data) as max\_data 
        FROM SIR\_PCI.SIR\_APUNT 
        GROUP BY id\_intercanvi
      ) ultima\_data 
    WHERE a.id\_intercanvi = ultima\_data.id\_intercanvi 
      AND a.data = ultima\_data.max\_data
  ) ultim\_apunt
WHERE i.id = ultim\_apunt.id\_intercanvi 
  AND i.tipus = 0 -- Enviament
  AND i.estat = 5 -- Error
  AND reintents < 5
ORDER BY ultim\_apunt.missatge;

Si volem agrupar elss missatges per tipus:

SELECT REPLACE(ultim\_apunt.missatge, i.id\_sir, ''), COUNT(\*)
FROM SIR\_PCI.SIR\_INTERCANVI i, 
  (SELECT a.\* 
    FROM SIR\_PCI.SIR\_APUNT a, 
      (SELECT id\_intercanvi, max(data) as max\_data 
        FROM SIR\_PCI.SIR\_APUNT 
        GROUP BY id\_intercanvi
      ) ultima\_data 
    WHERE a.id\_intercanvi = ultima\_data.id\_intercanvi 
      AND a.data = ultima\_data.max\_data
  ) ultim\_apunt
WHERE i.id = ultim\_apunt.id\_intercanvi 
  AND i.tipus = 0 -- Enviament
  AND i.estat = 5 -- Error
  AND reintents <= 5
 GROUP BY REPLACE(ultim\_apunt.missatge, i.id\_sir, '')
 ORDER BY COUNT(\*) DESC

Per més informació sobre com tractar cada missatge: [SIR 2.0 - FLUX DEL SERVEI - ERRORS - Error en l'enviament d'un tràmit](41523388.md)

**3) Revisar les oficines de destí afectades**

Si després de reiniciar els enviaments afectats, encara no obtenim els ACK's corresponents, haurem de reportar-ho als tècnics del MINHAP. Podem fer una extracció de les oficines de destí afectades que no estan enviant l'ACK:

SELECT oficina\_desti, count(\*)
  FROM SIR\_PCI.SIR\_INTERCANVI 
   WHERE tipus = 0 -- Enviament
   AND estat = 5 -- Error
   AND reintents <= 5
   AND id NOT IN (
       SELECT i.id FROM SIR\_PCI.SIR\_INTERCANVI i, SIR\_PCI.SIR\_APUNT a
         WHERE a.id\_intercanvi = i.id
        AND i.tipus = 0 -- Enviament
        AND a.tipus = 3 -- ACK
    )   
    GROUP BY oficina\_desti
    ORDER BY count(\*) desc

També podem revisar per cada oficina afectada, quan ha sigut l'últim ACK que han enviat, ja que si ha sigut fa temps, potser tenen un problema, però si han enviat ACK's fa poc, podem tornar a reintentar per veure si la seva aplicació ho processa:

SELECT \* FROM SIR\_PCI.SIR\_INTERCANVI i, SIR\_PCI.SIR\_APUNT a
WHERE a.id\_intercanvi = i.id
AND i.tipus = 0 -- Enviament
AND a.tipus = 3 -- ACK
AND i.oficina\_desti = 'O00005633'
ORDER BY i.data DESC

**Informació addicional**
=========================

* * *

### 1) RDBMS

Aquest monitor pot estar afectat per la cua de l'[RDBMS](http://10.120.1.163:7001/pci3-rdbmseg-admin/)  SIR-ENVIAMENT

SELECT COUNT(ID) FROM SIR\_INTERCANVI WHERE ESTAT=0 AND REINTENTS < 5

Després de reiniciar els enviaments, haurem d'esperar que es processin.

### 2) Revisió de logs

**Portlet**: A cada node del pl6, ja que no hi ha NFS:

cd /apps/tomcat//logs
grep "O00006336\_21\_00001699" EACATPL-SIR.log.\* | grep ENVIA

**Core**: Des de qualsevol node:

cd /apps/aoc/APP/logs
grep "EACATSIR-ENVIAMENT-1620718132449" MC-SIR\_APPNODO?\_SOA.log.2021-05-11

### 3) Model de dades

#### **SIR\_PCI**

#### SIR\_INTERCANVI.TIPUS

Valor

Significat

0

Enviament

1

Recepció

#### SIR\_INTERCANVI.ESTAT

Valor

Significat

0

Pendent d'enviar

1

Pendent de confirmar

2

Confirmat

3

Rebutjat

4

Reenviat

5

Error

#### SIR\_SINCRONITZACIO.OPERACIO

Valor

Significat

0

Pendent de confirmació

1

Confirmar

2

Rebutjat

3

Error

4

Rebut

#### SIR\_APUNT.TIPUS

Valor

Significat

0

Enviament

1

Reenviament

2

Rebuig

3

ACK

4

Error

5

Confirmació

6

Reenviament a inici

  

Attachments:
------------

![](images/icons/bullet_blue.gif) [image2021-5-26\_13-6-44.png](attachments/100008554/100008555.png) (image/png)  
![](images/icons/bullet_blue.gif) [cds.gif](attachments/100008554/100008556.gif) (image/gif)  

Document generated by Confluence on 02 June 2025 11:08

[Atlassian](http://www.atlassian.com/)