Projectes : Renovació CDA  

1.  [Projectes](index.md)
2.  [PSIS](PSIS_24215797.md)
3.  [PSIS - WIKI](PSIS---WIKI_24215598.md)
4.  [Procediments](Procediments_24215610.md)

Projectes : Renovació CDA
=========================

Created by Áurea Alcaide, last modified on 22 julio 2020

**1.- Backup de les taules de claus.**
--------------------------------------

  

CREATE TABLE B\_AUTHZ\_ARCHIVE\_USAGE AS SELECT \* FROM AUTHZ\_ARCHIVE\_USAGE;
CREATE TABLE B\_AUTHZ\_KEY\_USAGE AS SELECT \* FROM AUTHZ\_KEY\_USAGE;
CREATE TABLE B\_D\_IM\_ATL\_METADATA AS SELECT \* FROM D\_IM\_ATL\_METADATA;
CREATE TABLE B\_D\_IM\_ATL\_METADATA\_VALUES AS SELECT \* FROM D\_IM\_ATL\_METADATA\_VALUES;
CREATE TABLE B\_D\_KM\_ATL\_KEY\_ATTRIBUTES AS SELECT \* FROM D\_KM\_ATL\_KEY\_ATTRIBUTES;
CREATE TABLE B\_D\_KM\_ATL\_KEY\_PAIRS AS SELECT \* FROM D\_KM\_ATL\_KEY\_PAIRS;
CREATE TABLE B\_D\_KM\_ATL\_KEY\_USAGES AS SELECT \* FROM D\_KM\_ATL\_KEY\_USAGES;
CREATE TABLE B\_D\_KM\_ATL\_SECRET\_KEYS AS SELECT \* FROM D\_KM\_ATL\_SECRET\_KEYS;
CREATE TABLE B\_D\_KSDB\_ATL\_KEYENTRIES AS SELECT \* FROM D\_KSDB\_ATL\_KEYENTRIES;
CREATE TABLE B\_D\_BM\_ATL\_BINDING\_STATES AS SELECT \* FROM D\_BM\_ATL\_BINDING\_STATES;
CREATE TABLE B\_D\_BM\_ATL\_BINDING\_USAGES AS SELECT \* FROM D\_BM\_ATL\_BINDING\_USAGES;
CREATE TABLE B\_D\_BM\_ATL\_KEY\_APPLICATIONS AS SELECT \* FROM D\_BM\_ATL\_KEY\_APPLICATIONS;
CREATE TABLE B\_D\_CS\_ATL\_CERTIFICATE\_ENTRIES AS SELECT \* FROM D\_CS\_ATL\_CERTIFICATE\_ENTRIES;
CREATE TABLE B\_D\_IM\_ATL\_ATTRIBUTE\_METADATA AS SELECT \* FROM D\_IM\_ATL\_ATTRIBUTE\_METADATA;
CREATE TABLE B\_D\_IM\_ATL\_ATTRIBUTE\_VALUE AS SELECT \* FROM D\_IM\_ATL\_ATTRIBUTE\_VALUE;
CREATE TABLE B\_D\_IM\_ATL\_ATTRIBUTES AS SELECT \* FROM D\_IM\_ATL\_ATTRIBUTES;
CREATE TABLE B\_D\_KM\_ATL\_PRIVATE\_KEYS AS SELECT \* FROM D\_KM\_ATL\_PRIVATE\_KEYS;
CREATE TABLE B\_D\_KM\_ATL\_PUBLIC\_KEYS AS SELECT \* FROM D\_KM\_ATL\_PUBLIC\_KEYS;
CREATE TABLE B\_D\_KM\_ATL\_KEYS AS SELECT \* FROM D\_KM\_ATL\_KEYS;
CREATE TABLE B\_D\_KM\_ATL\_SIMPLE\_KEYS AS SELECT \* FROM D\_KM\_ATL\_SIMPLE\_KEYS;
CREATE TABLE B\_D\_IM\_ATL\_ENTITY AS SELECT \* FROM D\_IM\_ATL\_ENTITY;
CREATE TABLE B\_D\_BM\_ATL\_BINDINGS AS SELECT \* FROM D\_BM\_ATL\_BINDINGS;

  

**2.- Eliminar clau existent.**  
Per carregar una clau que substitueixi a una ja existent a punt de caducar, cal primer eliminar la que caducarà.  
Per eliminiar-la, aturar el servei, i executar el procedure Oracle:  
**DELETE\_OLD\_CDA\_PRE**  
Abans d'executar-ho, cal substituir els valors del **subject** i el **certificate finger print** pels del certificat a eliminar.
---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------

**3.- Carregar la nova clau des de la consola java.**
-----------------------------------------------------

### **3.1.- Actualització arxius de bindings.**

Per tal de carregar la nova clau, cal actualitar els següents arxius amb la informació del nou P12:

**catcert-dssBinding\_PRE\_xxxxx.xml**:

<Binding xmlns="[http://www.netfocus.es/psis/management](http://www.netfocus.es/psis/management)">  
<Entity name="**DSSMessageListener**" domain="**serviceEntity**" schema="X500BasedSchema">  
<Attribute name="X500Name">  
<Value> **_X500Name_** </Value>  
</Attribute>  
</Entity>  
<Key>  
<KeyPair>  
<StorePath>./psis-config/configuracio\_psis/bindings/P12s/ **_nom p12_** </StorePath>  
<StorePass> **_password_** </StorePass>  
</KeyPair>  
<Usages>  
<Usage name=" **Identifiers/KeyUsages/Signature** "/>  
</Usages>  
<Applications>  
<Application name="app\_name" URI="urn:ietf:rfc:2633"/>  
</Applications>  
</Key>  
<Certificate>  
<Encoding> **_cert en Base 64_** </Encoding>  
</Certificate>  
</Binding>

  

**IMPORTANT**: Per obtenir el X509Name fer servir el següent codi:

System.out.println(psis.common.utils.X500NameUtils.serialize(cert.getSubjectX500Principal(), Format.RFC2253, true));

Eliminar de l'string anterior tots els "\\00". Sinó no funciona bé la càrrega de la clau.

**BindingDataLoaderConfig.xml**

Actualitzar-lo per a que apunti a l'arxiu anterior.

### **3.2.- Aixecar un node en mode IOP, i des de la consola, carregar la clau corresponent**.

### **3.3.- Reiniciar el servei en mode normal.**

  

### **3.4.- Actualitzar el DN del nou CDA a tots els fitxers de configuració que en fan referència, i carregar configuració des de la consola web:**

**Cfg-ValidationAuthority-v38-CatcertTest-xxxxxxxx.xml**

**Cfg-MessageBroker-v4-CatcertTest-xxxxxxxx.xml**

**Cfg-PDFLite-v2-CatcertTest-xxxxxxxx.xml**

**Cfg-GatewayVA-v2-CatcertTest-xxxxxxxx.xml**

  

### **3.5.- Reiniciar el servei de nou en mode normal.**

**NOTA**: En cas de problemas durant la càrrega, lo més ràpid és eliminar totes les claus ([Script per esborrar les taules de claus criptogràfiques](24215706.md)), i tornar a carregar-ho tot des de la consola java.

En cas de problemes durant la càrrega, fer servir les taules de backup creades al punt "0".

\-- DISABLE CONSTRAINTS
ALTER TABLE D\_IM\_ATL\_ATTRIBUTES DISABLE CONSTRAINT FK2022B01DE91F9321;
ALTER TABLE D\_IM\_ATL\_ATTRIBUTE\_VALUE DISABLE CONSTRAINT FK44DC9AC83A525BFF;
ALTER TABLE D\_IM\_ATL\_ATTRIBUTE\_METADATA DISABLE CONSTRAINT FKBD3BE258DABFD873;
ALTER TABLE D\_IM\_ATL\_ATTRIBUTE\_METADATA DISABLE CONSTRAINT FKBD3BE2583A525BFF;
ALTER TABLE D\_KM\_ATL\_KEY\_USAGES DISABLE CONSTRAINT FK68C9A7BAE73825CC;
ALTER TABLE D\_KM\_ATL\_KEY\_PAIRS DISABLE CONSTRAINT FK7EF1CAF1FB594BB9;
ALTER TABLE D\_KM\_ATL\_KEY\_PAIRS DISABLE CONSTRAINT FK7EF1CAF1FDAA1661;
ALTER TABLE D\_KM\_ATL\_KEY\_PAIRS DISABLE CONSTRAINT FK7EF1CAF12AD9EFEC;
ALTER TABLE D\_KM\_ATL\_KEY\_ATTRIBUTES DISABLE CONSTRAINT FK98096E1FE73825CC;
ALTER TABLE D\_KM\_ATL\_SECRET\_KEYS DISABLE CONSTRAINT FK839CC5BE07BF35A;
ALTER TABLE D\_KM\_ATL\_PRIVATE\_KEYS DISABLE CONSTRAINT FKB78BD818E07BF35A;
ALTER TABLE D\_KM\_ATL\_PUBLIC\_KEYS DISABLE CONSTRAINT FK412DD442E07BF35A;
ALTER TABLE D\_KM\_ATL\_SIMPLE\_KEYS DISABLE CONSTRAINT FK2CFC7A992AD9EFEC;
ALTER TABLE AUTHZ\_KEY\_USAGE DISABLE CONSTRAINT FKB6AF8334AFDF30C8;
ALTER TABLE AUTHZ\_KEY\_USAGE DISABLE CONSTRAINT FKB6AF833499A34D65;
ALTER TABLE AUTHZ\_ARCHIVE\_USAGE DISABLE CONSTRAINT FK96BD25D799A34D65;
ALTER TABLE D\_BM\_ATL\_BINDING\_STATES DISABLE CONSTRAINT FK8B1F8A5BF0AA95F6;
ALTER TABLE D\_BM\_ATL\_BINDING\_USAGES DISABLE CONSTRAINT FK8E7AF34BF0AA95F6;
ALTER TABLE D\_BM\_ATL\_KEY\_APPLICATIONS DISABLE CONSTRAINT FK941BF0A2F0AA95F6;
--TRUNCATE
TRUNCATE TABLE AUTHZ\_ARCHIVE\_USAGE;
TRUNCATE TABLE AUTHZ\_KEY\_USAGE;
TRUNCATE TABLE D\_IM\_ATL\_METADATA;
TRUNCATE TABLE D\_IM\_ATL\_METADATA\_VALUES;
TRUNCATE TABLE D\_KM\_ATL\_KEY\_ATTRIBUTES;
TRUNCATE TABLE D\_KM\_ATL\_KEY\_PAIRS;
TRUNCATE TABLE D\_KM\_ATL\_KEY\_USAGES;
TRUNCATE TABLE D\_KM\_ATL\_SECRET\_KEYS;
TRUNCATE TABLE D\_KSDB\_ATL\_KEYENTRIES;
TRUNCATE TABLE D\_BM\_ATL\_BINDING\_STATES;
TRUNCATE TABLE D\_BM\_ATL\_BINDING\_USAGES;
TRUNCATE TABLE D\_BM\_ATL\_KEY\_APPLICATIONS;
TRUNCATE TABLE D\_CS\_ATL\_CERTIFICATE\_ENTRIES;
TRUNCATE TABLE D\_IM\_ATL\_ATTRIBUTE\_METADATA;
TRUNCATE TABLE D\_IM\_ATL\_ATTRIBUTE\_VALUE;
TRUNCATE TABLE D\_IM\_ATL\_ATTRIBUTES;
TRUNCATE TABLE D\_KM\_ATL\_PRIVATE\_KEYS;
TRUNCATE TABLE D\_KM\_ATL\_PUBLIC\_KEYS;
TRUNCATE TABLE D\_KM\_ATL\_KEYS;
TRUNCATE TABLE D\_KM\_ATL\_SIMPLE\_KEYS;
TRUNCATE TABLE D\_IM\_ATL\_ENTITY;
TRUNCATE TABLE D\_BM\_ATL\_BINDINGS;
-- COPY DATA
INSERT INTO AUTHZ\_ARCHIVE\_USAGE (SELECT \* FROM B\_AUTHZ\_ARCHIVE\_USAGE);
INSERT INTO AUTHZ\_KEY\_USAGE (SELECT \* FROM B\_AUTHZ\_KEY\_USAGE);
INSERT INTO D\_IM\_ATL\_METADATA (SELECT \* FROM B\_D\_IM\_ATL\_METADATA);
INSERT INTO D\_IM\_ATL\_METADATA\_VALUES (SELECT \* FROM B\_D\_IM\_ATL\_METADATA\_VALUES);
INSERT INTO D\_KM\_ATL\_KEY\_ATTRIBUTES (SELECT \* FROM B\_D\_KM\_ATL\_KEY\_ATTRIBUTES);
INSERT INTO D\_KM\_ATL\_KEY\_PAIRS (SELECT \* FROM B\_D\_KM\_ATL\_KEY\_PAIRS);
INSERT INTO D\_KM\_ATL\_KEY\_USAGES (SELECT \* FROM B\_D\_KM\_ATL\_KEY\_USAGES);
INSERT INTO D\_KM\_ATL\_SECRET\_KEYS (SELECT \* FROM B\_D\_KM\_ATL\_SECRET\_KEYS);
INSERT INTO D\_KSDB\_ATL\_KEYENTRIES (SELECT \* FROM B\_D\_KSDB\_ATL\_KEYENTRIES);
INSERT INTO D\_BM\_ATL\_KEY\_APPLICATIONS (SELECT \* FROM B\_D\_BM\_ATL\_KEY\_APPLICATIONS);
INSERT INTO D\_BM\_ATL\_BINDING\_STATES (SELECT \* FROM B\_D\_BM\_ATL\_BINDING\_STATES);
INSERT INTO D\_BM\_ATL\_BINDING\_USAGES (SELECT \* FROM B\_D\_BM\_ATL\_BINDING\_USAGES);
INSERT INTO D\_CS\_ATL\_CERTIFICATE\_ENTRIES (SELECT \* FROM B\_D\_CS\_ATL\_CERTIFICATE\_ENTRIES);
INSERT INTO D\_IM\_ATL\_ATTRIBUTE\_METADATA (SELECT \* FROM B\_D\_IM\_ATL\_ATTRIBUTE\_METADATA);
INSERT INTO D\_IM\_ATL\_ATTRIBUTE\_VALUE (SELECT \* FROM B\_D\_IM\_ATL\_ATTRIBUTE\_VALUE);
INSERT INTO D\_IM\_ATL\_ATTRIBUTES (SELECT \* FROM B\_D\_IM\_ATL\_ATTRIBUTES);
INSERT INTO D\_KM\_ATL\_PRIVATE\_KEYS (SELECT \* FROM B\_D\_KM\_ATL\_PRIVATE\_KEYS);
INSERT INTO D\_KM\_ATL\_PUBLIC\_KEYS (SELECT \* FROM B\_D\_KM\_ATL\_PUBLIC\_KEYS);
INSERT INTO D\_KM\_ATL\_KEYS (SELECT \* FROM B\_D\_KM\_ATL\_KEYS);
INSERT INTO D\_KM\_ATL\_SIMPLE\_KEYS (SELECT \* FROM B\_D\_KM\_ATL\_SIMPLE\_KEYS);
INSERT INTO D\_IM\_ATL\_ENTITY (SELECT \* FROM B\_D\_IM\_ATL\_ENTITY);
INSERT INTO D\_BM\_ATL\_BINDINGS (SELECT \* FROM B\_D\_BM\_ATL\_BINDINGS);
COMMIT;
-- ENABLE CONSTRAINTS
ALTER TABLE D\_IM\_ATL\_ATTRIBUTES ENABLE CONSTRAINT FK2022B01DE91F9321;
ALTER TABLE D\_IM\_ATL\_ATTRIBUTE\_VALUE ENABLE CONSTRAINT FK44DC9AC83A525BFF;
ALTER TABLE D\_IM\_ATL\_ATTRIBUTE\_METADATA ENABLE CONSTRAINT FKBD3BE258DABFD873;
ALTER TABLE D\_IM\_ATL\_ATTRIBUTE\_METADATA ENABLE CONSTRAINT FKBD3BE2583A525BFF;
ALTER TABLE D\_KM\_ATL\_KEY\_USAGES ENABLE CONSTRAINT FK68C9A7BAE73825CC;
ALTER TABLE D\_KM\_ATL\_KEY\_PAIRS ENABLE CONSTRAINT FK7EF1CAF1FB594BB9;
ALTER TABLE D\_KM\_ATL\_KEY\_PAIRS ENABLE CONSTRAINT FK7EF1CAF1FDAA1661;
ALTER TABLE D\_KM\_ATL\_KEY\_PAIRS ENABLE CONSTRAINT FK7EF1CAF12AD9EFEC;
ALTER TABLE D\_KM\_ATL\_KEY\_ATTRIBUTES ENABLE CONSTRAINT FK98096E1FE73825CC;
ALTER TABLE D\_KM\_ATL\_SECRET\_KEYS ENABLE CONSTRAINT FK839CC5BE07BF35A;
ALTER TABLE D\_KM\_ATL\_PRIVATE\_KEYS ENABLE CONSTRAINT FKB78BD818E07BF35A;
ALTER TABLE D\_KM\_ATL\_PUBLIC\_KEYS ENABLE CONSTRAINT FK412DD442E07BF35A;
ALTER TABLE D\_KM\_ATL\_SIMPLE\_KEYS ENABLE CONSTRAINT FK2CFC7A992AD9EFEC;
ALTER TABLE AUTHZ\_KEY\_USAGE ENABLE CONSTRAINT FKB6AF8334AFDF30C8;
ALTER TABLE AUTHZ\_KEY\_USAGE ENABLE CONSTRAINT FKB6AF833499A34D65;
ALTER TABLE AUTHZ\_ARCHIVE\_USAGE ENABLE CONSTRAINT FK96BD25D799A34D65;
ALTER TABLE D\_BM\_ATL\_BINDING\_STATES ENABLE CONSTRAINT FK8B1F8A5BF0AA95F6;
ALTER TABLE D\_BM\_ATL\_BINDING\_USAGES ENABLE CONSTRAINT FK8E7AF34BF0AA95F6;
ALTER TABLE D\_BM\_ATL\_KEY\_APPLICATIONS ENABLE CONSTRAINT FK941BF0A2F0AA95F6;

  

  

  

Document generated by Confluence on 07 junio 2025 00:00

[Atlassian](http://www.atlassian.com/)