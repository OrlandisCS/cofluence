Suport Tècnic : PCI - ALTRES - Analitzar l'estat de les peticions  

1.  [Suport Tècnic](index.md)
2.  [Suport Tècnic](13893782.md)
3.  [02 - FAQ's serveis](26313393.md)
4.  [FAQ's PCI](28705599.md)

Suport Tècnic : PCI - ALTRES - Analitzar l'estat de les peticions
=================================================================

Created by Unknown User (obernalp), last modified by Unknown User (otecobernal) on 05 December 2019

Per analitzar l'estat de la PCI30 podrem fer diverses consultes:

Analitzar peticions en estat d'error (últimes 24 hores):

select TO\_CHAR(Data\_Recepcio, 'DD/MM') "DIA/MES", TO\_CHAR(Data\_Recepcio, 'HH24') "HORA", codi\_producte, count(\*) "PETICIONS ERRÒNIES"
     from PCI\_MTI\_PETICIO aa
    where aa.estat = 4
  and aa.Data\_Recepcio > sysdate -1
     GROUP BY TO\_CHAR(Data\_Recepcio, 'HH24'), TO\_CHAR(Data\_Recepcio, 'DD/MM'), codi\_producte
     ORDER BY TO\_CHAR(Data\_Recepcio, 'DD/MM'), TO\_CHAR(Data\_Recepcio, 'HH24');
   

També podem marcar el que ens interessi fer facilitar o ressaltar informació, per exemple:  
![](attachments/26313416/26315009.png)

Analitzar les peticions que es troben reiniciant-se:

select TO\_CHAR(Data\_Recepcio, 'DD/MM') "DIA/MES", TO\_CHAR(Data\_Recepcio, 'HH24') "HORA", codi\_producte, count(\*) "PETICIONS ERRÒNIES"
     from PCI\_MTI\_PETICIO aa
   where (aa.estat = -1 or aa.estat = 2)
     GROUP BY TO\_CHAR(Data\_Recepcio, 'HH24'), TO\_CHAR(Data\_Recepcio, 'DD/MM'), codi\_producte
     ORDER BY TO\_CHAR(Data\_Recepcio, 'DD/MM'), TO\_CHAR(Data\_Recepcio, 'HH24');
   

També podem fer una extracció en funció dels dies o dels productes per separat:

\-- PER DIA
  select TO\_CHAR(Data\_Recepcio, 'DD/MM') "DIA", count(\*) "PETICIONS"
     from PCI\_MTI\_PETICIO aa
     where (aa.estat = -1 or aa.estat = 2)
     GROUP BY TO\_CHAR(Data\_Recepcio, 'DD/MM')  ORDER BY 1;
   
-- PER PRODUCTE
  select codi\_producte, count(\*) "PETICIONS"
     from PCI\_MTI\_PETICIO aa
     where (aa.estat = -1 or aa.estat = 2)
     group by codi\_producte;

Buscar peticions per LOTS amb possibles problemes:

\-- PETICIONS AMB MÉS D'UNA SOL- LICITUD
 select pet.data\_recepcio, pet.codi\_ens, pet.id\_peticio, count(\*) "Solicituds"
  FROM PCI\_MTI\_SOLICITUD sol, PCI\_MTI\_PETICIO pet
 where sol.ID\_PETICIO = pet.id
-- and pet.codi\_producte = 'PADRO'
 --  and sol.MODALITAT\_CONSUM = 'TITULAR'
   --and pet.codi\_ens = '812130008'
 group by pet.data\_recepcio, pet.codi\_ens, pet.id\_peticio
having count(\*) > 1
 order by pet.data\_recepcio desc

Analitzar els estats:

 -- ESTATS DE LES SOLICITUDS
 select pet.estat,
 (case
         when pet.estat = '0' then          'Pendent'
         when pet.estat = '1' then          'Iniciada'
         when pet.estat = '2' then          'Executada'
         when pet.estat = '3' then          'Finalitzada'
         when pet.estat = '4' then          'Finalitzada amb errors'
         when pet.estat = '5' then          'Executada pendent de resposta (diferida)'
         else                               'Estat desconegut'
  end) as "ESTAT PETICIO",
  sol.estat,
  (case
         when sol.estat = '0' then          'Pendent'
         when sol.estat = '1' then          'Iniciada'
         when sol.estat = '2' then          'Executada'
         when sol.estat = '3' then          'Finalitzada'
         when sol.estat = '4' then          'Finalitzada amb errors'
         when sol.estat = '5' then          'Executada pendent de resposta (diferida)'
         else                               'Estat desconegut'
   end) as "ESTAT\_SOLICITUD"
  FROM PCI\_MTI\_SOLICITUD sol, PCI\_MTI\_PETICIO pet
 where sol.ID\_PETICIO = pet.id
  and pet.id\_peticio = 'RGM\_P\_100001320'

En cas de necessitar reiniciar alguna sol·licitud podem consultar [PCI - ALTRES - Reiniciar peticions - Només asíncron](26313413.md)

Analitzar el percentatge de peticions errònies per producte:

  -- PER PRODUCTE
 select TOTALS.codi\_producte, TOTALS.PETICIONS "TOTALS", ERRONIES.PETICIONS "ERRÒNIES", 
 CONCAT(ROUND(100\*ERRONIES.PETICIONS/TOTALS.PETICIONS, 2),'%') "PERCENTATGE D'ERROR"  from 
     (select codi\_producte, count(\*) "PETICIONS"
         from PCI\_MTI\_PETICIO aa
         where aa.estat = 4
         and aa.Data\_Recepcio > sysdate -1
         group by codi\_producte 
     ) "ERRONIES", 
     (select codi\_producte, count(\*) "PETICIONS"
         from PCI\_MTI\_PETICIO aa
         where aa.estat != 4
         and aa.Data\_Recepcio > sysdate -1
         group by codi\_producte 
     ) "TOTALS"
   where TOTALS.codi\_producte = ERRONIES.codi\_producte
   --and 100\*ERRONIES.PETICIONS/TOTALS.PETICIONS > 20
        order by ERRONIES.PETICIONS/TOTALS.PETICIONS desc

![](attachments/26313416/26315217.png)

Analitzar el percentatge de peticions realitzades per ens:

A la següent consulta només es té en compte les últimes 24 hores.

A més a més, es conten les sol·licituds, no les peticions, per tenir en compte els consums massius (LOTS).

 -- PER ENS
select ENS.UEN\_NOM\_CURT "NOM",
       PETICIONS\_ENS.codi\_ens "CODI\_ENS",
       PETICIONS\_ENS.NUM\_PETICIONS "SOL·LICITUDS REALITZADES",
       CONCAT(ROUND(100 \* PETICIONS\_ENS.NUM\_PETICIONS / PETICIONS\_TOTALS.NUM\_PETICIONS, 2), '%') "PERCENTATGE DE CONSUM"
  from (select codi\_ens, count(\*) "NUM\_PETICIONS"
          FROM PCI\_MTI\_SOLICITUD sol, PCI\_MTI\_PETICIO pet
         where sol.ID\_PETICIO = pet.id
           and pet.Data\_Recepcio > sysdate - 15
         group by pet.codi\_ens) "PETICIONS\_ENS",
       (select sum(count(pet.codi\_ens)) "NUM\_PETICIONS"
          FROM PCI\_MTI\_SOLICITUD sol, PCI\_MTI\_PETICIO pet
         where sol.ID\_PETICIO = pet.id
           and pet.Data\_Recepcio > sysdate - 15
         group by pet.codi\_ens) "PETICIONS\_TOTALS",
         usu\_ens ENS
 WHERE TO\_CHAR(ENS.uen\_codi\_ens) = TO\_CHAR(PETICIONS\_ENS.codi\_ens)
-- AND 100 \* PETICIONS\_ENS.NUM\_PETICIONS / PETICIONS\_TOTALS.NUM\_PETICIONS > 10
 order by PETICIONS\_ENS.NUM\_PETICIONS / PETICIONS\_TOTALS.NUM\_PETICIONS desc

  
![](attachments/26313416/26315219.png)  
  

Analitzar el temps de procés de les peticions:

La següent consulta mostra els temps de resposta (en segons) de les peticions del MUX:

 SELECT id\_peticio,
       (EXTRACT(DAY FROM interval\_value) \* 24 \* 60 \* 60) +
       (EXTRACT(HOUR FROM interval\_value) \* 60 \* 60) +
       (EXTRACT(MINUTE FROM interval\_value) \* 60) +
       EXTRACT(SECOND FROM interval\_value) AS interval\_in\_sec
  FROM (SELECT data\_fi - data\_recepcio AS interval\_value, id\_peticio
          from PCI\_MTI\_PETICIO pet
         where pet.codi\_producte = 'MUX')

La següent consulta mostra el nombre de peticions per cada temps de resposta (arrodonint els decimals) de les peticions de l'NT-LITE:

 select interval\_in\_sec "Temps de resposta (seg)", count(\*) "Número peticions" from
(
  SELECT id\_peticio,
         round((EXTRACT(DAY FROM interval\_value) \* 24 \* 60 \* 60) +
         (EXTRACT(HOUR FROM interval\_value) \* 60 \* 60) +
         (EXTRACT(MINUTE FROM interval\_value) \* 60) +
         EXTRACT(SECOND FROM interval\_value)) AS interval\_in\_sec
      FROM (SELECT data\_fi - data\_recepcio AS interval\_value, id\_peticio
          from PCI\_MTI\_PETICIO pet
           where pet.codi\_producte = 'NT-LITE'
          and data\_recepcio >= to\_date('09/04/2019 10:00', 'dd/mm/yyyy HH24:mi')
          and data\_recepcio <= to\_date('09/04/2019 11:00', 'dd/mm/yyyy HH24:mi')
          )
 )indxa
 group by indxa.interval\_in\_sec
 order by indxa.interval\_in\_sec desc

Analitzar els XMLs (Evidències o peticions/respostes)

Amb la següent consulta podem veure tots els XML's associats a una petició

  select \* from PCI\_MTI\_XML
 where id\_peticio in (
  select id from PCI\_MTI\_PETICIO
  where id\_peticio = '9821920002\_PADRO\_2812984'
 )

Taula de traducció dels estats:

Estat

Petició

Sol·licitud

**XML**

\-1

En procés del BEA

En procés del BEA

\-

0

Pendent

Pendent

Petició

1

Executada

Executada

Sol·licitud

2

Finalitzada

Finalitzada

Evidència Petició

3

Finalitzada amb errors

Finalitzada amb errors

Evidència Resposta

4

\-

\-

Resposta Sol·licitud

5

\-

\-

Resposta

TO BE CONTINUED

  

  

Attachments:
------------

![](images/icons/bullet_blue.gif) [image2018-11-20\_17-33-44.png](attachments/26313416/26315009.png) (image/png)  
![](images/icons/bullet_blue.gif) [image2019-1-8\_8-23-21.png](attachments/26313416/26315217.png) (image/png)  
![](images/icons/bullet_blue.gif) [image2019-1-8\_8-24-57.png](attachments/26313416/26315219.png) (image/png)  

Document generated by Confluence on 02 June 2025 10:57

[Atlassian](http://www.atlassian.com/)