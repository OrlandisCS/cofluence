Suport Tècnic : Groovy Fase 1 -> Creació de ticket a JIRA  

1.  [Suport Tècnic](index.html)
2.  [Suport Tècnic](13893782.html)
3.  [04 - Tècnica de sistemes + 24x7 + Padró](26313202.html)
4.  [Desplegaments](Desplegaments_26313538.html)
5.  [Documentació associada a la integració de Jenkins i Jira](22937719.html)

Suport Tècnic : Groovy Fase 1 -> Creació de ticket a JIRA
=========================================================

Created by David Tejada, last modified on 12 September 2019

  

package jira.jenkins.aoc

import groovy.json.JsonSlurper
import java.util.Date



def f  = new File("./conf\_var/pre/jira.json")
def jsonDades = new JsonSlurper()
def jsonD = jsonDades.parseText(f.getText())

def entorn = jsonD.entorn
def plataforma = jsonD.plataforma
def codiServei = jsonD.codiServei
def codiSubservei = jsonD.codiSubservei
def prioryMinor = 4
def taskIssueType = jsonD.taskIssueType // IssueType Desplegament
def projectId = jsonD.projectId
def authString = "jenkins:jenkins\_aoc".bytes.encodeBase64().toString() 
def authStringStash = "projectes:3veqeVOY".bytes.encodeBase64().toString()
def servei = jsonD.servei
def subServei = jsonD.subServei

def projecteStash = jsonD.projecteStash
def repositoriStash = jsonD.repositoriStash

def titolTicket = jsonD.titol

def observadors = jsonD.observadors


def createIssue = "https://contacte.aoc.cat/rest/api/2/issue"
def urlStash = "http://192.168.166.69:7990/rest/api/1.0/projects/${projecteStash}/repos/${repositoriStash}/commits"



// Ja disposem de totes les variables necessàries

// Definim totes les funcions necessàries.

/\*\*
 \* 
 \* Crida genèrica per realitzar un post, li hem de passar la url i el json associat amb la informació necessària
 \* 
 \*/

def post={ String url, String postContent ->
	
	def connection = url.toURL().openConnection()
	connection.addRequestProperty("Authorization", "Basic ${authString}")
	connection.addRequestProperty("Content-Type", "application/json; charset=UTF-8")


	connection.setRequestMethod("POST")
	connection.doOutput = true

	connection.outputStream.withWriter('UTF-8',{
		it.write(postContent)
		it.flush()
	})

	connection.connect()

	try {
		connection.content.text
	} catch (IOException e) {
		try {
			((HttpURLConnection)connection).errorStream.text
		} catch (Exception ignored) {
			throw e
		}
	}
}

/\*\*
 \* 
 \* Crida genèrica per obtenir un get d'una petició. Obtindrem com a resposta un json que s'haurà de tractar.
 \* 
 \* 
 \*/

	def get={String url->
		
	def connection = url.toURL().openConnection()
	connection.addRequestProperty("Authorization", "Basic ${authString}")

	connection.setRequestMethod("GET")
	connection.doOutput = false
	connection.connect()
	connection.content.text
}

/\*\*
 \* Mètode per realitzar el get al stash
 \*/

def getStash={String url->
	
def connection = url.toURL().openConnection()
connection.addRequestProperty("Authorization", "Basic ${authStringStash}")

connection.setRequestMethod("GET")
connection.doOutput = false
connection.connect()
connection.content.text
}

/\*\*
 \* 
 \* Definició que realitza el json necessari per fer una petició de cerca
 \* 
 \*/

def obtenirTicket={String jsonTicket ->
	
	 def jsonS = new JsonSlurper()
	 def json = jsonS.parseText(jsonTicket)
//     println(resultat)

	def titol= json.key
	def String value = new String(titol.getBytes(), "UTF-8")

	return value	

}

def cercarPeticioContent = { ->
	
	def jsonComentari = """
			{
         	"jql": "issuetype = Desplegament AND Entorn = ${entorn} AND status in ('open','in progress') AND Servei in cascadeOption(${codiServei}, ${codiSubservei}) and plataforma = '${plataforma}' ",
			"fields": \["key","status"\]
			
        	}
		"""
	println jsonComentari
	return jsonComentari
	
}

/\*\*
 \* 
 \* Mètode que implementa la cerca i tracta la sortida, ens hauria de retornar un ticket o cap.
 \* 
 \* 
 \*/

def cercarPeticio={ ->	
	
	def jsonResposta = post("https://contacte.aoc.cat/rest/api/2/search",cercarPeticioContent())
	def jS = new JsonSlurper()
	def j = jS.parseText(jsonResposta)
	println(jsonResposta)
	def ticket = j.issues.key
	def status = j.issues.fields.status.name
				
	
	if(ticket.size() >0) {
		println(ticket\[0\])
		println(status)
		return ticket\[0\]
	}
	else {
		println("No hi ha tickets creats")
	}
	
}

/\*\*
 \* 
 \* Mètode que vincula 2 tickets
 \* 
 \*/

def relacionarTickets= {String idTicket1, String idTicket2 ->
	
	def jsonLlamada= """
			{
			  "outwardIssue": {
			    "key": "$idTicket1"
			  },
			  
			  "inwardIssue": {
			    "key": "$idTicket2"
			  },
			  "type": {
			    "name": "Relacionar"
			  }
			}
			"""
	def url = "https://contacte.aoc.cat/rest/api/2/issueLink"
	
	println(post(url,jsonLlamada))
	
}

/\*\*
 \*
 \* Mètode que treu els tickets relacionats del commit del git.
 \*
 \*/

def tractarResum={String resum, String ticketPare->
	
	int index = 0
	def ticket = ""
	while (index > -1) {
		index = resum.indexOf("PRJ",index)
		if (index < 0) {
			// No caldrà fer res
		}else {
          	def indexEspai = resum.indexOf(" ", index)
          if (indexEspai > index ) {
            
			ticket= resum.substring(index,resum.indexOf(" ", index))
			println(ticket)
			relacionarTickets(ticketPare,ticket)
          }
			index = index+1
		}
		
	}
	index =0
	
	while (index > -1) {
		index = resum.indexOf("ST",index)
		if (index < 0) {
			// No caldrà fer res
		}else {
          	def indexEspai = resum.indexOf(" ", index)
          if (indexEspai > index ) {
            
			ticket= resum.substring(index,resum.indexOf(" ", index))
			println(ticket)
			relacionarTickets(ticketPare,ticket)
          }
			index = index+1
		}
		
	}
	index =0
	while (index > -1) {
		index = resum.indexOf("DES",index)
		if (index < 0) {
			// No caldrà fer res
		}else {
          	def indexEspai = resum.indexOf(" ", index)
          if (indexEspai > index ) {
            
			ticket= resum.substring(index,resum.indexOf(" ", index))
			println(ticket)
			relacionarTickets(ticketPare,ticket)
          }
			index = index+1
		}
		
	}
	index =0
	while (index > -1) {
		index = resum.indexOf("SE",index)
		if (index < 0) {
			// No caldrà fer res
		}else {
          	def indexEspai = resum.indexOf(" ", index)
          if (indexEspai > index ) {
            
			ticket= resum.substring(index,resum.indexOf(" ", index))
			println(ticket)
			relacionarTickets(ticketPare,ticket)
          }
			index = index+1
		}
		
	}
	
	
}

def obtenirResum = {String idCommit->	
	
	
	
	def dades = (String) getStash(urlStash)
	
	def jsonStash = new JsonSlurper()
	
	def jsonStashD = jsonStash.parseText(dades)
	
	
	def commitsAuthor = jsonStashD.values.author.name
	
	def commitsId = jsonStashD.values.id
	
	def commitsMessage = jsonStashD.values.message
	
	def continuar = true
	def index = 0
	def resum =""
	
	while (continuar) {
		
		if (commitsId\[index\] != idCommit ) {
			
			resum = resum + commitsAuthor\[index\]+": "+ commitsMessage\[index\].replaceAll("\\\\n","").replaceAll("\\"","")+"\\\\n"
			
		}else {
			
			continuar=false
		}
		
		index=index+1
		if (index>10) {
			continuar=false
		}
		
	}
  	println "\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*"
  
  	println resum
  
    println "\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*"
	
	return resum
	
	
	
}
/\*\*
 \* 
 \* Mètode que construeix el contingut json per fer la creació del ticket.
 \* 
 \*/


def createIssueContent={String resum ->		
		
	def dataDesplegament = new Date().format("yyyy-MM-dd")
	
	
	/\*
	
	Dades necessàries per crear una incidència de Desplegament.
		
	Entorn customfield\_10011 -> DEV, PRE, PRO
	
	DataDesplegament -> Al crear-ho automàticament, serà la mateixa data. -> customfield\_10013
	
	Resum desplegament (customfield\_10603) -> El que s'hagi informat en el GIT
	
	Rollback(customfield\_10606)-> Indicar sempre el text que el propi Jenkins realitza el rollback
	
	Validació (customfield\_10607) -> Indicar que el propi Jenkins realitza els testos unitaris i d'integració.
	
	Servei -> customfield\_10010
	
	Plataforma -> customfield\_10027
	
	Observadors -> customfield\_1003
		
	\*/
  
  	
	
	//summary = entorn +" "+ "Desplegament de " +servei + " - " + subServei
	description = "Desplegament realitzat a través de Jenkins de forma automàtica" 
		"""
            {
                "fields": {
                    "project": { "id": "10016" },
                    "summary": "${titolTicket}",
                    "issuetype": { "id": "10008" },
                    "priority": { "id": "${prioryMinor}" },
                    "description": "${description}",
                     "customfield\_10011": {"value": "${entorn}"},
                    "customfield\_10603":"$resum",                        
                    "customfield\_10606":"Aquest desplegament s'ha realitzat de forma automàtica, per tant el rollback es realitza automaticament en funció dels tests",
                    "customfield\_10607":"Aquest desplegament s'ha realitzat de forma automàtica, per tant ja inclou una serie de tests generals",
                    "labels":\["JENKINS", "DEPLOY"\],
                    "customfield\_10013":"$dataDesplegament",
                    "customfield\_10010":{"value" : "${servei}","child": {"value":"${subServei}"}},
                    "customfield\_10027":\[{"value":"${plataforma}"}\],
                    "customfield\_10034":${observadors}
                    
                    
                }
            }
        """
	}
	

	
	


/\*\*
 \* 
 \* Execució del codi que utilitzarem.
 \* 
 \*/
	
// Mirem si hi ha canvis al git i preparem el resum per si cal crear la petició

	/\* Codi en el jenkins 
	 \* 	
	 \*/
	

	def fileLastCommit = new File("lastCommit.txt")
	def idLastCommit = fileLastCommit.text
	
	println(fileLastCommit.text)
	
	def fileCommitActual = new File("commitActual.txt")

	println(fileCommitActual.text)

	if (fileLastCommit.text == fileCommitActual.text) {
			// Són iguals -> No haurem de fer res
			throw new Exception("No s'ha de fer res, no hi ha canvis recents.")
		}
	
	def resum = obtenirResum(idLastCommit)
	
	
// Primer farem una cerca per trobar si existeix algun ticket creat d'aquesta tipologia

def ticket = cercarPeticio()


if (ticket==null) {
	
	println("Iniciem la creació del ticket")
	def jsonOberturaTicket = post(createIssue, createIssueContent(resum))
	
	println(jsonOberturaTicket)
	   
	ticket = obtenirTicket(jsonOberturaTicket)
	
	def file = new File("variables.txt")
	file.text = ticket
	
	
}else {
	
	println(ticket)
	def file = new File("variables.txt")
	file.text = ticket
}



// Relacionem els tickets amb la informació del resum


	tractarResum(resum,ticket)

Document generated by Confluence on 02 June 2025 11:17

[Atlassian](http://www.atlassian.com/)