Suport Tècnic : PCI - ALTRES - Reiniciar peticions - Només asíncron  

1.  [Suport Tècnic](index.md)
2.  [Suport Tècnic](13893782.md)
3.  [02 - FAQ's serveis](26313393.md)
4.  [FAQ's PCI](28705599.md)

Suport Tècnic : PCI - ALTRES - Reiniciar peticions - Només asíncron
===================================================================

Created by Unknown User (obernalp), last modified by Unknown User (otecjriquelme) on 17 February 2022

Per reiniciar peticions a la PCI haurem d'executar els següents updates de forma ordenada:

Si ens adonem, en aquest procediment no estem reiniciant la petició sinó que estem reiniciant la sol·licitud que té adherida. En cas de voler reiniciar una petició de LOTS (més d'una sol·licitud) haurem d'executar l'script per cada sol·licitud que vulguem reiniciar.

  

Primer deixarem la sol·licitud en estat 0, que significa PENDENT:

UPDATE PCI30IOP.PCI\_MTI\_SOLICITUD
   SET ESTAT = 0
 WHERE ID\_PETICIO in (SELECT ID
                        FROM PCI30IOP.PCI\_MTI\_PETICIO
                       WHERE ID\_PETICIO = 'DCOC\_BCN\_809412');

  

Després deixarem la petició en estat 2, que significa EXECUTADA:

UPDATE PCI30IOP.PCI\_MTI\_PETICIO
   SET ESTAT = 2
WHERE ID\_PETICIO = 'DCOC\_BCN\_809412';

  

També haurem d'eliminar els XML de tipus 4 i 5 que fan referència a la RESPOSTA i a la RESPOSTA SOL·LICITUD:

DELETE FROM PCI30IOP.PCI\_MTI\_XML
WHERE TIPUS IN (4, 5)
   AND ID\_PETICIO IN
       (SELECT ID
          FROM PCI30IOP.PCI\_MTI\_PETICIO
         WHERE ID\_PETICIO ='DCOC\_BCN\_809412');

  

Finalment deixarem una traça als logs indicant que la petició ha sigut reiniciada:

INSERT INTO PCI30IOP.PCI\_MTI\_LOG
  (ID, DATA, ID\_PETICIO, ID\_SOLICITUD, TIPUS, MSG)
VALUES
  (SEQ\_PCI\_MTI\_ID.NEXTVAL,
   SYSDATE,
   (SELECT ID
      FROM PCI30IOP.PCI\_MTI\_PETICIO
     WHERE ID\_PETICIO = 'DCOC\_BCN\_807417'),
   (SELECT ID
      FROM PCI30IOP.PCI\_MTI\_SOLICITUD
     WHERE ID\_PETICIO in
           (SELECT ID
              FROM PCI30IOP.PCI\_MTI\_PETICIO
             WHERE ID\_PETICIO = 'DCOC\_BCN\_807417')),
   'INFO',
   'Sol- licitud reiniciada correctament');

  

Exemple de reinici 1
--------------------

Com a exemple, a vegades les peticions per LOTS es queden reiniciant-se. Com és el cas de  812130008\_AEAT\_DADES\_4842753 i 812130008\_SCSP\_TGSS\_4842749 (FP#246395).

Per trobar les peticions de LOTS que fa un ENS podem ajudar-nos de la següent consulta:

\-- PETICIONS PER LOTS D'UN ENS
 select pet.estat, pet.data\_recepcio, pet.codi\_ens, pet.id\_peticio, count(\*) "Solicituds"
  FROM PCI\_MTI\_SOLICITUD sol, PCI\_MTI\_PETICIO pet
 where sol.ID\_PETICIO = pet.id
and pet.codi\_ens = '812130008'
 group by pet.estat, pet.data\_recepcio, pet.codi\_ens, pet.id\_peticio
having count(\*) > 1
 order by pet.data\_recepcio desc

  

Un cop trobem les que no han finalitzat (solen estar en estat 2), podem analitzar l'estat de les seves sol·licituds. Segurament hi haurà sol·licituds en estat -1 que s'hauran quedat bloquejades en algun procés de les nostres plataformes. Podem fer un update del seu estat a 0 perquè es tornin a processar:

\-- REINICIAR SOL- LICITUDS ENGANXADES
 UPDATE PCI30IOP.PCI\_MTI\_SOLICITUD
   SET ESTAT = 0
 WHERE ID\_PETICIO in
       (SELECT ID
          FROM PCI30IOP.PCI\_MTI\_PETICIO
         WHERE ID\_PETICIO = '812130008\_SCSP\_TGSS\_4842749')
   AND ESTAT = -1;

  

Exemple de reinici 2
--------------------

En aquest cas, l'Ajuntament de Barcelona ens obre incidències perquè té peticions a l'entorn de PRE que mai acaben (FP#245542).

Busquem aquelles peticions i veiem que en aquest cas es troben en estat 0 i no en estat 2:

\-- PETICIONS PER LOTS D'UN ENS
 select pet.estat, pet.data\_recepcio, pet.codi\_ens, pet.id\_peticio, count(\*) "Solicituds"
  FROM PCI\_MTI\_SOLICITUD sol, PCI\_MTI\_PETICIO pet
 where sol.ID\_PETICIO = pet.id
and pet.codi\_ens = '812130008'
 group by pet.estat, pet.data\_recepcio, pet.codi\_ens, pet.id\_peticio
having count(\*) > 1
 order by pet.data\_recepcio desc

  
Revisant totes les sol·licituds veiem que no hi ha cap que es trobi en estat -1 i sembli que s'hagi quedat enganxada. En canvi, en aquest cas, totes les sol·licituds es troben en estat 0:

![](attachments/26313413/26315307.png)

En aquest cas el que hem de fer és fer un update de l'estat de la petició i posar-lo a 2, perquè torni a processar-se tot:

\-- CANVIEM L'ESTAT DE LA PETICIÓ
 UPDATE PCI30IOP.PCI\_MTI\_PETICIO
   SET ESTAT = 2
WHERE ID\_PETICIO = 'RGM\_P\_100001319';

-- REVISEM QUE LA PETICIÓ ES PROCESSI CORRECTAMENT
select \* from PCI30IOP.PCI\_MTI\_PETICIO WHERE ID\_PETICIO = 'RGM\_P\_100001319';

Attachments:
------------

![](images/icons/bullet_blue.gif) [image2018-11-21\_9-45-20.png](attachments/26313413/26315307.png) (image/png)  

Document generated by Confluence on 02 June 2025 10:57

[Atlassian](http://www.atlassian.com/)